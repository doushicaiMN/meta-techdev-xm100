<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>ubxfwupdate: updateCore.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="u-blox_logo_09.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ubxfwupdate
   &#160;<span id="projectnumber">21.05</span>
   </div>
   <div id="projectbrief">Firmware Update Tool Documentation &mdash; Copyright (c) 2015 u-blox AG.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('update_core_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">updateCore.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Handle the update on the receiver.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
<code>#include &quot;<a class="el" href="update_core_8h_source.html">updateCore.h</a>&quot;</code><br />
</div>
<p><a href="update_core_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a9ec6c85cab067c9beeadbc0119e05211"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd)</td></tr>
<tr class="separator:a9ec6c85cab067c9beeadbc0119e05211"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a44471cd7b81bbd4002b58c1b4bcddf1d"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#a44471cd7b81bbd4002b58c1b4bcddf1d">updSendWrite</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd, <a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> Packet)</td></tr>
<tr class="separator:a44471cd7b81bbd4002b58c1b4bcddf1d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadfd35bbc222f233164d22a25efb6fa2"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd, <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> force)</td></tr>
<tr class="separator:aadfd35bbc222f233164d22a25efb6fa2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae78c9293d678ee3e6a3d297800f579ed"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#ae78c9293d678ee3e6a3d297800f579ed">updProcessMessages</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd)</td></tr>
<tr class="separator:ae78c9293d678ee3e6a3d297800f579ed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac873b58a11add9d97c598e7ec876c401"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#ac873b58a11add9d97c598e7ec876c401">updEraseSector</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd)</td></tr>
<tr class="separator:ac873b58a11add9d97c598e7ec876c401"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4b205985db984dfcd40cf465d760cf75"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#a4b205985db984dfcd40cf465d760cf75">updWritePacket</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd)</td></tr>
<tr class="separator:a4b205985db984dfcd40cf465d760cf75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67c60123bde16f3fdf5a6e04c970bfce"><td class="memItemLeft" align="right" valign="top"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#a67c60123bde16f3fdf5a6e04c970bfce">updInit</a> (<a class="el" href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a> *rx, <a class="el" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numberSectors, <a class="el" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numberPackets, <a class="el" href="flash_8h.html#af4b45687636458b5af7637bc97293f4d">BLOCK_ARR_t</a> *flashOrg, <a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> flashSize, <a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> MaxPendingWritesNum, <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> eraseInProgres)</td></tr>
<tr class="separator:a67c60123bde16f3fdf5a6e04c970bfce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5b75de599f50c2489681e0ffc8432230"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#a5b75de599f50c2489681e0ffc8432230">updDeinit</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd)</td></tr>
<tr class="separator:a5b75de599f50c2489681e0ffc8432230"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c065d6b9a1ae76e08bde0a84ee898e7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="update_core_8c.html#a4c065d6b9a1ae76e08bde0a84ee898e7">updUpdate</a> (<a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd, <a class="el" href="image_8h.html#a640c15684830a3ad6b5a2fc0bcacc54b">FWHEADER_t</a> *data, size_t size, <a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> fwBase)</td></tr>
<tr class="separator:a4c065d6b9a1ae76e08bde0a84ee898e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Handle the update on the receiver. </p>
<p>This set of functions handles the update on the receiver and its progress </p>

<p>Definition in file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a9ec6c85cab067c9beeadbc0119e05211"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> CanSendParentCommands </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Determines if the parent process can be sent commands</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>handler </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if parent interested in commands. FALSE if not. </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00045">45</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="receiver_8h_source.html#l00067">RCV_DATA_t::mPortHandle</a>, <a class="el" href="update_core_8h_source.html#l00065">UPD_CORE_t::Rx</a>, <a class="el" href="platform_8h_source.html#l00060">STDINOUT</a>, <a class="el" href="platform_8h_source.html#l00072">SER_HANDLE_s::type</a>, and <a class="el" href="platform_8c_source.html#l00111">verbose</a>.</p>

<p>Referenced by <a class="el" href="update_core_8c_source.html#l00311">updEraseSector()</a>, <a class="el" href="update_core_8c_source.html#l00191">updProcessMessages()</a>, and <a class="el" href="update_core_8c_source.html#l00389">updWritePacket()</a>.</p>
<div class="fragment"><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordflow">return</span> ((<a class="code" href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a> &lt; 2) &amp;&amp; (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">Rx</a>-&gt;<a class="code" href="struct_r_c_v___d_a_t_a__t.html#a1e75f76b3c7acc50d9d1fdb3d3419ca4">mPortHandle</a>-&gt;<a class="code" href="struct_s_e_r___h_a_n_d_l_e__s.html#a719f5c0eb1f25d565f5d90906e16b523">type</a> == <a class="code" href="platform_8h.html#ab9d4b9f3543e79a75bbdf769b36a7715a65b68191746c21e2a5bbf14b6e136e50">STDINOUT</a>));</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;}</div>
<div class="ttc" id="platform_8c_html_a0b2caeb4b6f130be43e5a2f0267dd453"><div class="ttname"><a href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a></div><div class="ttdeci">int verbose</div><div class="ttdoc">verbosity </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00111">platform.c:111</a></div></div>
<div class="ttc" id="struct_s_e_r___h_a_n_d_l_e__s_html_a719f5c0eb1f25d565f5d90906e16b523"><div class="ttname"><a href="struct_s_e_r___h_a_n_d_l_e__s.html#a719f5c0eb1f25d565f5d90906e16b523">SER_HANDLE_s::type</a></div><div class="ttdeci">SER_TYPE_t type</div><div class="ttdoc">communication device type </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00072">platform.h:72</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9478a793293df1813c4a42d7701a5156"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">UPD_CORE_t::Rx</a></div><div class="ttdeci">RCV_DATA_t * Rx</div><div class="ttdoc">receiver to communicate with </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00065">updateCore.h:65</a></div></div>
<div class="ttc" id="struct_r_c_v___d_a_t_a__t_html_a1e75f76b3c7acc50d9d1fdb3d3419ca4"><div class="ttname"><a href="struct_r_c_v___d_a_t_a__t.html#a1e75f76b3c7acc50d9d1fdb3d3419ca4">RCV_DATA_t::mPortHandle</a></div><div class="ttdeci">SER_HANDLE_t * mPortHandle</div><div class="ttdoc">handle of the port connected to </div><div class="ttdef"><b>Definition:</b> <a href="receiver_8h_source.html#l00067">receiver.h:67</a></div></div>
<div class="ttc" id="platform_8h_html_ab9d4b9f3543e79a75bbdf769b36a7715a65b68191746c21e2a5bbf14b6e136e50"><div class="ttname"><a href="platform_8h.html#ab9d4b9f3543e79a75bbdf769b36a7715a65b68191746c21e2a5bbf14b6e136e50">STDINOUT</a></div><div class="ttdoc">stdin/stdout port </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00060">platform.h:60</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a5b75de599f50c2489681e0ffc8432230"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void updDeinit </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>De-Initializer for <a class="el" href="struct_u_p_d___c_o_r_e__t.html" title="Preserves the state of the upgrade and the organization of the flash. ">UPD_CORE_t</a></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00563">563</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="update_core_8h_source.html#l00079">UPD_CORE_t::pEraseRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00080">UPD_CORE_t::pEraseState</a>, <a class="el" href="update_core_8h_source.html#l00078">UPD_CORE_t::pEraseTimeout</a>, <a class="el" href="update_core_8h_source.html#l00083">UPD_CORE_t::pWriteRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, and <a class="el" href="update_core_8h_source.html#l00082">UPD_CORE_t::pWriteTimeout</a>.</p>

<p>Referenced by <a class="el" href="update_8c_source.html#l00308">UpdateFirmware()</a>, and <a class="el" href="update_core_8c_source.html#l00480">updInit()</a>.</p>
<div class="fragment"><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;{</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    free(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a>);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    free(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a>);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    free(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>);</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    free(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a>);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    free(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a>);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    free(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    free(upd);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;}</div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a048cc8432729da4d1c3d534ea76bda31"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">UPD_CORE_t::pWriteRetryCnt</a></div><div class="ttdeci">U1 * pWriteRetryCnt</div><div class="ttdoc">array to store retry counts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00083">updateCore.h:83</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a73a8daa07d3bbd09ad1b996c032d38fe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">UPD_CORE_t::pWriteTimeout</a></div><div class="ttdeci">U4 * pWriteTimeout</div><div class="ttdoc">array to store timeouts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00082">updateCore.h:82</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a473b072e9732618d37a1df6e05fb69c6"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">UPD_CORE_t::pEraseRetryCnt</a></div><div class="ttdeci">U1 * pEraseRetryCnt</div><div class="ttdoc">array to store retry counts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00079">updateCore.h:79</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ae148b3ac6b191b570ebae852b8d09779"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">UPD_CORE_t::pEraseState</a></div><div class="ttdeci">CH * pEraseState</div><div class="ttdoc">array to store erase status for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00080">updateCore.h:80</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_adea65c999b522373ffdad7f378836bd4"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">UPD_CORE_t::pEraseTimeout</a></div><div class="ttdeci">U4 * pEraseTimeout</div><div class="ttdoc">array to store timeouts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00078">updateCore.h:78</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aadfd35bbc222f233164d22a25efb6fa2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void updDumpAck </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td>
          <td class="paramname"><em>force</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Dump the current progress of the update. The output is done if either the DUMPINTERVAL timeout expired or the force parameter is TRUE. Note that verbose has to be larger than 1 for this output to be generated</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>handler </td></tr>
    <tr><td class="paramname">force</td><td>force the output ignoring the timeout </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00099">99</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="platform_8c_source.html#l02162">CONSOLE_RESTORE_POS()</a>, <a class="el" href="update_core_8h_source.html#l00047">CONSOLE_WIDTH</a>, <a class="el" href="update_core_8h_source.html#l00046">DUMPINTERVAL</a>, <a class="el" href="update_core_8h_source.html#l00072">UPD_CORE_t::FlashOrg</a>, <a class="el" href="update_core_8h_source.html#l00073">UPD_CORE_t::FlashSize</a>, <a class="el" href="update_core_8h_source.html#l00074">UPD_CORE_t::FwBase</a>, <a class="el" href="flash_8c_source.html#l00216">GetPacketNrForSector()</a>, <a class="el" href="flash_8c_source.html#l00255">GetSectorNrForAddress()</a>, <a class="el" href="types_8h_source.html#l00103">MAX</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8c_source.html#l01971">MESSAGE_PLAIN()</a>, <a class="el" href="types_8h_source.html#l00101">MIN</a>, <a class="el" href="platform_8h_source.html#l00226">MSG_DBG</a>, <a class="el" href="update_core_8h_source.html#l00067">UPD_CORE_t::NumberPackets</a>, <a class="el" href="update_core_8h_source.html#l00066">UPD_CORE_t::NumberSectors</a>, <a class="el" href="update_core_8h_source.html#l00037">PACKETSIZE</a>, <a class="el" href="update_core_8h_source.html#l00079">UPD_CORE_t::pEraseRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00080">UPD_CORE_t::pEraseState</a>, <a class="el" href="update_core_8h_source.html#l00083">UPD_CORE_t::pWriteRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, <a class="el" href="update_core_8h_source.html#l00089">UPD_CORE_t::sLastDumpTime</a>, <a class="el" href="platform_8c_source.html#l00129">TIME_GET()</a>, and <a class="el" href="platform_8c_source.html#l00111">verbose</a>.</p>

<p>Referenced by <a class="el" href="update_core_8c_source.html#l00311">updEraseSector()</a>, <a class="el" href="update_core_8c_source.html#l00191">updProcessMessages()</a>, and <a class="el" href="update_core_8c_source.html#l00578">updUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;{</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>&gt;1) &amp;&amp; ((<a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() - upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a091041a0eb56f2bdd4dc1f1931f9979d">sLastDumpTime</a>) &gt; <a class="code" href="update_core_8h.html#a4c7b5bd6e606e8e0f1dabd735eb5d407">DUMPINTERVAL</a> || force))</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    {</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <a class="code" href="platform_8c.html#ad2d7907cbda0a549b4528eda3eafd9b3">CONSOLE_RESTORE_POS</a>();</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a091041a0eb56f2bdd4dc1f1931f9979d">sLastDumpTime</a> = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>();</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> pos = 0;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> substr[<a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a>];</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        substr[<a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1] = 0;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numPacketsOverall = (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a> == 0)?upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>:<a class="code" href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordflow">while</span> (pos &lt; numPacketsOverall)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;            memset(substr, 0, <a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            <span class="comment">// first part is from pWriteState</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> lenPackets = <a class="code" href="types_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(0, <a class="code" href="types_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>-pos, <a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1));</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            memcpy(substr, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>+pos, lenPackets);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <span class="comment">// second part is from pEraseState -- remind, it&#39;s sectors in this array!</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> lenRemain = <a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1 - lenPackets;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="keywordflow">if</span> (lenRemain)</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> idx = lenPackets;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                <span class="keywordflow">for</span> (; idx &lt; <a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1; idx++)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                {</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> packOffset = (pos+idx) * <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                    <span class="keywordflow">if</span> (packOffset &gt;= upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a4b61e975215ddcf537ac8f1e4b40ef87">FlashSize</a>)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                    {</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                    }</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> packAddr = packOffset + upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a>;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                    <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> packSect = <a class="code" href="flash_8c.html#a7b8e5a1d47b072c4c567780f496a3600">GetSectorNrForAddress</a>(packAddr, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a>, 0, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                    <span class="keywordflow">if</span> (packSect == -1)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                    {</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;could not get sector for addr 0x%08X&quot;</span>, packAddr);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                    }</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                    <span class="keywordflow">if</span> (packSect &lt; upd-&gt;NumberSectors)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                    {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                        <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> secState = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[packSect];</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                        substr[idx] = secState;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                    }</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;            }</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;            <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, substr);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;            pos += (CONSOLE_WIDTH - 1);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> maxWrRetries    = 0;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> maxWrRetriesCnt = 0;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> maxErRetries    = 0;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> maxErRetriesCnt = 0;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> packet;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">for</span>(packet = 0; packet &lt; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>; packet++)</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <span class="keywordflow">if</span> (maxWrRetries &lt; upd-&gt;pWriteRetryCnt[packet])</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            {</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                maxWrRetries = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a>[packet];</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                maxWrRetriesCnt = 0;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            }</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (maxWrRetries == upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a>[packet] &amp;&amp;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                     maxWrRetries)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            {</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                maxWrRetriesCnt++;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> sector;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        <span class="keywordflow">for</span>(sector = 0; sector &lt; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>; sector++)</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        {</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;            <span class="keywordflow">if</span> (maxErRetries &lt; upd-&gt;pEraseRetryCnt[sector])</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                maxErRetries = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a>[sector];</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                maxErRetriesCnt = 0;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (maxErRetries == upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a>[sector] &amp;&amp;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                     maxErRetries)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                maxErRetriesCnt++;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        }</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;max retries: e:%2u(%3u) w:%2u(%3u)&quot;</span>, maxErRetries, (<span class="keywordtype">int</span>)maxErRetriesCnt,</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            maxWrRetries, (<span class="keywordtype">int</span>)maxWrRetriesCnt);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;\n\n&quot;</span>);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;}</div>
<div class="ttc" id="update_core_8h_html_a4c7b5bd6e606e8e0f1dabd735eb5d407"><div class="ttname"><a href="update_core_8h.html#a4c7b5bd6e606e8e0f1dabd735eb5d407">DUMPINTERVAL</a></div><div class="ttdeci">#define DUMPINTERVAL</div><div class="ttdoc">timeout between two dumps when verbose > 1 </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00046">updateCore.h:46</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="platform_8c_html_a3de0e43e9e5e923270a3fa4e6a2649fd"><div class="ttname"><a href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a></div><div class="ttdeci">U4 TIME_GET(void)</div><div class="ttdoc">Get Timer. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00129">platform.c:129</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a048cc8432729da4d1c3d534ea76bda31"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">UPD_CORE_t::pWriteRetryCnt</a></div><div class="ttdeci">U1 * pWriteRetryCnt</div><div class="ttdoc">array to store retry counts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00083">updateCore.h:83</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8h_html_a177e4581349927b04d81ac62ed804377"><div class="ttname"><a href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a></div><div class="ttdeci">#define PACKETSIZE</div><div class="ttdoc">size of a packet to send to the receiver </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00037">updateCore.h:37</a></div></div>
<div class="ttc" id="types_8h_html_a79199901c1122f5e17970b6887de3d6a"><div class="ttname"><a href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a></div><div class="ttdeci">unsigned __int8 U1</div><div class="ttdoc">8-bit unsigned integer number(unsigned character) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00058">types.h:58</a></div></div>
<div class="ttc" id="platform_8c_html_a0b2caeb4b6f130be43e5a2f0267dd453"><div class="ttname"><a href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a></div><div class="ttdeci">int verbose</div><div class="ttdoc">verbosity </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00111">platform.c:111</a></div></div>
<div class="ttc" id="platform_8c_html_a591fafe6c761800ebd98e966554b06c8"><div class="ttname"><a href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a></div><div class="ttdeci">void MESSAGE_PLAIN(const CH *format,...)</div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01971">platform.c:1971</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a4b61e975215ddcf537ac8f1e4b40ef87"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a4b61e975215ddcf537ac8f1e4b40ef87">UPD_CORE_t::FlashSize</a></div><div class="ttdeci">U4 FlashSize</div><div class="ttdoc">size of the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00073">updateCore.h:73</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9ad3d588fe8597bb6723181b77e02cfe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">UPD_CORE_t::NumberPackets</a></div><div class="ttdeci">I4 NumberPackets</div><div class="ttdoc">number of packets to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00067">updateCore.h:67</a></div></div>
<div class="ttc" id="types_8h_html_a3acffbd305ee72dcd4593c0d8af64a4f"><div class="ttname"><a href="types_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a></div><div class="ttdeci">#define MIN(a, b)</div><div class="ttdoc">minimum define </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00101">types.h:101</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a74708b0ccc127688f33a7c26cf46d587"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">UPD_CORE_t::NumberSectors</a></div><div class="ttdeci">I4 NumberSectors</div><div class="ttdoc">number of sectors to erase </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00066">updateCore.h:66</a></div></div>
<div class="ttc" id="types_8h_html_afa99ec4acc4ecb2dc3c2d05da15d0e3f"><div class="ttname"><a href="types_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a></div><div class="ttdeci">#define MAX(a, b)</div><div class="ttdoc">maximum define </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00103">types.h:103</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a473b072e9732618d37a1df6e05fb69c6"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">UPD_CORE_t::pEraseRetryCnt</a></div><div class="ttdeci">U1 * pEraseRetryCnt</div><div class="ttdoc">array to store retry counts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00079">updateCore.h:79</a></div></div>
<div class="ttc" id="update_core_8h_html_ac8a565248bf80a622adcf61f4fe6dbc3"><div class="ttname"><a href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a></div><div class="ttdeci">#define CONSOLE_WIDTH</div><div class="ttdoc">Width of the console. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00047">updateCore.h:47</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a></div><div class="ttdoc">Debug message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00226">platform.h:226</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a76347d13c839ff2559595d6fead2d913"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">UPD_CORE_t::FwBase</a></div><div class="ttdeci">U4 FwBase</div><div class="ttdoc">start address of the firmware on the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00074">updateCore.h:74</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ae148b3ac6b191b570ebae852b8d09779"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">UPD_CORE_t::pEraseState</a></div><div class="ttdeci">CH * pEraseState</div><div class="ttdoc">array to store erase status for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00080">updateCore.h:80</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb4ca04540e3469c6cf593fb6c49e137"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">UPD_CORE_t::FlashOrg</a></div><div class="ttdeci">BLOCK_ARR_t * FlashOrg</div><div class="ttdoc">flash organization </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00072">updateCore.h:72</a></div></div>
<div class="ttc" id="platform_8c_html_ad2d7907cbda0a549b4528eda3eafd9b3"><div class="ttname"><a href="platform_8c.html#ad2d7907cbda0a549b4528eda3eafd9b3">CONSOLE_RESTORE_POS</a></div><div class="ttdeci">void CONSOLE_RESTORE_POS(void)</div><div class="ttdoc">restore previously saved cursor position </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l02162">platform.c:2162</a></div></div>
<div class="ttc" id="flash_8c_html_a56b541279c3a85340438fb48478945e5"><div class="ttname"><a href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a></div><div class="ttdeci">I4 GetPacketNrForSector(const U4 Sector, const BLOCK_ARR_pt pFlashdef, const U4 PacketSize)</div><div class="ttdoc">Get the number of the packet for the given sector. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00216">flash.c:216</a></div></div>
<div class="ttc" id="types_8h_html_a2d18590ee6cb00e8ea0a631cf9696f53"><div class="ttname"><a href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a></div><div class="ttdeci">char CH</div><div class="ttdoc">8-bit character, (signed/unsigned, depending on compiler) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00064">types.h:64</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a091041a0eb56f2bdd4dc1f1931f9979d"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a091041a0eb56f2bdd4dc1f1931f9979d">UPD_CORE_t::sLastDumpTime</a></div><div class="ttdeci">U4 sLastDumpTime</div><div class="ttdoc">time of the last dump (for verbose > 1) </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00089">updateCore.h:89</a></div></div>
<div class="ttc" id="flash_8c_html_a7b8e5a1d47b072c4c567780f496a3600"><div class="ttname"><a href="flash_8c.html#a7b8e5a1d47b072c4c567780f496a3600">GetSectorNrForAddress</a></div><div class="ttdeci">I4 GetSectorNrForAddress(const U4 Address, const U4 Base, const U4 Offset, const BLOCK_ARR_pt pFlashdef)</div><div class="ttdoc">Get the sector number at address. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00255">flash.c:255</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ac873b58a11add9d97c598e7ec876c401"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> updEraseSector </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Send one erase sector command to the receiver. Either a new erase command or an erase command for a sector with expired timeout is sent.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>handler </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if successful </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00311">311</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="update_core_8h_source.html#l00056">ACK_ERASE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00055">ACK_ERASE_SENT</a>, <a class="el" href="update_core_8c_source.html#l00045">CanSendParentCommands()</a>, <a class="el" href="update_core_8h_source.html#l00040">ERASE_RETRIES</a>, <a class="el" href="update_core_8h_source.html#l00038">ERASE_TIMEOUT</a>, <a class="el" href="update_core_8h_source.html#l00069">UPD_CORE_t::erasedUntil</a>, <a class="el" href="types_8h_source.html#l00075">FALSE</a>, <a class="el" href="update_core_8h_source.html#l00072">UPD_CORE_t::FlashOrg</a>, <a class="el" href="update_core_8h_source.html#l00074">UPD_CORE_t::FwBase</a>, <a class="el" href="flash_8c_source.html#l00216">GetPacketNrForSector()</a>, <a class="el" href="update_core_8h_source.html#l00049">MAX_PENDING_ERASES</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8c_source.html#l01971">MESSAGE_PLAIN()</a>, <a class="el" href="platform_8h_source.html#l00218">MSG_ERR</a>, <a class="el" href="platform_8h_source.html#l00219">MSG_WARN</a>, <a class="el" href="update_core_8h_source.html#l00066">UPD_CORE_t::NumberSectors</a>, <a class="el" href="update_core_8h_source.html#l00037">PACKETSIZE</a>, <a class="el" href="update_core_8h_source.html#l00086">UPD_CORE_t::PendingErases</a>, <a class="el" href="update_core_8h_source.html#l00079">UPD_CORE_t::pEraseRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00080">UPD_CORE_t::pEraseState</a>, <a class="el" href="update_core_8h_source.html#l00078">UPD_CORE_t::pEraseTimeout</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, <a class="el" href="receiver_8c_source.html#l00142">rcvSendMessage()</a>, <a class="el" href="update_core_8h_source.html#l00065">UPD_CORE_t::Rx</a>, <a class="el" href="platform_8c_source.html#l00129">TIME_GET()</a>, <a class="el" href="types_8h_source.html#l00076">TRUE</a>, <a class="el" href="ubxmsg_8h_source.html#l00107">UBX_CLASS_UPD</a>, <a class="el" href="ubxmsg_8h_source.html#l00123">UBX_UPD_ERASE</a>, and <a class="el" href="update_core_8c_source.html#l00099">updDumpAck()</a>.</p>

<p>Referenced by <a class="el" href="update_core_8c_source.html#l00578">updUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;{</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> foundLastErased = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> sector;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">for</span>(sector = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a33a6ef6f3616d5c73fbaa1357921c0a7">erasedUntil</a>; sector &lt; upd-&gt;NumberSectors; sector++)</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    {</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="comment">//map the sector to the packet number</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> packetNr = <a class="code" href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a>(sector, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">if</span> (packetNr == -1)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        {</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;ERASE: Invalid PacketNr determined for Sector.&quot;</span>);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        }</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[sector] != <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        {</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            foundLastErased = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> now = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>();</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            <span class="comment">//if we sent a erase but did not get an ack within timeout, decrement</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            <span class="comment">//pending erase counter to be able to send the next erase</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">if</span> ( (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[sector] == <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a550adeb63bc97672716881df6a990992">ACK_ERASE_SENT</a>) &amp;&amp;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a>[sector] &lt;= now) )</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            {</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">PendingErases</a>--;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                <span class="keywordflow">if</span> (++upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a>[sector] &gt; <a class="code" href="update_core_8h.html#a543a47aa06fc3f724441e2ee0751af5a">ERASE_RETRIES</a>)</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Erase retries for sector %d exceeded.&quot;</span>, sector);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;Sending erase retry for sector %d&quot;</span>, sector);</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            }</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;            <span class="comment">// don&#39;t overflow the receiver</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            <span class="keywordflow">if</span> ( (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">PendingErases</a> &lt; <a class="code" href="update_core_8h.html#ad8b6fb58e055df6576bb620f05220448">MAX_PENDING_ERASES</a>) &amp;&amp;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a>[sector] &lt;= now) )</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;            {</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> Packet = <a class="code" href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a>(sector, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> Address = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a> + Packet * <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                <span class="keywordflow">if</span> ( <a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">Rx</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4daf0a297ca5ff40f8430e091e97f149">UBX_UPD_ERASE</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)&amp;Address, 4) )</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                {</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">PendingErases</a>++;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a>[sector] = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() + <a class="code" href="update_core_8h.html#a91d65cd02aa7f90fc2a0ca9e714adfcd">ERASE_TIMEOUT</a>;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[sector]   = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a550adeb63bc97672716881df6a990992">ACK_ERASE_SENT</a>;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    <span class="keywordflow">if</span> (packetNr &lt; upd-&gt;NumberPackets)</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    {</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packetNr] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a550adeb63bc97672716881df6a990992">ACK_ERASE_SENT</a>;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                    }</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a>(upd))</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                    {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;&lt;INF&gt;ERASE %i %i&lt;\\INF&gt;&quot;</span>, sector, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                }</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                {</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;SendErase failed.&quot;</span>);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                }</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            }</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !foundLastErased )</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a33a6ef6f3616d5c73fbaa1357921c0a7">erasedUntil</a> = sector + 1;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        }</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;}</div>
<div class="ttc" id="update_core_8c_html_aadfd35bbc222f233164d22a25efb6fa2"><div class="ttname"><a href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a></div><div class="ttdeci">static void updDumpAck(UPD_CORE_t *upd, BOOL force)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00099">updateCore.c:99</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a></div><div class="ttdoc">Class update. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00107">ubxmsg.h:107</a></div></div>
<div class="ttc" id="platform_8c_html_a3de0e43e9e5e923270a3fa4e6a2649fd"><div class="ttname"><a href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a></div><div class="ttdeci">U4 TIME_GET(void)</div><div class="ttdoc">Get Timer. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00129">platform.c:129</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8h_html_a177e4581349927b04d81ac62ed804377"><div class="ttname"><a href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a></div><div class="ttdeci">#define PACKETSIZE</div><div class="ttdoc">size of a packet to send to the receiver </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00037">updateCore.h:37</a></div></div>
<div class="ttc" id="platform_8c_html_a591fafe6c761800ebd98e966554b06c8"><div class="ttname"><a href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a></div><div class="ttdeci">void MESSAGE_PLAIN(const CH *format,...)</div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01971">platform.c:1971</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="update_core_8h_html_a543a47aa06fc3f724441e2ee0751af5a"><div class="ttname"><a href="update_core_8h.html#a543a47aa06fc3f724441e2ee0751af5a">ERASE_RETRIES</a></div><div class="ttdeci">#define ERASE_RETRIES</div><div class="ttdoc">number of retries to erase block </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00040">updateCore.h:40</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a33a6ef6f3616d5c73fbaa1357921c0a7"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a33a6ef6f3616d5c73fbaa1357921c0a7">UPD_CORE_t::erasedUntil</a></div><div class="ttdeci">I4 erasedUntil</div><div class="ttdoc">used to optimize the erase loop </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00069">updateCore.h:69</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a></div><div class="ttdoc">Error message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00218">platform.h:218</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a></div><div class="ttdoc">Warning message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00219">platform.h:219</a></div></div>
<div class="ttc" id="receiver_8c_html_ae0a9b8dd16e773cc5ef09b6206e74580"><div class="ttname"><a href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a></div><div class="ttdeci">BOOL rcvSendMessage(RCV_DATA_t *rcv, U1 classId, U1 msgId, CH *payload, U4 payloadSize)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00142">receiver.c:142</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="types_8h_html_a050c65e107f0c828f856a231f4b4e788"><div class="ttname"><a href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a></div><div class="ttdeci">int BOOL</div><div class="ttdoc">Boolean type. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00073">types.h:73</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa4daf0a297ca5ff40f8430e091e97f149"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4daf0a297ca5ff40f8430e091e97f149">UBX_UPD_ERASE</a></div><div class="ttdoc">Flash erase (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00123">ubxmsg.h:123</a></div></div>
<div class="ttc" id="types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdoc">Boolean FALSE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="update_core_8c_html_a9ec6c85cab067c9beeadbc0119e05211"><div class="ttname"><a href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a></div><div class="ttdeci">static BOOL CanSendParentCommands(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00045">updateCore.c:45</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb6b1b5a2bdd4ff1335b2060a04ecd38"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">UPD_CORE_t::PendingErases</a></div><div class="ttdeci">U4 PendingErases</div><div class="ttdoc">number of erases pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00086">updateCore.h:86</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a74708b0ccc127688f33a7c26cf46d587"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">UPD_CORE_t::NumberSectors</a></div><div class="ttdeci">I4 NumberSectors</div><div class="ttdoc">number of sectors to erase </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00066">updateCore.h:66</a></div></div>
<div class="ttc" id="update_core_8h_html_a91d65cd02aa7f90fc2a0ca9e714adfcd"><div class="ttname"><a href="update_core_8h.html#a91d65cd02aa7f90fc2a0ca9e714adfcd">ERASE_TIMEOUT</a></div><div class="ttdeci">#define ERASE_TIMEOUT</div><div class="ttdoc">timeout for erasing a sector </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00038">updateCore.h:38</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a></div><div class="ttdoc">erase acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00056">updateCore.h:56</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a550adeb63bc97672716881df6a990992"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a550adeb63bc97672716881df6a990992">ACK_ERASE_SENT</a></div><div class="ttdoc">erase pending for packet (sector-blocks) </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00055">updateCore.h:55</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a473b072e9732618d37a1df6e05fb69c6"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">UPD_CORE_t::pEraseRetryCnt</a></div><div class="ttdeci">U1 * pEraseRetryCnt</div><div class="ttdoc">array to store retry counts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00079">updateCore.h:79</a></div></div>
<div class="ttc" id="types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdoc">Boolean TRUE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00076">types.h:76</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9478a793293df1813c4a42d7701a5156"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">UPD_CORE_t::Rx</a></div><div class="ttdeci">RCV_DATA_t * Rx</div><div class="ttdoc">receiver to communicate with </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00065">updateCore.h:65</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a76347d13c839ff2559595d6fead2d913"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">UPD_CORE_t::FwBase</a></div><div class="ttdeci">U4 FwBase</div><div class="ttdoc">start address of the firmware on the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00074">updateCore.h:74</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ae148b3ac6b191b570ebae852b8d09779"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">UPD_CORE_t::pEraseState</a></div><div class="ttdeci">CH * pEraseState</div><div class="ttdoc">array to store erase status for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00080">updateCore.h:80</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb4ca04540e3469c6cf593fb6c49e137"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">UPD_CORE_t::FlashOrg</a></div><div class="ttdeci">BLOCK_ARR_t * FlashOrg</div><div class="ttdoc">flash organization </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00072">updateCore.h:72</a></div></div>
<div class="ttc" id="update_core_8h_html_ad8b6fb58e055df6576bb620f05220448"><div class="ttname"><a href="update_core_8h.html#ad8b6fb58e055df6576bb620f05220448">MAX_PENDING_ERASES</a></div><div class="ttdeci">#define MAX_PENDING_ERASES</div><div class="ttdoc">The maximum number of erase commands to be present in the receiver queue. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00049">updateCore.h:49</a></div></div>
<div class="ttc" id="flash_8c_html_a56b541279c3a85340438fb48478945e5"><div class="ttname"><a href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a></div><div class="ttdeci">I4 GetPacketNrForSector(const U4 Sector, const BLOCK_ARR_pt pFlashdef, const U4 PacketSize)</div><div class="ttdoc">Get the number of the packet for the given sector. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00216">flash.c:216</a></div></div>
<div class="ttc" id="types_8h_html_a2d18590ee6cb00e8ea0a631cf9696f53"><div class="ttname"><a href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a></div><div class="ttdeci">char CH</div><div class="ttdoc">8-bit character, (signed/unsigned, depending on compiler) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00064">types.h:64</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_adea65c999b522373ffdad7f378836bd4"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">UPD_CORE_t::pEraseTimeout</a></div><div class="ttdeci">U4 * pEraseTimeout</div><div class="ttdoc">array to store timeouts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00078">updateCore.h:78</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a67c60123bde16f3fdf5a6e04c970bfce"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a>* updInit </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a> *&#160;</td>
          <td class="paramname"><em>rx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a>&#160;</td>
          <td class="paramname"><em>numberSectors</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a>&#160;</td>
          <td class="paramname"><em>numberPackets</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="flash_8h.html#af4b45687636458b5af7637bc97293f4d">BLOCK_ARR_t</a> *&#160;</td>
          <td class="paramname"><em>flashOrg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>&#160;</td>
          <td class="paramname"><em>flashSize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>&#160;</td>
          <td class="paramname"><em>MaxPendingWritesNum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&#160;</td>
          <td class="paramname"><em>eraseInProgres</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initializer for <a class="el" href="struct_u_p_d___c_o_r_e__t.html" title="Preserves the state of the upgrade and the organization of the flash. ">UPD_CORE_t</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">rx</td><td>receiver to do the update on </td></tr>
    <tr><td class="paramname">numberSectors</td><td>number of sectors to erase </td></tr>
    <tr><td class="paramname">numberPackets</td><td>number of packets to write </td></tr>
    <tr><td class="paramname">flashOrg</td><td>information about the organization of the flash </td></tr>
    <tr><td class="paramname">flashSize</td><td>size of the flash </td></tr>
    <tr><td class="paramname">MaxPendingWritesNum</td><td>Maximum possible number of pending writes </td></tr>
    <tr><td class="paramname">eraseInProgres</td><td>Means that flash erase was started but not finished before entering update. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The control structure on success, NULL on fail </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00480">480</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="update_core_8h_source.html#l00056">ACK_ERASE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00054">ACK_INIT</a>, <a class="el" href="platform_8c_source.html#l02115">CONSOLE_SAVE_POS()</a>, <a class="el" href="update_core_8h_source.html#l00047">CONSOLE_WIDTH</a>, <a class="el" href="update_core_8h_source.html#l00069">UPD_CORE_t::erasedUntil</a>, <a class="el" href="update_core_8h_source.html#l00092">UPD_CORE_t::eraseInProgres</a>, <a class="el" href="update_core_8h_source.html#l00072">UPD_CORE_t::FlashOrg</a>, <a class="el" href="update_core_8h_source.html#l00073">UPD_CORE_t::FlashSize</a>, <a class="el" href="flash_8c_source.html#l00216">GetPacketNrForSector()</a>, <a class="el" href="update_core_8h_source.html#l00091">UPD_CORE_t::MaxPendingWritesNum</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8h_source.html#l00224">MSG_LEV1</a>, <a class="el" href="types_8h_source.html#l00078">NULL</a>, <a class="el" href="update_core_8h_source.html#l00067">UPD_CORE_t::NumberPackets</a>, <a class="el" href="update_core_8h_source.html#l00066">UPD_CORE_t::NumberSectors</a>, <a class="el" href="update_core_8h_source.html#l00037">PACKETSIZE</a>, <a class="el" href="update_core_8h_source.html#l00086">UPD_CORE_t::PendingErases</a>, <a class="el" href="update_core_8h_source.html#l00087">UPD_CORE_t::PendingWrites</a>, <a class="el" href="update_core_8h_source.html#l00079">UPD_CORE_t::pEraseRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00080">UPD_CORE_t::pEraseState</a>, <a class="el" href="update_core_8h_source.html#l00078">UPD_CORE_t::pEraseTimeout</a>, <a class="el" href="update_core_8h_source.html#l00083">UPD_CORE_t::pWriteRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, <a class="el" href="update_core_8h_source.html#l00082">UPD_CORE_t::pWriteTimeout</a>, <a class="el" href="update_core_8h_source.html#l00065">UPD_CORE_t::Rx</a>, <a class="el" href="update_core_8h_source.html#l00089">UPD_CORE_t::sLastDumpTime</a>, <a class="el" href="update_core_8c_source.html#l00563">updDeinit()</a>, <a class="el" href="platform_8c_source.html#l00111">verbose</a>, and <a class="el" href="update_core_8h_source.html#l00068">UPD_CORE_t::writtenUntil</a>.</p>

<p>Referenced by <a class="el" href="update_8c_source.html#l00308">UpdateFirmware()</a>.</p>
<div class="fragment"><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;{</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    assert(rx);</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <a class="code" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd= (<a class="code" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a>*) malloc(<span class="keyword">sizeof</span>(*upd));</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">if</span>(!upd)</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    memset(upd, 0, <span class="keyword">sizeof</span>(*upd));</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">Rx</a> = rx;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">// we did not yet erase / write anything</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a33a6ef6f3616d5c73fbaa1357921c0a7">erasedUntil</a> = 0;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a6ff39625defb3d08d5991949c4f64696">writtenUntil</a> = 0;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a> = numberSectors;</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a> = numberPackets;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a> = flashOrg;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a4b61e975215ddcf537ac8f1e4b40ef87">FlashSize</a> = flashSize;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a1cbc5b9d688c2a8ce86eea878c111500">MaxPendingWritesNum</a> = MaxPendingWritesNum;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">eraseInProgres</a> = eraseInProgres;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">PendingErases</a>  = 0;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>  = 0;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a091041a0eb56f2bdd4dc1f1931f9979d">sLastDumpTime</a>  = 0;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a>  = (<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>)*upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>);</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a> = (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>)*upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>);</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>    = (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>)*upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>);</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a>  = (<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>)*upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>);</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a> = (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>)*upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>    = (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>)*upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordflow">if</span>( !upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;     || !upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;     || !upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;     || !upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;     || !upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;     || !upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a> )</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    {</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <a class="code" href="update_core_8c.html#a5b75de599f50c2489681e0ffc8432230">updDeinit</a>(upd);</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    }</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    memset(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">pEraseTimeout</a>,  0,        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>*<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>));</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    memset(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a>, 0,        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>*<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>));</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    memset(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>,    <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9">ACK_INIT</a>, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>*<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>));</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    memset(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a>,  0,        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>*<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>));</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    memset(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a>, 0,        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>*<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>));</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    memset(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>,    (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a> == 0)?<a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>:<a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9">ACK_INIT</a>, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>*<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>));</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Receiver info collected, downloading to flash...&quot;</span>);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a> &gt; 1)</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    {</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numPacketsOverall = (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a> == 0)?upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>:<a class="code" href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="comment">// compute the number of lines needed to do a full dump</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="comment">// CONSOLE_WIDTH - 1 to make sure that the newline character is not</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="comment">// placed on a new line (seen in windows 7)</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> numberOfLines = numPacketsOverall / (<a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="keywordflow">if</span>(numPacketsOverall % (<a class="code" href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a> - 1) != 0)</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            ++numberOfLines;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="comment">// for the max retries and the newline</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        numberOfLines += 2;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <a class="code" href="platform_8c.html#a21076b28b74288670cab46657b3146d9">CONSOLE_SAVE_POS</a>(numberOfLines);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    }</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keywordflow">return</span> upd;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;}</div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a048cc8432729da4d1c3d534ea76bda31"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">UPD_CORE_t::pWriteRetryCnt</a></div><div class="ttdeci">U1 * pWriteRetryCnt</div><div class="ttdoc">array to store retry counts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00083">updateCore.h:83</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8c_html_a5b75de599f50c2489681e0ffc8432230"><div class="ttname"><a href="update_core_8c.html#a5b75de599f50c2489681e0ffc8432230">updDeinit</a></div><div class="ttdeci">void updDeinit(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00563">updateCore.c:563</a></div></div>
<div class="ttc" id="update_core_8h_html_a177e4581349927b04d81ac62ed804377"><div class="ttname"><a href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a></div><div class="ttdeci">#define PACKETSIZE</div><div class="ttdoc">size of a packet to send to the receiver </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00037">updateCore.h:37</a></div></div>
<div class="ttc" id="types_8h_html_a79199901c1122f5e17970b6887de3d6a"><div class="ttname"><a href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a></div><div class="ttdeci">unsigned __int8 U1</div><div class="ttdoc">8-bit unsigned integer number(unsigned character) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00058">types.h:58</a></div></div>
<div class="ttc" id="platform_8c_html_a0b2caeb4b6f130be43e5a2f0267dd453"><div class="ttname"><a href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a></div><div class="ttdeci">int verbose</div><div class="ttdoc">verbosity </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00111">platform.c:111</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a></div><div class="ttdoc">Preserves the state of the upgrade and the organization of the flash. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00063">updateCore.h:63</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="platform_8c_html_a21076b28b74288670cab46657b3146d9"><div class="ttname"><a href="platform_8c.html#a21076b28b74288670cab46657b3146d9">CONSOLE_SAVE_POS</a></div><div class="ttdeci">void CONSOLE_SAVE_POS(U4 offs)</div><div class="ttdoc">save current cursor position </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l02115">platform.c:2115</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a6ff39625defb3d08d5991949c4f64696"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a6ff39625defb3d08d5991949c4f64696">UPD_CORE_t::writtenUntil</a></div><div class="ttdeci">I4 writtenUntil</div><div class="ttdoc">used to optimize the write loop </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00068">updateCore.h:68</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a33a6ef6f3616d5c73fbaa1357921c0a7"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a33a6ef6f3616d5c73fbaa1357921c0a7">UPD_CORE_t::erasedUntil</a></div><div class="ttdeci">I4 erasedUntil</div><div class="ttdoc">used to optimize the erase loop </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00069">updateCore.h:69</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a73a8daa07d3bbd09ad1b996c032d38fe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">UPD_CORE_t::pWriteTimeout</a></div><div class="ttdeci">U4 * pWriteTimeout</div><div class="ttdoc">array to store timeouts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00082">updateCore.h:82</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a></div><div class="ttdoc">Verbosity Level 1 message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00224">platform.h:224</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a4b61e975215ddcf537ac8f1e4b40ef87"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a4b61e975215ddcf537ac8f1e4b40ef87">UPD_CORE_t::FlashSize</a></div><div class="ttdeci">U4 FlashSize</div><div class="ttdoc">size of the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00073">updateCore.h:73</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9ad3d588fe8597bb6723181b77e02cfe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">UPD_CORE_t::NumberPackets</a></div><div class="ttdeci">I4 NumberPackets</div><div class="ttdoc">number of packets to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00067">updateCore.h:67</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_af4892b3558ebdfb2c651670dee779d06"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">UPD_CORE_t::eraseInProgres</a></div><div class="ttdeci">BOOL eraseInProgres</div><div class="ttdoc">Erase in progress. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00092">updateCore.h:92</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb6b1b5a2bdd4ff1335b2060a04ecd38"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">UPD_CORE_t::PendingErases</a></div><div class="ttdeci">U4 PendingErases</div><div class="ttdoc">number of erases pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00086">updateCore.h:86</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a74708b0ccc127688f33a7c26cf46d587"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">UPD_CORE_t::NumberSectors</a></div><div class="ttdeci">I4 NumberSectors</div><div class="ttdoc">number of sectors to erase </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00066">updateCore.h:66</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a></div><div class="ttdoc">erase acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00056">updateCore.h:56</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a473b072e9732618d37a1df6e05fb69c6"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">UPD_CORE_t::pEraseRetryCnt</a></div><div class="ttdeci">U1 * pEraseRetryCnt</div><div class="ttdoc">array to store retry counts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00079">updateCore.h:79</a></div></div>
<div class="ttc" id="types_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdoc">Null. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00078">types.h:78</a></div></div>
<div class="ttc" id="update_core_8h_html_ac8a565248bf80a622adcf61f4fe6dbc3"><div class="ttname"><a href="update_core_8h.html#ac8a565248bf80a622adcf61f4fe6dbc3">CONSOLE_WIDTH</a></div><div class="ttdeci">#define CONSOLE_WIDTH</div><div class="ttdoc">Width of the console. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00047">updateCore.h:47</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9478a793293df1813c4a42d7701a5156"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">UPD_CORE_t::Rx</a></div><div class="ttdeci">RCV_DATA_t * Rx</div><div class="ttdoc">receiver to communicate with </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00065">updateCore.h:65</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ae148b3ac6b191b570ebae852b8d09779"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">UPD_CORE_t::pEraseState</a></div><div class="ttdeci">CH * pEraseState</div><div class="ttdoc">array to store erase status for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00080">updateCore.h:80</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a1cbc5b9d688c2a8ce86eea878c111500"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a1cbc5b9d688c2a8ce86eea878c111500">UPD_CORE_t::MaxPendingWritesNum</a></div><div class="ttdeci">U4 MaxPendingWritesNum</div><div class="ttdoc">max number of which can be queued in the receiver writes pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00091">updateCore.h:91</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb4ca04540e3469c6cf593fb6c49e137"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">UPD_CORE_t::FlashOrg</a></div><div class="ttdeci">BLOCK_ARR_t * FlashOrg</div><div class="ttdoc">flash organization </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00072">updateCore.h:72</a></div></div>
<div class="ttc" id="flash_8c_html_a56b541279c3a85340438fb48478945e5"><div class="ttname"><a href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a></div><div class="ttdeci">I4 GetPacketNrForSector(const U4 Sector, const BLOCK_ARR_pt pFlashdef, const U4 PacketSize)</div><div class="ttdoc">Get the number of the packet for the given sector. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00216">flash.c:216</a></div></div>
<div class="ttc" id="types_8h_html_a2d18590ee6cb00e8ea0a631cf9696f53"><div class="ttname"><a href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a></div><div class="ttdeci">char CH</div><div class="ttdoc">8-bit character, (signed/unsigned, depending on compiler) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00064">types.h:64</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9">ACK_INIT</a></div><div class="ttdoc">initial state </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00054">updateCore.h:54</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a091041a0eb56f2bdd4dc1f1931f9979d"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a091041a0eb56f2bdd4dc1f1931f9979d">UPD_CORE_t::sLastDumpTime</a></div><div class="ttdeci">U4 sLastDumpTime</div><div class="ttdoc">time of the last dump (for verbose > 1) </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00089">updateCore.h:89</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a0bcb4d97e337d93937d3be604776ed8f"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">UPD_CORE_t::PendingWrites</a></div><div class="ttdeci">U4 PendingWrites</div><div class="ttdoc">number of writes pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00087">updateCore.h:87</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_adea65c999b522373ffdad7f378836bd4"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#adea65c999b522373ffdad7f378836bd4">UPD_CORE_t::pEraseTimeout</a></div><div class="ttdeci">U4 * pEraseTimeout</div><div class="ttdoc">array to store timeouts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00078">updateCore.h:78</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ae78c9293d678ee3e6a3d297800f579ed"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> updProcessMessages </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Receive data from the receiver and process it</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>handler </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if successful </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00191">191</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="update_core_8h_source.html#l00056">ACK_ERASE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00054">ACK_INIT</a>, <a class="el" href="update_core_8h_source.html#l00058">ACK_WRITE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00057">ACK_WRITE_SENT</a>, <a class="el" href="update_core_8c_source.html#l00045">CanSendParentCommands()</a>, <a class="el" href="update_core_8h_source.html#l00092">UPD_CORE_t::eraseInProgres</a>, <a class="el" href="types_8h_source.html#l00075">FALSE</a>, <a class="el" href="update_core_8h_source.html#l00072">UPD_CORE_t::FlashOrg</a>, <a class="el" href="update_core_8h_source.html#l00074">UPD_CORE_t::FwBase</a>, <a class="el" href="flash_8c_source.html#l00310">GetPacketNrForAddress()</a>, <a class="el" href="flash_8c_source.html#l00216">GetPacketNrForSector()</a>, <a class="el" href="flash_8c_source.html#l00255">GetSectorNrForAddress()</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8c_source.html#l01971">MESSAGE_PLAIN()</a>, <a class="el" href="platform_8h_source.html#l00218">MSG_ERR</a>, <a class="el" href="platform_8h_source.html#l00219">MSG_WARN</a>, <a class="el" href="ubxmsg_8h_source.html#l00058">UBX_HEAD_s::msgId</a>, <a class="el" href="types_8h_source.html#l00078">NULL</a>, <a class="el" href="update_core_8h_source.html#l00067">UPD_CORE_t::NumberPackets</a>, <a class="el" href="update_core_8h_source.html#l00037">PACKETSIZE</a>, <a class="el" href="update_core_8h_source.html#l00086">UPD_CORE_t::PendingErases</a>, <a class="el" href="update_core_8h_source.html#l00087">UPD_CORE_t::PendingWrites</a>, <a class="el" href="update_core_8h_source.html#l00079">UPD_CORE_t::pEraseRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00080">UPD_CORE_t::pEraseState</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, <a class="el" href="receiver_8c_source.html#l00232">rcvReceiveMessage()</a>, <a class="el" href="update_core_8h_source.html#l00065">UPD_CORE_t::Rx</a>, <a class="el" href="ubxmsg_8h_source.html#l00059">UBX_HEAD_s::size</a>, <a class="el" href="platform_8c_source.html#l00120">TIME_SLEEP()</a>, <a class="el" href="types_8h_source.html#l00076">TRUE</a>, <a class="el" href="ubxmsg_8h_source.html#l00107">UBX_CLASS_UPD</a>, <a class="el" href="ubxmsg_8h_source.html#l00097">UBX_HEAD_SIZE</a>, <a class="el" href="ubxmsg_8h_source.html#l00120">UBX_UPD_CERASE</a>, <a class="el" href="ubxmsg_8h_source.html#l00047">UBX_UPD_CERASE_DATA1_PAYLOAD_SIZE</a>, <a class="el" href="ubxmsg_8h_source.html#l00123">UBX_UPD_ERASE</a>, <a class="el" href="ubxmsg_8h_source.html#l00048">UBX_UPD_ERASE_DATA1_PAYLOAD_SIZE</a>, <a class="el" href="ubxmsg_8h_source.html#l00125">UBX_UPD_FLWRI</a>, <a class="el" href="ubxmsg_8h_source.html#l00049">UBX_UPD_FLWRI_DATA1_PAYLOAD_SIZE</a>, and <a class="el" href="update_core_8c_source.html#l00099">updDumpAck()</a>.</p>

<p>Referenced by <a class="el" href="update_core_8c_source.html#l00578">updUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;{</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordflow">for</span>(;;)</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *msg = <a class="code" href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">Rx</a>, 0, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, -1);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keywordflow">if</span>(msg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        {</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(1);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        }</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == <a class="code" href="ubxmsg_8h.html#ac54542bd3bfab3cbeaa58fc5997ad7d4">UBX_UPD_ERASE_DATA1_PAYLOAD_SIZE</a> &amp;&amp; msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">msgId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4daf0a297ca5ff40f8430e091e97f149">UBX_UPD_ERASE</a>)</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> Address;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            memcpy(&amp;Address, ((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>, 4);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;            <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> Sector = <a class="code" href="flash_8c.html#a7b8e5a1d47b072c4c567780f496a3600">GetSectorNrForAddress</a>(Address, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a>, 0, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> Success;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            memcpy(&amp;Success, ((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+4, 1);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;            <span class="keywordflow">if</span> ((Sector != -1) &amp;&amp; Success)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            {</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                <span class="keywordflow">if</span>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[Sector] != <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>)</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[Sector] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> begin = <a class="code" href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a>(Sector, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> end = <a class="code" href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a>(Sector+1, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">FlashOrg</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                    <span class="comment">//flag packets to be acknowledged erased</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> packet;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                    <span class="keywordflow">for</span>(packet = begin; packet &lt; end &amp;&amp; packet &lt; (<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>)upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>; packet++)</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                    {</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packet] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                    }</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">PendingErases</a>--;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a>(upd))</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                    {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;&lt;INF&gt;ERASE_ACK %i&lt;\\INF&gt;&quot;</span>, Sector);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                    }</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                }</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            {</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Possibly defect flash (erase failed), sector %02d at 0x%08X&quot;</span>,  Sector, Address);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="comment">//don&#39;t wait for timeout, immediately retry</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">pEraseRetryCnt</a>[Sector]++;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[Sector] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9">ACK_INIT</a>;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            }</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        }</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == <a class="code" href="ubxmsg_8h.html#a637b735fddc173e8995ffc63afbdfea8">UBX_UPD_FLWRI_DATA1_PAYLOAD_SIZE</a> &amp;&amp; msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">msgId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235">UBX_UPD_FLWRI</a>)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        {</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> Address;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            memcpy(&amp;Address, ((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>, 4);</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> Packet = <a class="code" href="flash_8c.html#a50301d8854326fa74b9383ce44365650">GetPacketNrForAddress</a>(Address, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a>, <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> Success;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            memcpy(&amp;Success, ((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+4, 1);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            <span class="keywordflow">if</span> (Packet != -1)</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            {</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                <span class="keywordflow">if</span> (Success)</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                {</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a>(upd))</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                    {</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;&lt;INF&gt;WRITE_ACK %i&lt;\\INF&gt;&quot;</span>, Packet);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                    }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                    <span class="comment">//flag packet to be acknowledged written if we got the erase acked before</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                    <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[Packet] == <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230">ACK_WRITE_SENT</a> ||    <span class="comment">//as expected</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[Packet] == <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a>)       <span class="comment">//written twice successfully</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                    {</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                        upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[Packet] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a>;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                        <span class="keywordflow">if</span>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>)</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                        {</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                            upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>--;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                        }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                    }</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                    {</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;Packet %03d (0x%08X) W rec but %c&quot;</span>,</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                            Packet, Address, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[Packet]);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                    }</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                    <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                }</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                    <span class="comment">//write failed, don&#39;t retry -&gt; flash seems to be corrupt</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Defect flash (write failed) in range 0x%08X:0x%08X&quot;</span>,</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                        Address, Address+<a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>);</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                    free(msg);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                }</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;            }</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            {</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Received ack for unknown packet&quot;</span>);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            }</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == <a class="code" href="ubxmsg_8h.html#aaf89c6d172119a54798e122ce8a6babb">UBX_UPD_CERASE_DATA1_PAYLOAD_SIZE</a> &amp;&amp; msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">msgId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9">UBX_UPD_CERASE</a>)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        {</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">eraseInProgres</a>)</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            {</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                <span class="keywordflow">if</span> (((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg)[<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>] != 1)</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                {</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Chip erase failed&quot;</span>);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                }</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                {</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">eraseInProgres</a> = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>; <span class="comment">// erase finished</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                }</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            }</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        }</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        free(msg);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    }</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;}</div>
<div class="ttc" id="update_core_8c_html_aadfd35bbc222f233164d22a25efb6fa2"><div class="ttname"><a href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a></div><div class="ttdeci">static void updDumpAck(UPD_CORE_t *upd, BOOL force)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00099">updateCore.c:99</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a></div><div class="ttdoc">Class update. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00107">ubxmsg.h:107</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8h_html_a177e4581349927b04d81ac62ed804377"><div class="ttname"><a href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a></div><div class="ttdeci">#define PACKETSIZE</div><div class="ttdoc">size of a packet to send to the receiver </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00037">updateCore.h:37</a></div></div>
<div class="ttc" id="types_8h_html_a79199901c1122f5e17970b6887de3d6a"><div class="ttname"><a href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a></div><div class="ttdeci">unsigned __int8 U1</div><div class="ttdoc">8-bit unsigned integer number(unsigned character) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00058">types.h:58</a></div></div>
<div class="ttc" id="platform_8c_html_a591fafe6c761800ebd98e966554b06c8"><div class="ttname"><a href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a></div><div class="ttdeci">void MESSAGE_PLAIN(const CH *format,...)</div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01971">platform.c:1971</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9">UBX_UPD_CERASE</a></div><div class="ttdoc">Chip erase (NDA 15+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00120">ubxmsg.h:120</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235">UBX_UPD_FLWRI</a></div><div class="ttdoc">Flash write (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00125">ubxmsg.h:125</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a></div><div class="ttdoc">Error message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00218">platform.h:218</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html_a9a428e9f3708855941db98ea8fe9bbc4"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">UBX_HEAD_s::msgId</a></div><div class="ttdeci">U1 msgId</div><div class="ttdoc">UBX Message Id. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00058">ubxmsg.h:58</a></div></div>
<div class="ttc" id="platform_8c_html_af7851ef9e3a8ddb893d2f1af81c11296"><div class="ttname"><a href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a></div><div class="ttdeci">void TIME_SLEEP(U4 ms)</div><div class="ttdoc">Sleep. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00120">platform.c:120</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a></div><div class="ttdoc">Warning message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00219">platform.h:219</a></div></div>
<div class="ttc" id="receiver_8c_html_a02c74cd7d3d7df99a9d5abb45cfb5a58"><div class="ttname"><a href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a></div><div class="ttdeci">UBX_HEAD_t * rcvReceiveMessage(RCV_DATA_t *rcv, U4 timeout, I4 classId, I4 msgId)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00232">receiver.c:232</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa4daf0a297ca5ff40f8430e091e97f149"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4daf0a297ca5ff40f8430e091e97f149">UBX_UPD_ERASE</a></div><div class="ttdoc">Flash erase (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00123">ubxmsg.h:123</a></div></div>
<div class="ttc" id="types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdoc">Boolean FALSE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9ad3d588fe8597bb6723181b77e02cfe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">UPD_CORE_t::NumberPackets</a></div><div class="ttdeci">I4 NumberPackets</div><div class="ttdoc">number of packets to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00067">updateCore.h:67</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_af4892b3558ebdfb2c651670dee779d06"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">UPD_CORE_t::eraseInProgres</a></div><div class="ttdeci">BOOL eraseInProgres</div><div class="ttdoc">Erase in progress. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00092">updateCore.h:92</a></div></div>
<div class="ttc" id="update_core_8c_html_a9ec6c85cab067c9beeadbc0119e05211"><div class="ttname"><a href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a></div><div class="ttdeci">static BOOL CanSendParentCommands(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00045">updateCore.c:45</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb6b1b5a2bdd4ff1335b2060a04ecd38"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb6b1b5a2bdd4ff1335b2060a04ecd38">UPD_CORE_t::PendingErases</a></div><div class="ttdeci">U4 PendingErases</div><div class="ttdoc">number of erases pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00086">updateCore.h:86</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a></div><div class="ttdoc">erase acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00056">updateCore.h:56</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a473b072e9732618d37a1df6e05fb69c6"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a473b072e9732618d37a1df6e05fb69c6">UPD_CORE_t::pEraseRetryCnt</a></div><div class="ttdeci">U1 * pEraseRetryCnt</div><div class="ttdoc">array to store retry counts for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00079">updateCore.h:79</a></div></div>
<div class="ttc" id="types_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdoc">Null. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00078">types.h:78</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_aaf89c6d172119a54798e122ce8a6babb"><div class="ttname"><a href="ubxmsg_8h.html#aaf89c6d172119a54798e122ce8a6babb">UBX_UPD_CERASE_DATA1_PAYLOAD_SIZE</a></div><div class="ttdeci">#define UBX_UPD_CERASE_DATA1_PAYLOAD_SIZE</div><div class="ttdoc">Payload size of chip erase acknowladge message. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00047">ubxmsg.h:47</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_s</a></div><div class="ttdoc">UBX Protocol Header. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00054">ubxmsg.h:54</a></div></div>
<div class="ttc" id="types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdoc">Boolean TRUE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00076">types.h:76</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9478a793293df1813c4a42d7701a5156"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">UPD_CORE_t::Rx</a></div><div class="ttdeci">RCV_DATA_t * Rx</div><div class="ttdoc">receiver to communicate with </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00065">updateCore.h:65</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a5a802d4c63ef065926e9508383f43e3d"><div class="ttname"><a href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a></div><div class="ttdeci">#define UBX_HEAD_SIZE</div><div class="ttdoc">UBX Protocol Header Size. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00097">ubxmsg.h:97</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a76347d13c839ff2559595d6fead2d913"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">UPD_CORE_t::FwBase</a></div><div class="ttdeci">U4 FwBase</div><div class="ttdoc">start address of the firmware on the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00074">updateCore.h:74</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ae148b3ac6b191b570ebae852b8d09779"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">UPD_CORE_t::pEraseState</a></div><div class="ttdeci">CH * pEraseState</div><div class="ttdoc">array to store erase status for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00080">updateCore.h:80</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a></div><div class="ttdoc">write acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00058">updateCore.h:58</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230">ACK_WRITE_SENT</a></div><div class="ttdoc">write pending for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00057">updateCore.h:57</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_aeb4ca04540e3469c6cf593fb6c49e137"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#aeb4ca04540e3469c6cf593fb6c49e137">UPD_CORE_t::FlashOrg</a></div><div class="ttdeci">BLOCK_ARR_t * FlashOrg</div><div class="ttdoc">flash organization </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00072">updateCore.h:72</a></div></div>
<div class="ttc" id="flash_8c_html_a56b541279c3a85340438fb48478945e5"><div class="ttname"><a href="flash_8c.html#a56b541279c3a85340438fb48478945e5">GetPacketNrForSector</a></div><div class="ttdeci">I4 GetPacketNrForSector(const U4 Sector, const BLOCK_ARR_pt pFlashdef, const U4 PacketSize)</div><div class="ttdoc">Get the number of the packet for the given sector. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00216">flash.c:216</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_ac54542bd3bfab3cbeaa58fc5997ad7d4"><div class="ttname"><a href="ubxmsg_8h.html#ac54542bd3bfab3cbeaa58fc5997ad7d4">UBX_UPD_ERASE_DATA1_PAYLOAD_SIZE</a></div><div class="ttdeci">#define UBX_UPD_ERASE_DATA1_PAYLOAD_SIZE</div><div class="ttdoc">Payload size of sector erase acknowladge message. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00048">ubxmsg.h:48</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a637b735fddc173e8995ffc63afbdfea8"><div class="ttname"><a href="ubxmsg_8h.html#a637b735fddc173e8995ffc63afbdfea8">UBX_UPD_FLWRI_DATA1_PAYLOAD_SIZE</a></div><div class="ttdeci">#define UBX_UPD_FLWRI_DATA1_PAYLOAD_SIZE</div><div class="ttdoc">Payload size of payload write acknowladge message. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00049">ubxmsg.h:49</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html_aa89eeea608ab09a8ba70d5b92e641f30"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">UBX_HEAD_s::size</a></div><div class="ttdeci">U2 size</div><div class="ttdoc">Payload Size. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00059">ubxmsg.h:59</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39adc4435c49874c6d3145e6cb0754373a9">ACK_INIT</a></div><div class="ttdoc">initial state </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00054">updateCore.h:54</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a0bcb4d97e337d93937d3be604776ed8f"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">UPD_CORE_t::PendingWrites</a></div><div class="ttdeci">U4 PendingWrites</div><div class="ttdoc">number of writes pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00087">updateCore.h:87</a></div></div>
<div class="ttc" id="flash_8c_html_a50301d8854326fa74b9383ce44365650"><div class="ttname"><a href="flash_8c.html#a50301d8854326fa74b9383ce44365650">GetPacketNrForAddress</a></div><div class="ttdeci">U4 GetPacketNrForAddress(const U4 Address, const U4 Base, const U4 PacketSize)</div><div class="ttdoc">Get the number of the packet for the given address. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00310">flash.c:310</a></div></div>
<div class="ttc" id="flash_8c_html_a7b8e5a1d47b072c4c567780f496a3600"><div class="ttname"><a href="flash_8c.html#a7b8e5a1d47b072c4c567780f496a3600">GetSectorNrForAddress</a></div><div class="ttdeci">I4 GetSectorNrForAddress(const U4 Address, const U4 Base, const U4 Offset, const BLOCK_ARR_pt pFlashdef)</div><div class="ttdoc">Get the sector number at address. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00255">flash.c:255</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a44471cd7b81bbd4002b58c1b4bcddf1d"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> updSendWrite </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>&#160;</td>
          <td class="paramname"><em>Packet</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Send one flash packet write command to the receiver.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>handler </td></tr>
    <tr><td class="paramname">Packet</td><td>packet number to be written </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if successful </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00057">57</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="types_8h_source.html#l00075">FALSE</a>, <a class="el" href="update_core_8h_source.html#l00074">UPD_CORE_t::FwBase</a>, <a class="el" href="update_core_8h_source.html#l00076">UPD_CORE_t::ImageSize</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8h_source.html#l00218">MSG_ERR</a>, <a class="el" href="types_8h_source.html#l00078">NULL</a>, <a class="el" href="update_core_8h_source.html#l00037">PACKETSIZE</a>, <a class="el" href="update_core_8h_source.html#l00075">UPD_CORE_t::pData</a>, <a class="el" href="receiver_8c_source.html#l00142">rcvSendMessage()</a>, <a class="el" href="update_core_8h_source.html#l00065">UPD_CORE_t::Rx</a>, <a class="el" href="ubxmsg_8h_source.html#l00107">UBX_CLASS_UPD</a>, and <a class="el" href="ubxmsg_8h_source.html#l00125">UBX_UPD_FLWRI</a>.</p>

<p>Referenced by <a class="el" href="update_core_8c_source.html#l00389">updWritePacket()</a>.</p>
<div class="fragment"><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;{</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> tgtAddr = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a> + Packet * <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>* srcAddr = (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ab132f60260d98f3837ddf20f52a60036">pData</a> + Packet * PACKETSIZE;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> WriteSize = PACKETSIZE;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    if (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9f06a0ef019cc68c0342c8ae6fab68c1">ImageSize</a> &lt; ((Packet+1) * PACKETSIZE))</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    {</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="comment">//the last packet can be a cut-off packet</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        WriteSize = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9f06a0ef019cc68c0342c8ae6fab68c1">ImageSize</a> - Packet * <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> PayloadLength = WriteSize + 8 <span class="comment">/*Addr, Size*/</span>;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* pSendData = (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>)*PayloadLength);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">if</span> (pSendData == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Alloc failed&quot;</span>);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    }</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    memset(pSendData, 0xFF, PayloadLength);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    memcpy(pSendData+0, &amp;tgtAddr,   4); <span class="comment">//Address</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    memcpy(pSendData+4, &amp;WriteSize, 4); <span class="comment">//Data size</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="comment">//copy data to send buffer</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    memcpy(pSendData+8, srcAddr, WriteSize);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> success = <a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">Rx</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235">UBX_UPD_FLWRI</a>, pSendData, PayloadLength);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    free(pSendData);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordflow">return</span> success;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;}</div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a></div><div class="ttdoc">Class update. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00107">ubxmsg.h:107</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ab132f60260d98f3837ddf20f52a60036"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ab132f60260d98f3837ddf20f52a60036">UPD_CORE_t::pData</a></div><div class="ttdeci">FWHEADER_t * pData</div><div class="ttdoc">pointer to the data to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00075">updateCore.h:75</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8h_html_a177e4581349927b04d81ac62ed804377"><div class="ttname"><a href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a></div><div class="ttdeci">#define PACKETSIZE</div><div class="ttdoc">size of a packet to send to the receiver </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00037">updateCore.h:37</a></div></div>
<div class="ttc" id="types_8h_html_a79199901c1122f5e17970b6887de3d6a"><div class="ttname"><a href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a></div><div class="ttdeci">unsigned __int8 U1</div><div class="ttdoc">8-bit unsigned integer number(unsigned character) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00058">types.h:58</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235">UBX_UPD_FLWRI</a></div><div class="ttdoc">Flash write (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00125">ubxmsg.h:125</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a></div><div class="ttdoc">Error message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00218">platform.h:218</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9f06a0ef019cc68c0342c8ae6fab68c1"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9f06a0ef019cc68c0342c8ae6fab68c1">UPD_CORE_t::ImageSize</a></div><div class="ttdeci">U4 ImageSize</div><div class="ttdoc">size of the image </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00076">updateCore.h:76</a></div></div>
<div class="ttc" id="receiver_8c_html_ae0a9b8dd16e773cc5ef09b6206e74580"><div class="ttname"><a href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a></div><div class="ttdeci">BOOL rcvSendMessage(RCV_DATA_t *rcv, U1 classId, U1 msgId, CH *payload, U4 payloadSize)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00142">receiver.c:142</a></div></div>
<div class="ttc" id="types_8h_html_a050c65e107f0c828f856a231f4b4e788"><div class="ttname"><a href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a></div><div class="ttdeci">int BOOL</div><div class="ttdoc">Boolean type. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00073">types.h:73</a></div></div>
<div class="ttc" id="types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdoc">Boolean FALSE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="types_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdoc">Null. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00078">types.h:78</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9478a793293df1813c4a42d7701a5156"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">UPD_CORE_t::Rx</a></div><div class="ttdeci">RCV_DATA_t * Rx</div><div class="ttdoc">receiver to communicate with </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00065">updateCore.h:65</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a76347d13c839ff2559595d6fead2d913"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">UPD_CORE_t::FwBase</a></div><div class="ttdeci">U4 FwBase</div><div class="ttdoc">start address of the firmware on the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00074">updateCore.h:74</a></div></div>
<div class="ttc" id="types_8h_html_a2d18590ee6cb00e8ea0a631cf9696f53"><div class="ttname"><a href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a></div><div class="ttdeci">char CH</div><div class="ttdoc">8-bit character, (signed/unsigned, depending on compiler) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00064">types.h:64</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a4c065d6b9a1ae76e08bde0a84ee898e7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> updUpdate </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="image_8h.html#a640c15684830a3ad6b5a2fc0bcacc54b">FWHEADER_t</a> *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>&#160;</td>
          <td class="paramname"><em>fwBase</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Do the update.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>control structure </td></tr>
    <tr><td class="paramname">data</td><td>pointer to the data to write </td></tr>
    <tr><td class="paramname">size</td><td>size of the data </td></tr>
    <tr><td class="paramname">fwBase</td><td>start address of the firmware on the flash </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if successful </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00578">578</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="update_core_8h_source.html#l00056">ACK_ERASE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00058">ACK_WRITE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00043">CHIP_ERASE_TIMEOUT</a>, <a class="el" href="update_core_8h_source.html#l00092">UPD_CORE_t::eraseInProgres</a>, <a class="el" href="types_8h_source.html#l00075">FALSE</a>, <a class="el" href="update_core_8h_source.html#l00074">UPD_CORE_t::FwBase</a>, <a class="el" href="update_core_8h_source.html#l00076">UPD_CORE_t::ImageSize</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8h_source.html#l00226">MSG_DBG</a>, <a class="el" href="platform_8h_source.html#l00218">MSG_ERR</a>, <a class="el" href="types_8h_source.html#l00078">NULL</a>, <a class="el" href="update_core_8h_source.html#l00067">UPD_CORE_t::NumberPackets</a>, <a class="el" href="update_core_8h_source.html#l00066">UPD_CORE_t::NumberSectors</a>, <a class="el" href="update_core_8h_source.html#l00075">UPD_CORE_t::pData</a>, <a class="el" href="update_core_8h_source.html#l00080">UPD_CORE_t::pEraseState</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, <a class="el" href="receiver_8c_source.html#l00232">rcvReceiveMessage()</a>, <a class="el" href="update_core_8h_source.html#l00065">UPD_CORE_t::Rx</a>, <a class="el" href="ubxmsg_8h_source.html#l00059">UBX_HEAD_s::size</a>, <a class="el" href="types_8h_source.html#l00076">TRUE</a>, <a class="el" href="ubxmsg_8h_source.html#l00107">UBX_CLASS_UPD</a>, <a class="el" href="ubxmsg_8h_source.html#l00097">UBX_HEAD_SIZE</a>, <a class="el" href="ubxmsg_8h_source.html#l00120">UBX_UPD_CERASE</a>, <a class="el" href="update_core_8c_source.html#l00099">updDumpAck()</a>, <a class="el" href="update_core_8c_source.html#l00311">updEraseSector()</a>, <a class="el" href="update_core_8c_source.html#l00191">updProcessMessages()</a>, and <a class="el" href="update_core_8c_source.html#l00389">updWritePacket()</a>.</p>

<p>Referenced by <a class="el" href="update_8c_source.html#l00308">UpdateFirmware()</a>.</p>
<div class="fragment"><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;{</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ab132f60260d98f3837ddf20f52a60036">pData</a> = data;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9f06a0ef019cc68c0342c8ae6fab68c1">ImageSize</a> = size;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">FwBase</a> = fwBase;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> writeComplete = (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a> == 0);</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> eraseComplete = (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a> == 0);</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="comment">// loop around until everything is written and erased</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordflow">while</span>( !writeComplete || !eraseComplete )</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="keywordflow">if</span>( !eraseComplete )</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        {</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            <span class="comment">// try to send an erase command</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            <span class="keywordflow">if</span>( !<a class="code" href="update_core_8c.html#ac873b58a11add9d97c598e7ec876c401">updEraseSector</a>(upd) )</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            <span class="comment">// receive messages</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;            <span class="keywordflow">if</span>( !<a class="code" href="update_core_8c.html#ae78c9293d678ee3e6a3d297800f579ed">updProcessMessages</a>(upd) )</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="comment">// check if everything is erased completely</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            eraseComplete = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> sector;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            <span class="keywordflow">for</span>(sector = 0; sector &lt; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">NumberSectors</a>; sector++)</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">pEraseState</a>[sector] != <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>)</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                {</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                    eraseComplete = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                }</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            }</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        }</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        <span class="keywordflow">if</span>( !writeComplete )</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;            <span class="comment">// try to send write command</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="update_core_8c.html#a4b205985db984dfcd40cf465d760cf75">updWritePacket</a>(upd))</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            {</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            }</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            <span class="comment">// receive messages</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            <span class="keywordflow">if</span>( !<a class="code" href="update_core_8c.html#ae78c9293d678ee3e6a3d297800f579ed">updProcessMessages</a>(upd) )</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            {</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            }</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            <span class="comment">// check if everything was written completely</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            writeComplete = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> pack;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">for</span>(pack = 0; pack &lt; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>; pack++)</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            {</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[pack] != <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a>)</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                    writeComplete = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                }</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            }</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        }</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    }</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <a class="code" href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a>(upd, <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">eraseInProgres</a>)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* cErase = <a class="code" href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a>(upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">Rx</a>, <a class="code" href="update_core_8h.html#a8818657501b169fe9289ed5d37e29b11">CHIP_ERASE_TIMEOUT</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9">UBX_UPD_CERASE</a>);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="keywordflow">if</span> (cErase == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        {</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Chip erase timed out&quot;</span>);</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        }</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <span class="keywordflow">if</span> (cErase-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> != 1)</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            <span class="keywordflow">if</span> (((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)cErase)[<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>] == 1)</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            {</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Chip erase finished later than update proces&quot;</span>);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            {</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Chip erase failed&quot;</span>);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            }</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        }</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    }</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;}</div>
<div class="ttc" id="update_core_8c_html_aadfd35bbc222f233164d22a25efb6fa2"><div class="ttname"><a href="update_core_8c.html#aadfd35bbc222f233164d22a25efb6fa2">updDumpAck</a></div><div class="ttdeci">static void updDumpAck(UPD_CORE_t *upd, BOOL force)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00099">updateCore.c:99</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a></div><div class="ttdoc">Class update. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00107">ubxmsg.h:107</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ab132f60260d98f3837ddf20f52a60036"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ab132f60260d98f3837ddf20f52a60036">UPD_CORE_t::pData</a></div><div class="ttdeci">FWHEADER_t * pData</div><div class="ttdoc">pointer to the data to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00075">updateCore.h:75</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8c_html_ac873b58a11add9d97c598e7ec876c401"><div class="ttname"><a href="update_core_8c.html#ac873b58a11add9d97c598e7ec876c401">updEraseSector</a></div><div class="ttdeci">static BOOL updEraseSector(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00311">updateCore.c:311</a></div></div>
<div class="ttc" id="types_8h_html_a79199901c1122f5e17970b6887de3d6a"><div class="ttname"><a href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a></div><div class="ttdeci">unsigned __int8 U1</div><div class="ttdoc">8-bit unsigned integer number(unsigned character) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00058">types.h:58</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9">UBX_UPD_CERASE</a></div><div class="ttdoc">Chip erase (NDA 15+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00120">ubxmsg.h:120</a></div></div>
<div class="ttc" id="update_core_8h_html_a8818657501b169fe9289ed5d37e29b11"><div class="ttname"><a href="update_core_8h.html#a8818657501b169fe9289ed5d37e29b11">CHIP_ERASE_TIMEOUT</a></div><div class="ttdeci">#define CHIP_ERASE_TIMEOUT</div><div class="ttdoc">chip erase timeout </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00043">updateCore.h:43</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a></div><div class="ttdoc">Error message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00218">platform.h:218</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9f06a0ef019cc68c0342c8ae6fab68c1"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9f06a0ef019cc68c0342c8ae6fab68c1">UPD_CORE_t::ImageSize</a></div><div class="ttdeci">U4 ImageSize</div><div class="ttdoc">size of the image </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00076">updateCore.h:76</a></div></div>
<div class="ttc" id="receiver_8c_html_a02c74cd7d3d7df99a9d5abb45cfb5a58"><div class="ttname"><a href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a></div><div class="ttdeci">UBX_HEAD_t * rcvReceiveMessage(RCV_DATA_t *rcv, U4 timeout, I4 classId, I4 msgId)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00232">receiver.c:232</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="types_8h_html_a050c65e107f0c828f856a231f4b4e788"><div class="ttname"><a href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a></div><div class="ttdeci">int BOOL</div><div class="ttdoc">Boolean type. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00073">types.h:73</a></div></div>
<div class="ttc" id="types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdoc">Boolean FALSE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9ad3d588fe8597bb6723181b77e02cfe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">UPD_CORE_t::NumberPackets</a></div><div class="ttdeci">I4 NumberPackets</div><div class="ttdoc">number of packets to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00067">updateCore.h:67</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_af4892b3558ebdfb2c651670dee779d06"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">UPD_CORE_t::eraseInProgres</a></div><div class="ttdeci">BOOL eraseInProgres</div><div class="ttdoc">Erase in progress. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00092">updateCore.h:92</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a74708b0ccc127688f33a7c26cf46d587"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a74708b0ccc127688f33a7c26cf46d587">UPD_CORE_t::NumberSectors</a></div><div class="ttdeci">I4 NumberSectors</div><div class="ttdoc">number of sectors to erase </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00066">updateCore.h:66</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a></div><div class="ttdoc">erase acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00056">updateCore.h:56</a></div></div>
<div class="ttc" id="update_core_8c_html_ae78c9293d678ee3e6a3d297800f579ed"><div class="ttname"><a href="update_core_8c.html#ae78c9293d678ee3e6a3d297800f579ed">updProcessMessages</a></div><div class="ttdeci">static BOOL updProcessMessages(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00191">updateCore.c:191</a></div></div>
<div class="ttc" id="types_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdoc">Null. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00078">types.h:78</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_s</a></div><div class="ttdoc">UBX Protocol Header. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00054">ubxmsg.h:54</a></div></div>
<div class="ttc" id="types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdoc">Boolean TRUE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00076">types.h:76</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9478a793293df1813c4a42d7701a5156"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9478a793293df1813c4a42d7701a5156">UPD_CORE_t::Rx</a></div><div class="ttdeci">RCV_DATA_t * Rx</div><div class="ttdoc">receiver to communicate with </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00065">updateCore.h:65</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a></div><div class="ttdoc">Debug message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00226">platform.h:226</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a5a802d4c63ef065926e9508383f43e3d"><div class="ttname"><a href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a></div><div class="ttdeci">#define UBX_HEAD_SIZE</div><div class="ttdoc">UBX Protocol Header Size. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00097">ubxmsg.h:97</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a76347d13c839ff2559595d6fead2d913"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a76347d13c839ff2559595d6fead2d913">UPD_CORE_t::FwBase</a></div><div class="ttdeci">U4 FwBase</div><div class="ttdoc">start address of the firmware on the flash </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00074">updateCore.h:74</a></div></div>
<div class="ttc" id="update_core_8c_html_a4b205985db984dfcd40cf465d760cf75"><div class="ttname"><a href="update_core_8c.html#a4b205985db984dfcd40cf465d760cf75">updWritePacket</a></div><div class="ttdeci">static BOOL updWritePacket(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00389">updateCore.c:389</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_ae148b3ac6b191b570ebae852b8d09779"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#ae148b3ac6b191b570ebae852b8d09779">UPD_CORE_t::pEraseState</a></div><div class="ttdeci">CH * pEraseState</div><div class="ttdoc">array to store erase status for the to be erased sectors </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00080">updateCore.h:80</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a></div><div class="ttdoc">write acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00058">updateCore.h:58</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html_aa89eeea608ab09a8ba70d5b92e641f30"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">UBX_HEAD_s::size</a></div><div class="ttdeci">U2 size</div><div class="ttdoc">Payload Size. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00059">ubxmsg.h:59</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a4b205985db984dfcd40cf465d760cf75"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> updWritePacket </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *&#160;</td>
          <td class="paramname"><em>upd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Send one flash write packet command to the receiver (calls updSendWrite). Either a new write command or a write command for a packet with expired timeout is sent.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">upd</td><td>handler </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if successful </dd></dl>

<p>Definition at line <a class="el" href="update_core_8c_source.html#l00389">389</a> of file <a class="el" href="update_core_8c_source.html">updateCore.c</a>.</p>

<p>References <a class="el" href="update_core_8h_source.html#l00056">ACK_ERASE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00058">ACK_WRITE_ACK</a>, <a class="el" href="update_core_8h_source.html#l00057">ACK_WRITE_SENT</a>, <a class="el" href="update_core_8c_source.html#l00045">CanSendParentCommands()</a>, <a class="el" href="update_core_8h_source.html#l00043">CHIP_ERASE_TIMEOUT</a>, <a class="el" href="update_core_8h_source.html#l00092">UPD_CORE_t::eraseInProgres</a>, <a class="el" href="types_8h_source.html#l00075">FALSE</a>, <a class="el" href="update_core_8h_source.html#l00091">UPD_CORE_t::MaxPendingWritesNum</a>, <a class="el" href="platform_8c_source.html#l01992">MESSAGE()</a>, <a class="el" href="platform_8c_source.html#l01971">MESSAGE_PLAIN()</a>, <a class="el" href="platform_8h_source.html#l00218">MSG_ERR</a>, <a class="el" href="update_core_8h_source.html#l00067">UPD_CORE_t::NumberPackets</a>, <a class="el" href="update_core_8h_source.html#l00087">UPD_CORE_t::PendingWrites</a>, <a class="el" href="update_core_8h_source.html#l00083">UPD_CORE_t::pWriteRetryCnt</a>, <a class="el" href="update_core_8h_source.html#l00084">UPD_CORE_t::pWriteState</a>, <a class="el" href="update_core_8h_source.html#l00082">UPD_CORE_t::pWriteTimeout</a>, <a class="el" href="platform_8c_source.html#l00129">TIME_GET()</a>, <a class="el" href="types_8h_source.html#l00076">TRUE</a>, <a class="el" href="update_core_8c_source.html#l00057">updSendWrite()</a>, <a class="el" href="update_core_8h_source.html#l00041">WRITE_RETRIES</a>, <a class="el" href="update_core_8h_source.html#l00042">WRITE_TIMEOUT</a>, and <a class="el" href="update_core_8h_source.html#l00068">UPD_CORE_t::writtenUntil</a>.</p>

<p>Referenced by <a class="el" href="update_core_8c_source.html#l00578">updUpdate()</a>.</p>
<div class="fragment"><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;{</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    assert(upd);</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="comment">//check each packet</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> timeout = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">eraseInProgres</a> ? <a class="code" href="update_core_8h.html#a8818657501b169fe9289ed5d37e29b11">CHIP_ERASE_TIMEOUT</a> : <a class="code" href="update_core_8h.html#a3af75bd8417b347229705d6d522ad5c3">WRITE_TIMEOUT</a>;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> packet = upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a6ff39625defb3d08d5991949c4f64696">writtenUntil</a>;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> foundLastWritten = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> sent = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="comment">// send the not yet sent write packets</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="comment">// don&#39;t overflow the receiver</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordflow">while</span> (packet &lt; upd-&gt;NumberPackets &amp;&amp; !sent &amp;&amp; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a> &lt; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a1cbc5b9d688c2a8ce86eea878c111500">MaxPendingWritesNum</a>)</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    {</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="comment">// check for written packets</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">if</span>( upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packet] == <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a> &amp;&amp; !foundLastWritten )</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a6ff39625defb3d08d5991949c4f64696">writtenUntil</a> = packet+1;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        {</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            foundLastWritten = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            <span class="comment">// check for unwritten packets</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packet] == <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a>)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;            {</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <span class="comment">// send the download packet to receiver</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packet] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230">ACK_WRITE_SENT</a>;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a44471cd7b81bbd4002b58c1b4bcddf1d">updSendWrite</a>(upd, packet))</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>++;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a>[packet] = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() + timeout;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                    sent = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">//do not send further packets in this loop</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a>(upd))</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                    {</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;&lt;INF&gt;WRITE %i %i&lt;\\INF&gt;&quot;</span>, packet, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                    }</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                }</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;SendWrite failed.&quot;</span>);</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                }</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;            }</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        }</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        packet++;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    }</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">// send the timeouted write packets</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    packet = 0;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">while</span> (packet &lt; upd-&gt;NumberPackets &amp;&amp; !sent)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    {</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> acttime = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>();</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="comment">// check for timeouted packets</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packet]    == <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230">ACK_WRITE_SENT</a> &amp;&amp;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a>[packet]  &lt;= acttime)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>)</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            {</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                --upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            }</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a>[packet]++;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">pWriteRetryCnt</a>[packet] &gt; <a class="code" href="update_core_8h.html#a5b1cd04a426238a3a30f7740e6b539de">WRITE_RETRIES</a>)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            {</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Write retries for packet %d exceeded.&quot;</span>, packet);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            }</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <span class="keywordflow">if</span> (upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a> &lt; upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a1cbc5b9d688c2a8ce86eea878c111500">MaxPendingWritesNum</a>)</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            {</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                <span class="comment">// send the download packet to receiver</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">pWriteState</a>[packet] = <a class="code" href="update_core_8h.html#a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230">ACK_WRITE_SENT</a>;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a44471cd7b81bbd4002b58c1b4bcddf1d">updSendWrite</a>(upd, packet))</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">PendingWrites</a>++;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                    upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">pWriteTimeout</a>[packet] = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() + timeout;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                    sent = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">//do not send further packets in this loop</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a>(upd))</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                    {</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                        <a class="code" href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a>(<span class="stringliteral">&quot;&lt;INF&gt;WRITE_AGAIN %i %i&lt;\\INF&gt;&quot;</span>, packet, upd-&gt;<a class="code" href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">NumberPackets</a>);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                    }</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                }</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                {</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;SendWrite failed.&quot;</span>);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            }</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        }</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        packet++;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    }</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;}</div>
<div class="ttc" id="update_core_8c_html_a44471cd7b81bbd4002b58c1b4bcddf1d"><div class="ttname"><a href="update_core_8c.html#a44471cd7b81bbd4002b58c1b4bcddf1d">updSendWrite</a></div><div class="ttdeci">static BOOL updSendWrite(UPD_CORE_t *upd, U4 Packet)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00057">updateCore.c:57</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_acfc1f7f83dd9db1b09ba2a599c51e033"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#acfc1f7f83dd9db1b09ba2a599c51e033">UPD_CORE_t::pWriteState</a></div><div class="ttdeci">CH * pWriteState</div><div class="ttdoc">array to store erase status for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00084">updateCore.h:84</a></div></div>
<div class="ttc" id="platform_8c_html_a3de0e43e9e5e923270a3fa4e6a2649fd"><div class="ttname"><a href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a></div><div class="ttdeci">U4 TIME_GET(void)</div><div class="ttdoc">Get Timer. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00129">platform.c:129</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a048cc8432729da4d1c3d534ea76bda31"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a048cc8432729da4d1c3d534ea76bda31">UPD_CORE_t::pWriteRetryCnt</a></div><div class="ttdeci">U1 * pWriteRetryCnt</div><div class="ttdoc">array to store retry counts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00083">updateCore.h:83</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="update_core_8h_html_a5b1cd04a426238a3a30f7740e6b539de"><div class="ttname"><a href="update_core_8h.html#a5b1cd04a426238a3a30f7740e6b539de">WRITE_RETRIES</a></div><div class="ttdeci">#define WRITE_RETRIES</div><div class="ttdoc">number of retries to write block </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00041">updateCore.h:41</a></div></div>
<div class="ttc" id="platform_8c_html_a591fafe6c761800ebd98e966554b06c8"><div class="ttname"><a href="platform_8c.html#a591fafe6c761800ebd98e966554b06c8">MESSAGE_PLAIN</a></div><div class="ttdeci">void MESSAGE_PLAIN(const CH *format,...)</div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01971">platform.c:1971</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a6ff39625defb3d08d5991949c4f64696"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a6ff39625defb3d08d5991949c4f64696">UPD_CORE_t::writtenUntil</a></div><div class="ttdeci">I4 writtenUntil</div><div class="ttdoc">used to optimize the write loop </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00068">updateCore.h:68</a></div></div>
<div class="ttc" id="update_core_8h_html_a8818657501b169fe9289ed5d37e29b11"><div class="ttname"><a href="update_core_8h.html#a8818657501b169fe9289ed5d37e29b11">CHIP_ERASE_TIMEOUT</a></div><div class="ttdeci">#define CHIP_ERASE_TIMEOUT</div><div class="ttdoc">chip erase timeout </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00043">updateCore.h:43</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a73a8daa07d3bbd09ad1b996c032d38fe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a73a8daa07d3bbd09ad1b996c032d38fe">UPD_CORE_t::pWriteTimeout</a></div><div class="ttdeci">U4 * pWriteTimeout</div><div class="ttdoc">array to store timeouts for the to be written packets </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00082">updateCore.h:82</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a></div><div class="ttdoc">Error message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00218">platform.h:218</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="types_8h_html_a050c65e107f0c828f856a231f4b4e788"><div class="ttname"><a href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a></div><div class="ttdeci">int BOOL</div><div class="ttdoc">Boolean type. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00073">types.h:73</a></div></div>
<div class="ttc" id="types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdoc">Boolean FALSE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a9ad3d588fe8597bb6723181b77e02cfe"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a9ad3d588fe8597bb6723181b77e02cfe">UPD_CORE_t::NumberPackets</a></div><div class="ttdeci">I4 NumberPackets</div><div class="ttdoc">number of packets to write </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00067">updateCore.h:67</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_af4892b3558ebdfb2c651670dee779d06"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#af4892b3558ebdfb2c651670dee779d06">UPD_CORE_t::eraseInProgres</a></div><div class="ttdeci">BOOL eraseInProgres</div><div class="ttdoc">Erase in progress. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00092">updateCore.h:92</a></div></div>
<div class="ttc" id="update_core_8c_html_a9ec6c85cab067c9beeadbc0119e05211"><div class="ttname"><a href="update_core_8c.html#a9ec6c85cab067c9beeadbc0119e05211">CanSendParentCommands</a></div><div class="ttdeci">static BOOL CanSendParentCommands(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00045">updateCore.c:45</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a4ce2f66cb1c020ab5111c98a48c1509a">ACK_ERASE_ACK</a></div><div class="ttdoc">erase acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00056">updateCore.h:56</a></div></div>
<div class="ttc" id="types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdoc">Boolean TRUE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00076">types.h:76</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a1cbc5b9d688c2a8ce86eea878c111500"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a1cbc5b9d688c2a8ce86eea878c111500">UPD_CORE_t::MaxPendingWritesNum</a></div><div class="ttdeci">U4 MaxPendingWritesNum</div><div class="ttdoc">max number of which can be queued in the receiver writes pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00091">updateCore.h:91</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39ab2a41f9c9b0daa6582fdfcbdd0d1b2d0">ACK_WRITE_ACK</a></div><div class="ttdoc">write acknowledged for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00058">updateCore.h:58</a></div></div>
<div class="ttc" id="update_core_8h_html_a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230"><div class="ttname"><a href="update_core_8h.html#a130a626da56d697af470eccd12259c39a975bfb38aec53817024f7a6e6dc67230">ACK_WRITE_SENT</a></div><div class="ttdoc">write pending for packet </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00057">updateCore.h:57</a></div></div>
<div class="ttc" id="update_core_8h_html_a3af75bd8417b347229705d6d522ad5c3"><div class="ttname"><a href="update_core_8h.html#a3af75bd8417b347229705d6d522ad5c3">WRITE_TIMEOUT</a></div><div class="ttdeci">#define WRITE_TIMEOUT</div><div class="ttdoc">timeout for writing a block </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00042">updateCore.h:42</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html_a0bcb4d97e337d93937d3be604776ed8f"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html#a0bcb4d97e337d93937d3be604776ed8f">UPD_CORE_t::PendingWrites</a></div><div class="ttdeci">U4 PendingWrites</div><div class="ttdoc">number of writes pending </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00087">updateCore.h:87</a></div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="update_core_8c.html">updateCore.c</a></li>
    <li class="footer">Generated on Sun May 23 2021 19:02:48 for ubxfwupdate by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
