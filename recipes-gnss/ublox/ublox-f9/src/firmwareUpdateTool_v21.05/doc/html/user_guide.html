<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>ubxfwupdate: User Guide For Example Application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="u-blox_logo_09.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ubxfwupdate
   &#160;<span id="projectnumber">21.05</span>
   </div>
   <div id="projectbrief">Firmware Update Tool Documentation &mdash; Copyright (c) 2015 u-blox AG.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('user_guide.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">User Guide For Example Application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="userGuideIntroduction"></a>
Introduction</h1>
<p>This application note provides a reference for customers to implement</p><ul>
<li>A standalone application as a firmware update tool</li>
<li>Or a similar partial functionality of an integrated development/evaluation environment.</li>
</ul>
<p>In order to speed up the implementation, the source code can be compiled out of the box under Windows and Linux. Note that if a different target OS is required, the code needs to be ported to the target platform by creating platform specific functions and type definitions (see <a class="el" href="platform_8c.html" title="Platform abstraction layer. ">platform.c</a>). This document explains the functions in <a class="el" href="main_8c.html" title="Firmware Update Sample Application for u-blox 5 onward. ">main.c</a> as well as key functions called to describe the general firmware update steps.</p>
<h1><a class="anchor" id="firmwareUpdateSequence"></a>
Firmware Update Sequence</h1>
<h2><a class="anchor" id="updateSequenceOverview"></a>
Overview</h2>
<p>Following the <a class="el" href="main_8c.html" title="Firmware Update Sample Application for u-blox 5 onward. ">main.c</a>, the firmware update procedure looks like the following.</p>
 <div class="image">
<img src="main.png" alt="main.png"/>
<div class="caption">
Firmware Update Overview</div></div>
<p>  
The diagram can be found as a PDF file under <a href="main.pdf">main.pdf</a>.
</p>
<p>From the figure above, the steps in brief are</p><ul>
<li>Receive user's input as command line arguments.</li>
<li>Check argument validity.</li>
<li>Fill arguments into specific data structure.</li>
<li>Initialize platform output stream for debugging or status of writing progress.</li>
<li>Do the firmware update.</li>
<li>Clean memory and resource reserved by the application.</li>
<li>Check the success of the update.</li>
<li>Report the FAIL or SUCCEED.</li>
</ul>
<p>The figure above omits the details about the key function called from <a class="el" href="main_8c.html#a0ddf1224851353fc92bfbff6f499fa97" title="Program entry. ">main()</a>, e.g. <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a>, which will be reviewed deeply later.</p>
<h2><a class="anchor" id="updateOptions"></a>
Command line arguments</h2>
<p>As previously mentioned, the <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a> function implements the main logic for the firmware update. Looking at its declaration in <a class="el" href="update_8h.html" title="Firmware update process for u-blox 5/6. ">update.h</a>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="update_8c.html#a91fe63423c374194e5090f96e17064a6">UpdateFirmware</a>(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          BinaryFileName,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          FlashDefFileName,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          FisFileName,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          ComPort,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   Baudrate,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   BaudrateSafe,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   BaudrateUpd,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           DoSafeBoot,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           DoReset,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           DoAutobaud,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>       <span class="keywordtype">bool</span>           CheckUpdateNeeded,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           EraseWholeFlash,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           EraseOnly,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           TrainingSequence,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           doChipErase,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">int</span>            Verbose,</div>
<div class="line">                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">bool</span>           fisOnly);</div>
</div><!-- fragment --><p>The calling function needs to provide the required arguments to <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a>. There are two ways to initialize the options list depending on different use cases, for instance,</p><ul>
<li>Take one or several options from the command line arguments.</li>
<li>Take the default values.</li>
</ul>
<p>In the example code, the first mentioned method is utilized. One data structure is defined in <a class="el" href="main_8c.html" title="Firmware Update Sample Application for u-blox 5 onward. ">main.c</a> to handle the option list, e.g. <a class="el" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html" title="Command line arguments. ">CL_ARGUMENTS_s</a> by reading and parsing the command-line arguments,</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html">CL_ARGUMENTS_s</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>*     <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a765c11d2930c7c1dd273cc67540baf1e">BinaryFileName</a>;     <span class="comment">//!&lt; Filename of binary firmware image</span></div>
<div class="line"><span class="comment"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span>*     <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#acb54f173c9d5159a0e40ae14f4d1e457">FlashDefFileName</a>;   <span class="comment">//!&lt; Filename of flash definition file</span></div>
<div class="line"><span class="comment"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span>*     <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a66f3f7939e16241b277fd64aa08339db">FisFileName</a>;        <span class="comment">//!&lt; Filename of the FIS file</span></div>
<div class="line"><span class="comment"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span>*     <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a8441557a020a1796a2c9e890cfaee4fe">ComPort</a>;            <span class="comment">//!&lt; COM port name</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a87d3dbff33161c0c227bee873167c15c">Baudrate</a>;           <span class="comment">//!&lt; Baudrate for serial port (commanding to safeboot)</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a6e06c4671f3f707a059df58cba55bc51">BaudrateSafe</a>;       <span class="comment">//!&lt; Baudrate for serial port (after starting safeboot)</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a4d4619d431bd66b8a984b8d85baabe28">BaudrateUpd</a>;        <span class="comment">//!&lt; Baudrate for serial port (performing update)</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#ac31ca5e9cb3548a8a420c062a04b380b">DoSafeBoot</a>;         <span class="comment">//!&lt; Command safeboot start before update</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#adfd477de102fd50469047b760714d24d">DoReset</a>;            <span class="comment">//!&lt; Reset receiver after FW update</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">int</span>             <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a41158e3b0127426620e89a67e6d20808">Verbose</a>;            <span class="comment">//!&lt; Verbose mode</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a0771396b98e01c4687e1fe99a3e98c4b">Autobaud</a>;           <span class="comment">//!&lt; Autobaud on safeboot identification</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            CheckUpdateNeeded;  <span class="comment">//!&lt; Check if update needed at all</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a71ebabac5763550d38dbbb215274937a">EraseWholeFlash</a>;    <span class="comment">//!&lt; Erase whole flash (always set to 1)</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a46a07eabbc37e495d5f9eadf7b7184eb">EraseOnly</a>;          <span class="comment">//!&lt; Perform only erase operation</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a79f9bca48fa4533eaac5a3238327b3dc">TrainingSequence</a>;   <span class="comment">//!&lt; Training sequence</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a019b457b723869bce1c0701b1ab4b217">fisOnly</a>;            <span class="comment">//!&lt; Programm only the FIS image to the flash device</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">bool</span>            <a class="code" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a6319b383cb39743e21bbcb9c57cd2546">chipErase</a>;          <span class="comment">//!&lt; Do a chip erase instead of sector erases</span></div>
<div class="line"><span class="comment"></span>} <a class="code" href="main_8c.html#a75cffd56eefa0719d13f5bafc4ceb005">CL_ARGUMENTS_t</a>;</div>
</div><!-- fragment --><p>The caller of <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a> is responsible to check the validity of the update options, if necessary to provide help functionality to end users.</p>
<h2><a class="anchor" id="updatePlatformSpecific"></a>
Platform Specific Initialization And Cleanup</h2>
<p>Depending on different software environments, the targeted application is standalone and needs to handle platform specific initialization and necessary cleanup for used system resource at the end by calling functions defined in <a class="el" href="platform_8h.html" title="Defines and Prototypes for platform specifics. ">platform.h</a>. Additionally, if the target software environment is other than Windows or Linux, modifying or even rewriting <a class="el" href="platform_8h.html" title="Defines and Prototypes for platform specifics. ">platform.h</a> / <a class="el" href="platform_8c.html" title="Platform abstraction layer. ">platform.c</a> has to be considered for certain platform-dependent functions.</p>
<h2><a class="anchor" id="updateFirmware"></a>
Firmware Update</h2>
<p>The core of the update algorithm is managed by the <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a> function which is defined in <a class="el" href="update_8h.html" title="Firmware update process for u-blox 5/6. ">update.h</a>. The following figure is showing in details the flow of <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a>.</p>
 <div class="image">
<img src="UpdateFirmware.png" alt="UpdateFirmware.png"/>
<div class="caption">
FirmwareUpdate flowchart</div></div>
<p>  
The diagram can be found as a PDF file under <a href="UpdateFirmware.pdf">UpdateFirmware.pdf</a>.
</p>
<p>The general steps can be summary as:</p><ol type="1">
<li>Validate the provided firmware image.</li>
<li>Check if the provided firmware image is compatible with the target receiver module and ROM.</li>
<li>Check if an update is needed.</li>
<li>Identify the flash loader.</li>
<li>Stop the receiver.</li>
<li>Detect flash manufacturer and flash ID.</li>
<li>Merge the FIS information into the firmware and further check if update is needed.</li>
<li>Erase and write sectors.</li>
<li>Verify if writing image is correct.</li>
<li>Update new magic word and marker to flash.</li>
<li>Restart receiver.</li>
<li>Cleanup all reserved resource.</li>
</ol>
<h3><a class="anchor" id="updateValidate"></a>
Validate Firmware Image</h3>
<p>Normally, the file name of firmware image is provided by the end user as an input argument.</p>
<p>The function <a class="el" href="image_8c.html#ab59ad229220ddf25bcbea31620cb59fd" title="Open file and buffer it in RAM. ">OpenAndBufferFile()</a> declared in <a class="el" href="image_8h.html" title="Definitions concerning the firmware image. ">image.h</a> is called to open the image file and allocates memory according to the size of the file. After the file content is copied into the reserved memory the file handler is closed.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="image_8c.html#ab59ad229220ddf25bcbea31620cb59fd">OpenAndBufferFile</a>(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>  <span class="keyword">const</span> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*    BinaryFileName,</div>
<div class="line">                       <a class="code" href="types_8h.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a>** ppFileContent,</div>
<div class="line">                       <a class="code" href="types_8h.html#aec78e7a9e90a406a56f859ee456e8eae">OUT</a> <span class="keywordtype">size_t</span>*      pFileSize);</div>
</div><!-- fragment --><p>The function <a class="el" href="image_8c.html#a9e7479197d9de9e51a74f08602d762d5" title="Validate firmware image. ">ValidateImage()</a> declared in <a class="el" href="image_8h.html" title="Definitions concerning the firmware image. ">image.h</a> validates the image content existing in memory by checking:</p><ul>
<li>Image size</li>
<li>Header / Magic word</li>
<li>CRC</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="image_8c.html#a9e7479197d9de9e51a74f08602d762d5">ValidateImage</a>(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a> <span class="keyword">const</span> *pImage,</div>
<div class="line">                   <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">size_t</span>      ImageSize,</div>
<div class="line">                   <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*               verString,</div>
<div class="line">                   <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keywordtype">size_t</span>            verSize);</div>
</div><!-- fragment --><p><a class="el" href="image_8c.html#a9e7479197d9de9e51a74f08602d762d5" title="Validate firmware image. ">ValidateImage()</a> extracts additional information for later use, e.g. the ROM version the firmware was built for.</p>
<h3><a class="anchor" id="updateCompatibility"></a>
Firmware Image Compatibility with Target Receiver and ROM</h3>
<p>Hardware information, like ROM size, ROM CRC, ROM version needs to be polled from the connected receiver at the proper baud rate through functions defined in the class Receiver (<a class="el" href="receiver_8h.html" title="Declares the receiver communication interface. ">receiver.h</a> / <a class="el" href="receiver_8c.html" title="Implements the receiver communication interface. ">receiver.c</a>),</p>
<div class="fragment"><div class="line"><a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* pollMessageOnce(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> classId,</div>
<div class="line">                            <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> msgId,</div>
<div class="line">                            <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* payload,</div>
<div class="line">                            <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payloadSize,</div>
<div class="line">                            <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> timeout);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> sendMessage(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> classId,</div>
<div class="line">                 <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> msgId,</div>
<div class="line">                 <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* payload = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line">                 <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payloadSize = 0);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* pollMessage(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> classId,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> msgId,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* payload = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payloadSize = 0,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> timeout = <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* doAutobaud(<span class="keywordtype">bool</span> sendTrainingSequence);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> setBaud(<span class="keywordtype">int</span> baud);</div>
<div class="line"></div>
<div class="line">...</div>
</div><!-- fragment --><p>The polled hardware information is used to check the image's compatibility with the target receiver.</p>
<h3><a class="anchor" id="updateIdentifyLoader"></a>
Identify Flash Loader</h3>
<p>The flash loader needs to be identified for starting properly. Furthermore, the flash manufacturer ID and the device ID are detected and stored for later use. This is handled by member functions of the class Receiver through sending commands to the receiver.</p>
<div class="fragment"><div class="line"><a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* pollMessage(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> classId,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> msgId,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* payload = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payloadSize = 0,</div>
<div class="line">                        <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> timeout = <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> ackMessage(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> classId,</div>
<div class="line">               <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> msgId,</div>
<div class="line">               <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* payload = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div>
<div class="line">               <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payloadSize = 0,</div>
<div class="line">               <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> timeout = <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
</div><!-- fragment --><h3><a class="anchor" id="updateFisMerging"></a>
FIS Merging</h3>
<p>A file containing the flash memory architecture descriptions (Flash Information Structure (FIS)) is provided to <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a> as an argument. This comes as a XML file for u-blox generation 7 and M8 receiver modules. <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a> function calls a sub-function <a class="el" href="flash_8c.html#a5702805837058c6c3f8f51c0300d309e" title="Parse a file for flash memory architecture descriptions. ">GetFlashOrganisation()</a> declared in <a class="el" href="flash_8h.html" title="Flash organization stuff. ">flash.h</a> to load and merge the flash memory information into firmware image binary.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="flash_8c.html#a5702805837058c6c3f8f51c0300d309e">GetFlashOrganisation</a>(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>    <a class="code" href="types_8h.html#ac82fb958e48c78b4698b16a3c4bd745f">U2</a> <span class="keyword">const</span> ManId,</div>
<div class="line">                          <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>    <a class="code" href="types_8h.html#ac82fb958e48c78b4698b16a3c4bd745f">U2</a> <span class="keyword">const</span> DevId,</div>
<div class="line">                          <a class="code" href="types_8h.html#a62766f3ea8784d1db62df989f8f33d2d">INOUT</a> std::vector&lt;BLOCK_DEF_t&gt;* pBlocks,</div>
<div class="line">                          <a class="code" href="types_8h.html#a62766f3ea8784d1db62df989f8f33d2d">INOUT</a> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>* <span class="keyword">const</span> pSize,</div>
<div class="line">                          <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>    <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> <span class="keyword">const</span> * <span class="keyword">const</span> Filename);</div>
</div><!-- fragment --><h3><a class="anchor" id="updateImageUpdate"></a>
Firmware Image Update</h3>
<p>The receiver is then configured to the desired baud rate to update the firmware (<a class="el" href="struct_c_l___a_r_g_u_m_e_n_t_s__s.html#a4d4619d431bd66b8a984b8d85baabe28" title="Baudrate for serial port (performing update) ">CL_ARGUMENTS_s::BaudrateUpd</a>). According on the erase options, the erase method can be</p><ul>
<li>Chip Erase</li>
<li>Whole Flash Erase / Erase all sectors</li>
<li>Erase only pointed sectors</li>
</ul>
<p>The first option is done by sending commands to receiver directly. The remaining options are managed by the function <a class="el" href="flash_8c.html#a9ed55186a41b2a1bc2627838698bd56e" title="Get the number of sectors the firmware fits in. ">GetSectorNrForSize()</a> defined in <a class="el" href="flash_8h.html" title="Flash organization stuff. ">flash.h</a>, and member function update() of class UpdateCore (defined in <a class="el" href="update_core_8h.html" title="Declaration of function that handle the update on the receiver. ">updateCore.h</a>).</p>
<div class="fragment"><div class="line"><a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> <a class="code" href="flash_8c.html#a9ed55186a41b2a1bc2627838698bd56e">GetSectorNrForSize</a>(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> Offset,</div>
<div class="line">                      <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> FwSize,</div>
<div class="line">                      <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> std::vector&lt;BLOCK_DEF_t&gt;* pFlashdef);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">UpdateCore(Receiver *rx,</div>
<div class="line">           <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numberSectors,</div>
<div class="line">           <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numberPackets,</div>
<div class="line">           std::vector&lt;BLOCK_DEF_t&gt; *flashOrg,</div>
<div class="line">           <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> flashSize);</div>
</div><!-- fragment --><p>At the end of <a class="el" href="update_8c.html#a91fe63423c374194e5090f96e17064a6" title="Perform Firmware update process. ">UpdateFirmware()</a>, the written firmware image is verified by checking and comparing the CRC of the image in buffer and the written one in the receiver. If the firmware was written correctly, the new magic word and marker are rewritten to flash. The receiver is reset and started for the first booting after firmware update. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun May 23 2021 19:02:48 for ubxfwupdate by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
