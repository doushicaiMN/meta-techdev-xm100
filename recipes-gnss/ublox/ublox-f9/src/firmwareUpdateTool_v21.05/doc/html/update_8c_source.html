<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>ubxfwupdate: update.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="u-blox_logo_09.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ubxfwupdate
   &#160;<span id="projectnumber">21.05</span>
   </div>
   <div id="projectbrief">Firmware Update Tool Documentation &mdash; Copyright (c) 2015 u-blox AG.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('update_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">update.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="update_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*******************************************************************************</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Copyright (C) u-blox AG</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * u-blox AG, Thalwil, Switzerland</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * All rights reserved.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * Permission to use, copy, modify, and distribute this software for any</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * purpose without fee is hereby granted, provided that this entire notice</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * is included in all copies of any software which is or includes a copy</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * or modification of this software and in all copies of the supporting</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * documentation for such software.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * THIS SOFTWARE IS BEING PROVIDED &quot;AS IS&quot;, WITHOUT ANY EXPRESS OR IMPLIED</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * WARRANTY. IN PARTICULAR, NEITHER THE AUTHOR NOR U-BLOX MAKES ANY</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> *******************************************************************************</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * Project: firmwareUpdateTool v21.05</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * Purpose: Provide sample code to do a FW update</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> ******************************************************************************/</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">/*!</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">  \file</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">  \brief  Firmware update process</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">  This is the core of the firmware update which specifies the update procedure.</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">  \note If the receiver has ROM version 03 or 04 AND it is directly</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">  connected to and communicating with the host via USB (no USB-hub in between),</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">  this update process will not work as stated below. If you use such a setup and</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">  need to implement the update for ROM03 on your own, please contact the support</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">  at u-blox to receive further information on this task.</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">  Note that this is only necessary for ROM03. From ROM04 on the process can be</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">  implemented as it is stated below in the example code.</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &lt;assert.h&gt;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;limits.h&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="platform_8h.html">platform.h</a>&quot;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="update_8h.html">update.h</a>&quot;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="image_8h.html">image.h</a>&quot;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="flash_8h.html">flash.h</a>&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="mergefis_8h.html">mergefis.h</a>&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="version_8h.html">version.h</a>&quot;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="update_core_8h.html">updateCore.h</a>&quot;</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="checksum_8h.html">checksum.h</a>&quot;</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="update_8c.html#a0792eb6101efca31a477332c44b335f3">   59</a></span>&#160;<span class="preprocessor">#define HW_IMG_MAGIC_DOM    ( (&#39;U&#39; &lt;&lt;  0) | (&#39;B&#39; &lt;&lt;  8) | (&#39;X&#39; &lt;&lt; 16) | (&#39;8&#39; &lt;&lt; 24) ) </span><span class="comment">//!&lt; EXT image magic word for DOM</span></div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="update_8c.html#af1d2a705ba4ac692befd90b25f146925">   60</a></span>&#160;<span class="comment"></span>static MERGEFIS_RETVAL_t getNoFisMergingData(char **fis, size_t *fisSize, RCV_DATA_t * rx)</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;{</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">if</span> (!fis || !fisSize || !rx)</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcaf8236a4c96b348374216a49de3a40a99">MERGEFIS_UNKNOWN</a>;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bc">MERGEFIS_RETVAL_t</a> ret = <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcaf8236a4c96b348374216a49de3a40a99">MERGEFIS_UNKNOWN</a>;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *fisMsg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaf9e7a29b314222fac7e7646b96acd577">UBX_UPD_FIS</a>, 0, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">if</span> (!fisMsg)</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    {</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;FIS read timed out&quot;</span>);</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    }</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    {</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="keywordflow">if</span> (fisMsg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>) ||</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;            fisMsg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>) - <span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>))</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;            <span class="keywordtype">size_t</span> tmpFisSize = <span class="keyword">sizeof</span>(<a class="code" href="mergefis_8h.html#af9aba48786e0fc968a01c5aee8f22e61">DRV_SPI_MEM_FIS_t</a>);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <span class="keywordtype">char</span> *tmpFis = malloc(tmpFisSize);</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            <span class="keywordflow">if</span> (tmpFis)</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                memcpy(tmpFis, (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)fisMsg + <a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>), tmpFisSize);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                <span class="keywordflow">if</span> (tmpFis[<a class="code" href="mergefis_8h.html#aa8023e3cde651c33bf1420b26c3090d5">REVISION_POSITION_VER3</a>] == 0x00</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                    &amp;&amp; tmpFis[<a class="code" href="mergefis_8h.html#aa8023e3cde651c33bf1420b26c3090d5">REVISION_POSITION_VER3</a> + 1] == 0x00</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                    &amp;&amp; tmpFis[<a class="code" href="mergefis_8h.html#aa8023e3cde651c33bf1420b26c3090d5">REVISION_POSITION_VER3</a> + 2] == 0x00</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                    &amp;&amp; tmpFis[<a class="code" href="mergefis_8h.html#aa8023e3cde651c33bf1420b26c3090d5">REVISION_POSITION_VER3</a> + 3] == 0x00)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                { <span class="comment">// information is from SFDP structure override major and minor revision</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                    tmpFis[<a class="code" href="mergefis_8h.html#a21f89fbfd20d36cef02adcde686f7aad">MAJOR_REV_POSITION</a>] = 3;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                    tmpFis[<a class="code" href="mergefis_8h.html#ab2be27b3b4a1635812e4753d15ec5f9f">MINOR_REV_POSITION</a>] = 0;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                }</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                ret = <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca1c452f34a43f480ec23a6fef45eeee55">MERGEFIS_OK</a>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                *fis = tmpFis;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                *fisSize = tmpFisSize;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            }</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        }</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        {</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Received unexpected answer.&quot;</span>);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        free(fisMsg);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    }</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;}</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment">//! Extracts the receiver hardware and software generation</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"></span><span class="comment">/*!</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">    \param  monVer      Pointer to the UBX-MON-VER content</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">    \return             Hardware generation of the receiver</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">    \note   Don&#39;t use the firmware revision (number in brackets) to identify</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">            an upcoming firmware version as this number is not guaranteed to</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">            increment over time</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="update_8c.html#a336fee4cfa26042d208059390bba1aaa">  115</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="update_8c.html#a336fee4cfa26042d208059390bba1aaa">extractHwGeneration</a>(<a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* monVer)</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;{</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="comment">// check if there is a string delimiting zero to prevent printing</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="comment">// too much if it is not a string that is at this place</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* pSwVer = (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(monVer)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* pChar  = pSwVer;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keywordflow">while</span> (*pChar &amp;&amp; (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)pChar &lt; ((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(monVer)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+monVer-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a>))</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    {</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        pChar++;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (*pChar==0)</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    {</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Receiver currently running SW &#39;%s&#39;&quot;</span>, pSwVer);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="comment">// get HW version</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* pHwVer = (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(monVer)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+30);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        pChar  = pHwVer; <span class="comment">// pointer to HW ver string</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keywordflow">while</span> (*pChar &amp;&amp; (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)pChar &lt; ((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(monVer)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+monVer-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a>))</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            pChar++;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        }</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keywordflow">if</span> (*pChar==0)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> generation =</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                (strncmp(pHwVer, <span class="stringliteral">&quot;00190000&quot;</span>, 9) == 0) ? 90 :</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                (strncmp(pHwVer, <span class="stringliteral">&quot;00080000&quot;</span>, 9) == 0) ? 80 :</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                (strncmp(pHwVer, <span class="stringliteral">&quot;00070000&quot;</span>, 9) == 0) ? 70 :</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                (strncmp(pHwVer, <span class="stringliteral">&quot;00040007&quot;</span>, 9) == 0) ? 60 :</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                (strncmp(pHwVer, <span class="stringliteral">&quot;00040006&quot;</span>, 9) == 0) ? 51 :</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                (strncmp(pHwVer, <span class="stringliteral">&quot;00040005&quot;</span>, 9) == 0) ? 50 :</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                0;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Receiver HW &#39;%s&#39;, Generation %d.%d&quot;</span>,</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                    pHwVer, generation/10, generation%10);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="keywordflow">return</span> generation;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        }</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        {</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;HW Version information seems corrupt!&quot;</span>);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    }</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    {</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;SW Version information seems corrupt!&quot;</span>);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    }</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;}</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno"><a class="line" href="update_8c.html#afeba84c358a588c41f84c0513d3d33f0">  164</a></span>&#160;<span class="keyword">static</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> <a class="code" href="update_8c.html#afeba84c358a588c41f84c0513d3d33f0">verifyImage</a>(<a class="code" href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a> *pRx, <a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a> <span class="keyword">const</span> *pData, <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> fileSize, <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> address, <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> updateRam, <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> version)</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;{</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    assert(pRx &amp;&amp; pData);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>* pImage = (<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>*)pData;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> imageSize = fileSize;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">// compute a fletcher32 checksum of the image as loaded to the flash</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="comment">// we don&#39;t want to care about the checksums done internally by the FW here...</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> a = 0;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> b = 0;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <a class="code" href="checksum_8c.html#ac4a4eabfc8bef0e9ce8d9ada641b67fb">GetUbxChecksumU4</a>(&amp;a, &amp;b, pImage, imageSize);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="comment">// build the payload to do the same on the hardware</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> dataAligned[4] = { address, imageSize, a, b };</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *msg;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordflow">if</span> (version &gt;= 2)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    {</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="comment">//              version region</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> data[18] = { 0x01, !updateRam };</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        memcpy(&amp;data[2], dataAligned, <span class="keyword">sizeof</span>(dataAligned));</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="comment">// check the CRC on the receiver</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        msg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(pRx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaafbce5122210dd6e4f4b2c295d96efcd6">UBX_UPD_CRC</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)data, <span class="keyword">sizeof</span>(data), <a class="code" href="update_core_8h.html#a51fb6ccd37b6edb264095f862074a4f3">CRC_TIMEOUT</a>);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="comment">// check the CRC on the receiver</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        msg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(pRx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaafbce5122210dd6e4f4b2c295d96efcd6">UBX_UPD_CRC</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)dataAligned, <span class="keyword">sizeof</span>(dataAligned), <a class="code" href="update_core_8h.html#a51fb6ccd37b6edb264095f862074a4f3">CRC_TIMEOUT</a>);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">if</span> (msg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Polling verify message failed&quot;</span>);</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    }</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> success = 0;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == 5)</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    {</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        memcpy(&amp;success, (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a> + 4, 1);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    free(msg);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keywordflow">return</span> success ? <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;}</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno"><a class="line" href="update_8c.html#a27088cda5405506332f2528585e9f171">  208</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="update_8c.html#a27088cda5405506332f2528585e9f171">doReset</a>(<a class="code" href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a> *pRx, <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> reset)</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;{</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    assert(pRx);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordflow">if</span> (reset)</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Rebooting receiver&quot;</span>);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <span class="keywordflow">if</span>( !<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(pRx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa24b1b8c79c36b65b44fa1c9c1e5424a2">UBX_UPD_RBOOT</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0) )</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        {</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;reboot failed&quot;</span>);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        }</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;}</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno"><a class="line" href="update_8c.html#a831dfbba17f304c547b16b7062684825">  221</a></span>&#160;<span class="keyword">static</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> <a class="code" href="update_8c.html#a831dfbba17f304c547b16b7062684825">updateImageToRam</a>(<a class="code" href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a>* pRx, <span class="keyword">const</span> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* pImageStart, <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> ImageSize)</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;{</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html">APP_UBX_UPD_IMG_PAYLOAD_t</a> imgPayload;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <a class="code" href="types_8h.html#ac82fb958e48c78b4698b16a3c4bd745f">U2</a> sent = 0;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <a class="code" href="types_8h.html#a1d40f5629841850bfb5fe78be26d89ad">U</a> sendStart = 0;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="types_8h.html#a1d40f5629841850bfb5fe78be26d89ad">U</a> acked = 0;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <a class="code" href="types_8h.html#a1d40f5629841850bfb5fe78be26d89ad">U</a> timeLimit = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() + <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> success = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordflow">if</span> (pRx == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || pImageStart == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    {</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">while</span> ((acked * <span class="keyword">sizeof</span>(imgPayload.<a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a148928757bf6fd17dbe66bc2e7e8076b">chunkData</a>)) &lt; ImageSize)</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="comment">// check if less than 5 packets are pending (receiver only allocates 4*1000butes, 1 buffer has to be always free to avoid rxBuf alloc, One message is 514bytes)</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="keywordflow">if</span> ((sent - acked) &lt; 5 &amp;&amp; (sendStart &lt; ImageSize))</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> packetSize = <span class="keyword">sizeof</span>(imgPayload.<a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a148928757bf6fd17dbe66bc2e7e8076b">chunkData</a>);</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordtype">size_t</span> sendSize;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            <span class="keywordflow">if</span> ((sendStart + packetSize) &gt; ImageSize)</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                sendSize = ImageSize - sendStart;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            }</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            {</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                sendSize = packetSize;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            }</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            <span class="comment">// send one packet</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            imgPayload.<a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a11c328214d9c7d0640cfe8500144fb08">chunkNum</a> = sent;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            memcpy(imgPayload.<a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a148928757bf6fd17dbe66bc2e7e8076b">chunkData</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)pImageStart + sendStart, sendSize);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="keywordflow">if</span> (sendSize &lt; packetSize)</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            {</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="comment">// clear the rest of the buffer</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                memset(&amp;imgPayload.<a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a148928757bf6fd17dbe66bc2e7e8076b">chunkData</a>[sendSize], 0, packetSize - sendSize);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            }</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(pRx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaec4951cfe8176d4f2162af8c8256f6aa">UBX_UPD_IMG</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)&amp;imgPayload, <span class="keyword">sizeof</span>(imgPayload)) != 1)</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            {</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Chunk %d not accepted by receiver&quot;</span>, sent);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            sent++;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            sendStart += packetSize;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        }</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <span class="comment">// check if we received an ack</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *ack = <a class="code" href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a>(pRx, 0, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa106c9b9bf52d08b3e9e128c637aa8570">UBX_CLASS_ACK</a>, -1);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">if</span> (ack != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        {</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            <a class="code" href="struct_u_b_x___a_c_k___a_c_k__s.html">UBX_ACK_ACK_t</a> *pAck = (<a class="code" href="struct_u_b_x___a_c_k___a_c_k__s.html">UBX_ACK_ACK_t</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)ack + <a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            <span class="keywordflow">if</span> (pAck-&gt;<a class="code" href="struct_u_b_x___a_c_k___a_c_k__s.html#ac3d6af1a3015658509c0dafb8f6ceb7a">clsId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a> &amp;&amp;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                pAck-&gt;<a class="code" href="struct_u_b_x___a_c_k___a_c_k__s.html#a59f6080e4395185cab90c54e624695bc">msgId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaec4951cfe8176d4f2162af8c8256f6aa">UBX_UPD_IMG</a>)</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;            {</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                <span class="keywordflow">if</span> (ack-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">msgId</a> != <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaadfdde5d08d373820119e962ea93211ec">UBX_ACK_ACK</a>)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Received NACK for chunk %d &quot;</span>, (acked+1));</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                }</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                <span class="comment">// we received an ack message for one UPD-IMG message</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                <span class="comment">// push out the timeout</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                timeLimit = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() + <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                acked++;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            }</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            {</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;Received unexpected (N)ACK&quot;</span>);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            }</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            free(ack);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="comment">// check if we timed out</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() &gt; timeLimit)</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        {</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Downloading to RAM timed out. sent %u, acked %u&quot;</span>, sent, acked);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        }</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    }</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">// check if we finished</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">if</span> ((acked * <span class="keyword">sizeof</span>(imgPayload.<a class="code" href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a148928757bf6fd17dbe66bc2e7e8076b">chunkData</a>)) &gt;= ImageSize)</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        success = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    }</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="keywordflow">return</span> success;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;}</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div>
<div class="line"><a name="l00308"></a><span class="lineno"><a class="line" href="update_8h.html#a91fe63423c374194e5090f96e17064a6">  308</a></span>&#160;<a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> <a class="code" href="update_8c.html#a91fe63423c374194e5090f96e17064a6">UpdateFirmware</a>(<a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          BinaryFileName,</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          FlashDefFileName,</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          FisFileName,</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">char</span>*          ComPort,</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   Baudrate,</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   BaudrateSafe,</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   BaudrateUpd,</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>       <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           DoSafeBoot,</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           DoReset,</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           DoAutobaud,</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           EraseWholeFlash,</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           EraseOnly,</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           TrainingSequence,</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           doChipErase,</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>       <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           noFisMerging,</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a>       <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           updateRam,</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           usbAltMode,</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <span class="keywordtype">int</span>            Verbose,</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                    <a class="code" href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a> <span class="keyword">const</span> <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>           fisOnly)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;{</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a>* pData = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordtype">size_t</span> fileSize = 0;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="comment">//&#39;verbose&#39; is globally declared in platform.h</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <a class="code" href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a> = Verbose;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> success = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> isUsbPort = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> rcvConnected = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> eraseInProgres = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> flashNotNeeded = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> isSpiPort = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> generation = 0;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> FwBase = 0;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> imageGeneration = 0;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <a class="code" href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a> rx;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <a class="code" href="struct_f_w_f_o_o_t_e_r_i_n_f_o__u.html">FWFOOTERINFO_t</a> fwFooter={0};</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <a class="code" href="struct_b_l_o_c_k___a_r_r__s.html">BLOCK_ARR_t</a> FlashOrg;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    memset(&amp;FlashOrg, 0, <span class="keyword">sizeof</span>(FlashOrg));</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <a class="code" href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a> *upd=<a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <span class="keywordflow">if</span> (updateRam != 0)</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    {</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        flashNotNeeded = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    }</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a8a58ddd9346f76e629a18f2a2053fd72">MSG_LEV0</a>, <span class="stringliteral">&quot;u-blox Firmware Update Tool version %s&quot;</span>, <a class="code" href="version_8h.html#a64d7b69eb90245360974277068bd3e4a">PRODUCTVERSTR</a>);</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        <span class="keywordflow">if</span> (!EraseOnly &amp;&amp; !fisOnly)</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        {</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a8a58ddd9346f76e629a18f2a2053fd72">MSG_LEV0</a>, <span class="stringliteral">&quot;Updating Firmware &#39;%s&#39; of receiver over &#39;%s&#39;&quot;</span>,</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    BinaryFileName, ComPort);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Opening and buffering image file&quot;</span>);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="image_8c.html#ab59ad229220ddf25bcbea31620cb59fd">OpenAndBufferFile</a>(BinaryFileName, &amp;pData, &amp;fileSize))</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Verifying image&quot;</span>);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            <span class="comment">//we got the file content, check if it is a valid image</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;            imageGeneration = <a class="code" href="image_8c.html#a9e7479197d9de9e51a74f08602d762d5">ValidateImage</a>(pData, fileSize, &amp;fwFooter);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            <span class="keywordflow">if</span> (imageGeneration == 0)</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            {</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Image not valid.&quot;</span>);</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            }</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment">         * connect to the receiver with the given baudrate *</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            rcvConnected = <a class="code" href="receiver_8c.html#a074f16ec30ce655cbcaa84e5641b4d8c">rcvConnect</a>(&amp;rx, ComPort, Baudrate);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <span class="keywordflow">if</span> (!rcvConnected)</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">         * try to communicate with the receiver (MON-VER)  *</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="keywordflow">if</span>(TrainingSequence)</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            <a class="code" href="receiver_8c.html#ad3955f74acc89430ae3a7fd9511a128c">rcvSendTrainingSequence</a>(&amp;rx);</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* monVer = DoAutobaud ?</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            <a class="code" href="receiver_8c.html#a8f85ccad88ab9bd614ff292202ba6ae3">rcvDoAutobaud</a>(&amp;rx, TrainingSequence) :</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4f84234a418e7846f3e4805d6b27cbe7">UBX_CLASS_MON</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6433073287acd096f9c8b1f42a6a5a98">UBX_MON_VER</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordflow">if</span>( monVer == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> )</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        {</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Version poll failed.&quot;</span>);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        }</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Received Version information&quot;</span>);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        generation = <a class="code" href="update_8c.html#a336fee4cfa26042d208059390bba1aaa">extractHwGeneration</a>(monVer);</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        free(monVer);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> romSize =</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;            (generation == 50) ? 384*1024 : <span class="comment">// 384kB ROM in u-blox5</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;            (generation == 51 ||</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;             generation == 60) ? 448*1024 : <span class="comment">// 448kB ROM in G51 &amp;&amp; u-blox6</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;            (generation == 70) ? 512*1024 : <span class="comment">// 512kB ROM in u-blox7</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            (generation == 80) ? 544*1024 : <span class="comment">// 544kB ROM in u-blox8</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;            (generation == 90) ? 672*1024 : <span class="comment">// 650kB ROM in u-blox9</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;             0;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">// check for valid ROM size not needed for u-blox10</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span> ( (!romSize) &amp;&amp; (generation &lt; 100) )</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Could not get correct ROM size&quot;</span>);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        }</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">         * read the CRC of the ROM                         *</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> crcVal = 0x66666666;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordflow">if</span> (generation &gt;= 90 &amp;&amp; imageGeneration &gt;= 91)</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* romCrc = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            FwBase = (updateRam != 0) ? <a class="code" href="update_core_8h.html#ad35c1036b7f001b47306c58a18329400">RAM_BASE</a> : <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>);</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Sending ROM CRC Poll&quot;</span>);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            romCrc = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa471653a65c14d72ed8778f5a5a9687d2">UBX_UPD_ROM</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            <span class="keywordflow">if</span> (romCrc == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            {</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Could not get ROM CRC&quot;</span>);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            {</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                memcpy(&amp;crcVal, (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)romCrc + <a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a> + 2 * <span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a>), <span class="keyword">sizeof</span>(crcVal));</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                free(romCrc);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        }</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        {</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> fail = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> CRCSize = 4;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> romBase = (generation &gt;= 70) ? 0x00000000 : 0x00200000;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payload[3] = { romBase + romSize - CRCSize, CRCSize, 0 };</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> payloadAuth[] = { 0x9C, 0x59, 0xC5, 0x22, 0xEC, 0x34, 0x1A, 0x1A, 0x30, 0xCC, 0xB1, 0xFB, 0x69, 0xCB, 0xAD, 0x9A, 0x41, 0x83, 0x6E, 0xDD, 0x27, 0xE4, 0xFB, 0xA6, 0x8C, 0x71, 0xE3, 0xAB, 0x8A, 0xA4, 0x0D, 0x20, 0xFC, 0x7F, 0x08, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }; <span class="comment">// Read u-blox8 CRC auth</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> retryCount;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            FwBase = (pData) ? pData-&gt;<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">v1</a>.<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#a584b27340c18f4c0a012666ccd81ad01">pBase</a> : <a class="code" href="update_core_8h.html#a23a9099a5f8fc9c6e253c0eecb2be8db">FLASH_BASE</a>;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Sending ROM CRC-Mix-Read&quot;</span>);</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            <span class="keywordflow">for</span> (retryCount = 0; (retryCount &lt; <a class="code" href="receiver_8h.html#a436daa50a3a663d6109f98c4efd45d58">RETRY_COUNT</a>) &amp;&amp; fail; retryCount++)</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            {</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaab66352edded823ec830d2cc88a15afbf">UBX_UPD_UPLOAD</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> *)payload, <span class="keyword">sizeof</span>(payload)) ||</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                    !<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa8916c80f7aebca3e4aea158533187d0e">UBX_UPD_AUTHREAD</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> *)payloadAuth, <span class="keyword">sizeof</span>(payloadAuth)))</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                    <span class="keywordflow">break</span>; <span class="comment">// fail</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                }</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> TOTIME = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() + <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>; <span class="comment">// compute the deadline</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                <span class="keywordflow">do</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                    <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> now = <a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>();</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                    <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a>* msg = <a class="code" href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a>(&amp;rx, TOTIME &gt; now ? TOTIME - now : 0, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, -1);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                    <span class="keywordflow">if</span> (msg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                    {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                    }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                    <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">msgId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaab66352edded823ec830d2cc88a15afbf">UBX_UPD_UPLOAD</a>)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                    {</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                        memcpy(&amp;crcVal, (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg + <a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a> + 12, <span class="keyword">sizeof</span>(crcVal));</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                        fail = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                    }</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">msgId</a> == <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa8916c80f7aebca3e4aea158533187d0e">UBX_UPD_AUTHREAD</a>)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                    {</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                        memcpy(&amp;crcVal, (<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)msg + <a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a> + <span class="keyword">sizeof</span>(payloadAuth), <span class="keyword">sizeof</span>(crcVal));</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                        fail = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                    }</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    free(msg);</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                } <span class="keywordflow">while</span> ((<a class="code" href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a>() &lt; TOTIME) &amp;&amp; fail);</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            }</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="keywordflow">if</span>(fail)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            {</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Could not get ROM CRC&quot;</span>);</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            }</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        }</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333aadaa5a3fb3415c5881e70c7f762f8dd7">MSG_LEV2</a>, <span class="stringliteral">&quot;ROM CRC: 0x%08X&quot;</span>, crcVal);</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> hwRomVer = (crcVal == 0x00000000) ? 200 : <span class="comment">// u-blox5</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                      (crcVal == 0xE046F6C8) ? 300 :</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                      (crcVal == 0x3CB3E4FF) ? 400 :</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                      (crcVal == 0x806AF596) ? 500 :</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                      (crcVal == 0xEA00D0BD) ? 510 :</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                      (crcVal == 0xB5CD6FC1) ? 600 : <span class="comment">// u-blox6</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                      (crcVal == 0x2BA123BA) ? 601 :</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                      (crcVal == 0x288646C9) ? 602 :</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                      (crcVal == 0xB94D4114) ? 701 :</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                      (crcVal == 0x494DF1F9) ? 703 :</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                      (crcVal == 0xd5fce753) ?  10 : <span class="comment">// u-blox7 ROM0.10</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                      (crcVal == 0xfce598b1) ?  11 : <span class="comment">//         ROM0.11</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                      (crcVal == 0xed152ade) ?  14 : <span class="comment">//         ROM0.14</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                      (crcVal == 0x100E368D) ? 100 : <span class="comment">//         ROM1.00</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                      (crcVal == 0xDFAA666C) ?  21 : <span class="comment">// u-blox8 ROM0.21</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                      (crcVal == 0x041D115D) ?  22 : <span class="comment">// u-blox8 ROM0.22</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                      (crcVal == 0xA15AF099) ? 201 : <span class="comment">// u-blox8 ROM2.01</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                      (crcVal == 0x2FEF89EA) ? 301 : <span class="comment">//         ROM3.01</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                      (crcVal == 0x1893C329) ? 351 : <span class="comment">//         ROM3.51</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                      (crcVal == 0xCAAF619C) ? 40  : <span class="comment">// u-blox9 ROM0.40</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                      (crcVal == 0xDD3FE36C) ? 101 : <span class="comment">//         ROM1.01</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                      (crcVal == 0x118B2060) ? 102 : <span class="comment">//         ROM1.02</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                      (crcVal == 0x3BFC8935) ? 404 : <span class="comment">//         ROM4.04</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                      0;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="keywordflow">if</span> (!hwRomVer &amp;&amp; !EraseOnly)</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        {</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;u-blox %d.%d ROM version unknown (0x%08X)&quot;</span>,</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                    generation/10, generation%10, crcVal);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        }</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333aadaa5a3fb3415c5881e70c7f762f8dd7">MSG_LEV2</a>, <span class="stringliteral">&quot;u-blox%d ROM%d.%02d hardware detected (0x%08X)&quot;</span>,</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;            generation/10, hwRomVer/100, hwRomVer%100, crcVal);</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">         * check that the image is compatible              *</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordflow">if</span> (EraseOnly || fisOnly)</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        {</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            <span class="comment">// no image available, no check needed</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        }</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (imageGeneration / 10) != (generation / 10) &amp;&amp;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                 ((imageGeneration == 91) &amp;&amp; (generation != 100)))</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        {</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Receiver generation (%d) incompatible with this image (%d)!&quot;</span>,</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                generation, imageGeneration);</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        }</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">         * find out if connected via USB                   *</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        {</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            <span class="comment">// autodetect the receiver port</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Getting Port connection to receiver&quot;</span>);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *portCfgMsg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaedb737fb697bae964ab8d4a8aa642425">UBX_CFG_PORT</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            <span class="keywordflow">if</span>(portCfgMsg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            {</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Getting Port connection timed out&quot;</span>);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            }</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            <a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html">UBX_CFG_PRT_t</a> *prt = (<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html">UBX_CFG_PRT_t</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)portCfgMsg+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keyword">const</span> <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* portName[6] = {<span class="stringliteral">&quot;I2C&quot;</span>, <span class="stringliteral">&quot;UART1&quot;</span>, <span class="stringliteral">&quot;UART2&quot;</span>, <span class="stringliteral">&quot;USB&quot;</span>, <span class="stringliteral">&quot;SPI&quot;</span>, <span class="stringliteral">&quot;?\?\?&quot;</span> };</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Connected port is: %s&quot;</span>, portName[<a class="code" href="types_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(prt-&gt;<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#ada60d7aab2055028d1a303f2515bf24c">portId</a>,5)]);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            <span class="keywordflow">if</span> (prt-&gt;<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#ada60d7aab2055028d1a303f2515bf24c">portId</a> == 3)</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;            {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                isUsbPort = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;            }</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="keywordflow">if</span> (prt-&gt;<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#ada60d7aab2055028d1a303f2515bf24c">portId</a> == 4)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            {</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                isSpiPort = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;            }</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            free(portCfgMsg);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        }</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="comment">         * Prepare the receiver for firmware update        *</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="comment">         * - either send to safeboot                       *</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">         * - or start the loader task and disable GPS      *</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="keywordflow">if</span> (usbAltMode)</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        {</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payload[3];</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            memset(payload, 0, <span class="keyword">sizeof</span>(payload));</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            payload[0] = <a class="code" href="update_core_8h.html#a23a9099a5f8fc9c6e253c0eecb2be8db">FLASH_BASE</a> + 12;   <span class="comment">//base address + 12 is base address</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            payload[1] = 0x00000100;        <span class="comment">//flags -&gt; BIT8 = FLASH-Write</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            payload[2] = 0x00000000;        <span class="comment">//data</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            <span class="keywordflow">if</span> ( <a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa2eae0cce6a4993381c6c7c0278bad160">UBX_UPD_DOWNL</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)payload, <span class="keyword">sizeof</span>(payload), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>)!= 1 )</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            {</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                <span class="comment">// compose the payload for the new UBX-UPD-AUTHWRITE message (introduced with FW3.00)</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                <span class="comment">// !IMPORTANT regenerate hash if any data in this message is changed!</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                <span class="keyword">const</span> <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> hash[32] = { 0x55, 0x70, 0xC3, 0x2B, 0x19, 0xA7, 0xA5, 0xC9, 0x28, 0x3B, 0xDD, 0xE8, 0xD5, 0x89, 0xC4, 0x91, 0x8F, 0xE5, 0x32, 0x8B, 0x20, 0x24, 0x1B, 0x45, 0x54, 0xDB, 0x30, 0x0D, 0x35, 0xBB, 0xE1, 0x1E };</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> payloadAuth[11];</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                memset(payloadAuth, 0, <span class="keyword">sizeof</span>(payloadAuth));</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                memcpy(payloadAuth, hash, <span class="keyword">sizeof</span>(hash)); <span class="comment">// initialize hash</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                payloadAuth[8] = <a class="code" href="update_core_8h.html#a23a9099a5f8fc9c6e253c0eecb2be8db">FLASH_BASE</a>;        <span class="comment">// base address of FLASH</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                payloadAuth[9] = 0x00000100;        <span class="comment">// flags -&gt; flashWrite</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                payloadAuth[10] = <a class="code" href="update_8c.html#a0792eb6101efca31a477332c44b335f3">HW_IMG_MAGIC_DOM</a>;       <span class="comment">// UBLOX8 magic word (To prevent FS from starting in FW301)</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa70ef325cfc92074a0741a423221d6e49">UBX_UPD_AUTHWRITE</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)payloadAuth, <span class="keyword">sizeof</span>(payloadAuth), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) != 1)</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                {</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Invalidating flash failed&quot;</span>);</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                }</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            }</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <a class="code" href="update_8c.html#a27088cda5405506332f2528585e9f171">doReset</a>(&amp;rx, <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(100); <span class="comment">// wait until receiver is booted up (reset only)</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            <span class="comment">// Reenumerate the port</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#acec694b60e783ae0e1a67028fa58a538">rcvReenumerate</a>(&amp;rx, isUsbPort))</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            {</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Reenumerate failed&quot;</span>);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            }</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            DoSafeBoot = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        }</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        <span class="keywordflow">if</span> (DoSafeBoot)</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        {</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            <span class="comment">//send safeboot command</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Commanding Safeboot&quot;</span>);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            <span class="keywordflow">if</span>( !<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa375c3a5e3d34cc92292d9eff56f46bc">UBX_UPD_SAFE</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0) )</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            {</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Safeboot failed.&quot;</span>);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="comment">// wait for the message to be transmitted and the receiver to finish</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            <span class="comment">// re-boot (some extended POST checks are performed)</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(500);</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            <span class="comment">// checks takes more time in u-blox9</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            <span class="keywordflow">if</span> (generation == 90)</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            {</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(300);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            }</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="comment">// Reenumerate the port</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            <span class="keywordflow">if</span>(!<a class="code" href="receiver_8c.html#acec694b60e783ae0e1a67028fa58a538">rcvReenumerate</a>(&amp;rx, isUsbPort))</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            {</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Reenumerate failed&quot;</span>);</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;            }</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            <span class="comment">// set the safeboot baudrate if not USB port</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            <span class="keywordflow">if</span>(!isUsbPort)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                <span class="keywordflow">if</span>( !<a class="code" href="receiver_8c.html#ae1ccf51e0ab5720c5cd5df1ae6bb6ae1">rcvSetBaud</a>(&amp;rx, BaudrateSafe) )</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                {</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Safeboot Baud rate set failed.&quot;</span>);</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                }</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;            }</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            <span class="comment">// send the training sequence</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            <span class="keywordflow">if</span>(TrainingSequence)</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            {</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                <span class="keywordflow">if</span>( !<a class="code" href="receiver_8c.html#ad3955f74acc89430ae3a7fd9511a128c">rcvSendTrainingSequence</a>(&amp;rx) )</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                {</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Sending training sequence failed&quot;</span>);</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                }</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            }</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            monVer = DoAutobaud ?</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                     <a class="code" href="receiver_8c.html#a8f85ccad88ab9bd614ff292202ba6ae3">rcvDoAutobaud</a>(&amp;rx, TrainingSequence) :</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                     <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4f84234a418e7846f3e4805d6b27cbe7">UBX_CLASS_MON</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6433073287acd096f9c8b1f42a6a5a98">UBX_MON_VER</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;            <span class="keywordflow">if</span>(monVer == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            {</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Version is null&quot;</span>);</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            }</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            free(monVer);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        }</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        {</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            <span class="comment">// Start the loader task</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Starting LDR TSK&quot;</span>);</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> pPayload[1] = { 0x01 };</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            <span class="comment">// this message is assumed to be OK if ACKed or NAKed</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            <span class="keywordflow">if</span>( <a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa375c3a5e3d34cc92292d9eff56f46bc">UBX_UPD_SAFE</a>, pPayload, <span class="keyword">sizeof</span>(pPayload), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) == -1 )</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            {</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Starting flash loader failed&quot;</span>);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;            }</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            {</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;LDR TSK started successfully&quot;</span>);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            }</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            <span class="comment">// Identify the flash loader</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Identify flash loader&quot;</span>);</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *msg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa3d273b4f40703d9523f6b7cd469d1d7c">UBX_UPD_IDEN</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;            <span class="keywordflow">if</span>( msg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || msg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> != 1)</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            {</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Identify of flash loader failed&quot;</span>);</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;                <span class="keywordflow">if</span>(msg != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;                    free(msg);</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            }</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> majorN = (*((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>) &amp; 0xF0) &gt;&gt; 4;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> minorN = (*((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)(msg)+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>) &amp; 0x0F);</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Uploader version %u.%u detected&quot;</span>, majorN, minorN);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;            free(msg);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;            <span class="comment">// disable GPS</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Stop GPS operation&quot;</span>);</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;            <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> data[4] = { 0, 0, 8, 0 };</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;            <span class="comment">// don&#39;t expect ACK</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa0734cdb7e1bdb425d54a87bd1df0c3e">UBX_CFG_RST</a>, data, <span class="keyword">sizeof</span>(data)))</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;            {</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Stopping GPS failed&quot;</span>);</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            }</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        }</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">         * Detect the flash                                *</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <a class="code" href="types_8h.html#ac82fb958e48c78b4698b16a3c4bd745f">U2</a> FlashManId = 0;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <a class="code" href="types_8h.html#ac82fb958e48c78b4698b16a3c4bd745f">U2</a> FlashDevId = 0;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        <span class="keywordflow">if</span> (generation &lt; 90 || !flashNotNeeded)</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        {</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Detecting Flash manufacturer and device IDs&quot;</span>);</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            <span class="comment">// detect flash version</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;            <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *flashMsg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa563df58385da1413e34adb760d175a1c">UBX_UPD_FLDET</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)&amp;FwBase, 4, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            <span class="keywordflow">if</span>(flashMsg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            {</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Flash Detection timed out&quot;</span>);</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flashMsg-&gt;<a class="code" href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">size</a> == 8)</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                memcpy(&amp;FlashManId,(<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)flashMsg+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+4),<span class="keyword">sizeof</span>(FlashManId));</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                memcpy(&amp;FlashDevId,(<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)((<a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a>*)flashMsg+<a class="code" href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a>+6),<span class="keyword">sizeof</span>(FlashDevId));</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Flash ManId: 0x%04X DevId: 0x%04X&quot;</span>, FlashManId, FlashDevId);</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                free(flashMsg);</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;            }</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            {</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Received unexpected answer.&quot;</span>);</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                free(flashMsg);</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;            }</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        }</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> jedec = ((FlashManId &amp; 0xFFFF) &lt;&lt; 16) + (FlashDevId &amp; 0xFFFF);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">         * Do the FIS merging                              *</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> FlashSize = 0;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> *fis = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordtype">size_t</span> fisSize=0;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bc">MERGEFIS_RETVAL_t</a> ret = <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca1c452f34a43f480ec23a6fef45eeee55">MERGEFIS_OK</a>;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="keywordflow">if</span>(generation &gt;= 70)</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        {</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            <a class="code" href="struct_b_l_o_c_k___d_e_f__s.html">BLOCK_DEF_t</a> flashDef;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;            <span class="keywordflow">if</span> (generation &lt; 90 || !flashNotNeeded)</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;            {</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                <span class="keywordflow">if</span> (generation &gt;= 90 &amp;&amp; noFisMerging) <span class="comment">// Don&#39;t try to load FIS from file</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                {</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                    ret = <a class="code" href="update_8c.html#af1d2a705ba4ac692befd90b25f146925">getNoFisMergingData</a>(&amp;fis, &amp;fisSize, &amp;rx);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                }</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                {</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                    <span class="comment">// try to load the FIS file</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                    ret = <a class="code" href="mergefis_8c.html#a355730c88715f80ba18bd8cce877e1bc">mergefis_load</a>(&amp;fis, &amp;fisSize, FisFileName, jedec);</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                }</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                <span class="keywordflow">if</span> (ret == <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca1c452f34a43f480ec23a6fef45eeee55">MERGEFIS_OK</a>)</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                {</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                    flashDef.<a class="code" href="struct_b_l_o_c_k___d_e_f__s.html#a1cd9965ad2a859bc2970376129ad1fa9">Count</a> = <a class="code" href="mergefis_8c.html#a5736369b7efb562e0d1726ac6cb46657">mergefis_get_sector_count</a>(fis);</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                    flashDef.<a class="code" href="struct_b_l_o_c_k___d_e_f__s.html#a6fc5bf08cb60b3a7938847e33aec0953">Size</a> = <a class="code" href="mergefis_8c.html#a5ed5ea69800bed0f911492a7a79d7708">mergefis_get_sector_size</a>(fis);</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                    <a class="code" href="flash_8c.html#ade5f330c48bccf916d165e62b50c9df8">addBlock</a>(&amp;FlashOrg, &amp;flashDef);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                    FlashSize = flashDef.<a class="code" href="struct_b_l_o_c_k___d_e_f__s.html#a1cd9965ad2a859bc2970376129ad1fa9">Count</a> * flashDef.<a class="code" href="struct_b_l_o_c_k___d_e_f__s.html#a6fc5bf08cb60b3a7938847e33aec0953">Size</a>;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                    <span class="keywordflow">if</span> (fisOnly)</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                    {</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                        <span class="comment">// we don&#39;t have to merge but just send the FIS</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                        fileSize = 0x1000;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                        <span class="comment">// Is FIS size to big?</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                        <span class="keywordflow">if</span> (fisSize &gt; (fileSize - 0x40) || !fisSize || !fis)</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                        {</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                            <span class="keywordflow">if</span> (fis)</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                                free(fis);</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                            fis = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                            fisSize = 0;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                        }</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                        <span class="keywordflow">if</span> (pData != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                        {</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                            free(pData);</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                            pData = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                        }</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                        <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> *pFis = malloc(fileSize);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                        <span class="keywordflow">if</span> (!pFis)</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                        {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                            free(fis);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                            fis = <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                            fisSize = 0;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                        }</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                        <span class="keywordflow">if</span> (generation &gt;= 90)</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                        {</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                            fisSize = <span class="keyword">sizeof</span>(<a class="code" href="mergefis_8h.html#af9aba48786e0fc968a01c5aee8f22e61">DRV_SPI_MEM_FIS_t</a>);</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                            pData = (<a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a>*)pFis;</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                            <span class="comment">// just copy the fis into the image at the start</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                            memcpy(pData, fis, <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>));</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                            fileSize = <span class="keyword">sizeof</span>(<a class="code" href="mergefis_8h.html#af9aba48786e0fc968a01c5aee8f22e61">DRV_SPI_MEM_FIS_t</a>);</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                        }</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                        {</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                            <span class="comment">// Set header part to 0, the rest will be overwritten</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                            memset(pFis, 0x0, 0x40);</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                            <span class="comment">// Set the rest of pFis to 0xff</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                            memset(&amp;pFis[0x40], 0xff, fileSize - 0x40);</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                            <span class="comment">// Copy the actual data after the header</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                            memcpy(&amp;pFis[0x40], fis, fisSize);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                            pData = (<a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a>*)pFis;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                        }</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                    }</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pData != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; noFisMerging)</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                    {</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Not merging anything&quot;</span>);</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                    }</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pData != <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                    {</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                        <span class="keywordflow">if</span> (generation &gt;= 90)</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                        {</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> newSize = fileSize + <span class="keyword">sizeof</span>(<a class="code" href="mergefis_8h.html#af9aba48786e0fc968a01c5aee8f22e61">DRV_SPI_MEM_FIS_t</a>);</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                            <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>* pData2 = malloc(newSize);</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                            <span class="keywordflow">if</span> (pData2 == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                            {</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;malloc failed&quot;</span>);</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                            }</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                            <span class="comment">// just copy the fis into the image at the start</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                            memcpy(pData2, fis, <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>));</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                            memcpy(pData2 + <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>), pData, fileSize);</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                            free(pData);</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                            pData = (<a class="code" href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_t</a>*)pData2;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                            fileSize = newSize;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                            FwBase = 0;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                        }</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                        {</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                            <span class="comment">// merge the FIS information into the firmware</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;                            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> imageSize = (pData-&gt;<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">v1</a>.<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#a61f4ebb2f5b2aee90ded2d80f4268a37">pEnd</a> &amp; ~0x1) - pData-&gt;<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">v1</a>.<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#a584b27340c18f4c0a012666ccd81ad01">pBase</a> + <span class="keyword">sizeof</span>(<a class="code" href="types_8h.html#acef4706edf5cb8820227a47eb22c371b">U8</a>);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                            ret = <a class="code" href="mergefis_8c.html#ac4eee236d80de78bb5efab5a1970ba31">mergefis_merge</a>((<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)pData, imageSize, fis);</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                        }</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                    }</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                    <span class="comment">// check for failure</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                    <span class="keywordflow">if</span> (ret != <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca1c452f34a43f480ec23a6fef45eeee55">MERGEFIS_OK</a> &amp;&amp; !noFisMerging)</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                    {</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;The merging failed&quot;</span>);</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                    }</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!noFisMerging)</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                    {</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                        <span class="comment">// success</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;FIS information merged&quot;</span>);</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                    }</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                }</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                {</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;                    <span class="comment">// something went wrong when loading the FIS file</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                    <span class="comment">// check the reason</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;                    <span class="keywordflow">switch</span> (ret)</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                    {</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca4671f9f3f6c0099fdd88d7eb2e91e00d">MERGEFIS_FILE_NOT_FOUND</a>:</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Could not open the FIS file %s&quot;</span>, FisFileName);</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca7c0065141b8bd3d5c66108547099bcb4">MERGEFIS_VERSION_ERROR</a>:</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;FIS version not matching\n&quot;</span>);</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca438c243b83c8cf9d481f62a8090a5502">MERGEFIS_INCORRECT_XML</a>:</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;There is an error in the XML file\n&quot;</span>);</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca4e1c9509cd502b478135636e7aeec106">MERGEFIS_JEDEC_NOT_SUPPORTED</a>:</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Flash (ManId: 0x%04X DevId: 0x%04X) not supported\n&quot;</span>, FlashManId, FlashDevId);</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcaa0d352b55efc138b8ca352176afd7a38">MERGEFIS_CODE_CORRUPTED</a>:</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Code in XML file is corrupted\n&quot;</span>);</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                    <span class="keywordflow">case</span> <a class="code" href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcafd1af2f55418d3261cde3af7084dd3f3">MERGEFIS_CRC_FAILURE</a>:</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;CRC failure\n&quot;</span>);</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;An unknown error occurred\n&quot;</span>);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                    }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                }</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;            }</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        }</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        {</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            <span class="comment">// search for flash info in provided flash definition file</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;            <span class="keywordflow">if</span>(!<a class="code" href="flash_8c.html#a5702805837058c6c3f8f51c0300d309e">GetFlashOrganisation</a>(FlashManId, FlashDevId,</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                &amp;FlashOrg, &amp;FlashSize, FlashDefFileName))</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;            {</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Could not open file &#39;%s&#39;&quot;</span>, FlashDefFileName);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;No flash organization information available for ManID 0x%04X, DevID 0x%04X&quot;</span>, FlashManId, FlashDevId);</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;            }</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        }</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <a class="code" href="flash_8c.html#a7bf128ab2f67a130452c054a44662922">DumpFlashInfo</a>(&amp;FlashOrg, FlashSize);</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        <span class="comment">// check if flash size is at least as big as firmware to load</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="keywordflow">if</span> (generation &lt; 90 || !(updateRam != 0))</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        {</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;            <span class="keywordflow">if</span> (FlashSize &lt; fileSize)</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;            {</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Flash too small for image.&quot;</span>);</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;            }</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        }</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="comment">         * Switch to the update baudrate                   *</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html">UBX_CFG_PRT_t</a> prtcfg;</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        memset(&amp;prtcfg, 0, <span class="keyword">sizeof</span>(prtcfg));</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        prtcfg.<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#ada60d7aab2055028d1a303f2515bf24c">portId</a>       = 1;            <span class="comment">//LEA-5 has only USART1 for serial comm</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        prtcfg.<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#a6c903e7ed26f1bb82b677dcea21369bc">mode</a>         = (1&lt;&lt;7) |</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                              (1&lt;&lt;6) |</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                              (1&lt;&lt;11);      <span class="comment">//8N1</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        prtcfg.<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#a5f0c37ecb075fb6722d34ece6c327645">baudrate</a>     = BaudrateUpd;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        prtcfg.<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#abadd720b5a6f5bc6820db38095e58dc1">inProtoMask</a>  = 0x1;          <span class="comment">//UBX only</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        prtcfg.<a class="code" href="struct_u_b_x___c_f_g___p_r_t__s.html#a3f165dcf8cbbb07b1370eb46f2126533">outProtoMask</a> = 0x1;          <span class="comment">//UBX only</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaedb737fb697bae964ab8d4a8aa642425">UBX_CFG_PORT</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)&amp;prtcfg, <span class="keyword">sizeof</span>(prtcfg));</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(200);</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        <a class="code" href="receiver_8c.html#ae1ccf51e0ab5720c5cd5df1ae6bb6ae1">rcvSetBaud</a>(&amp;rx, BaudrateUpd);</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        <a class="code" href="receiver_8c.html#a1873dd0baccb35706c7792cab2b59724">rcvFlushBuffer</a>(&amp;rx);</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        monVer = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4f84234a418e7846f3e4805d6b27cbe7">UBX_CLASS_MON</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6433073287acd096f9c8b1f42a6a5a98">UBX_MON_VER</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        <span class="keywordflow">if</span>(monVer == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        {</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Failed polling MON-VER\n&quot;</span>);</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        }</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        {</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;            free(monVer);</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        }</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="comment">         * Send patch for u-blox 7                         *</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="keywordflow">if</span>(generation == 70 &amp;&amp; hwRomVer == 100)</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        {</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Sending patch to fix too small erase timeout&quot;</span>);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> ram[] = { 0x98, 0x01, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x9c, 0x1c };</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> fpb[] = { 0x20, 0x20, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x00, 0xed, 0x78, 0x04, 0x00 };</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            <span class="keywordflow">if</span>( (<a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa2eae0cce6a4993381c6c7c0278bad160">UBX_UPD_DOWNL</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)ram, <span class="keyword">sizeof</span>(ram), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) != 1) ||</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                (<a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa2eae0cce6a4993381c6c7c0278bad160">UBX_UPD_DOWNL</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)fpb, <span class="keyword">sizeof</span>(fpb), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) != 1) )</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            {</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Failed to send patch&quot;</span>);</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            }</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        }</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="comment">         * Update FIS for U-blox 9                         *</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        <span class="keywordflow">if</span>(!(updateRam != 0) &amp;&amp; generation &gt;= 90 &amp;&amp; !noFisMerging)</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        {</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            <span class="keywordflow">if</span> (!fis)</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;            {</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;FIS erroneously empty&quot;</span>);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;            }</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            <span class="keywordtype">int</span> state = <a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaf9e7a29b314222fac7e7646b96acd577">UBX_UPD_FIS</a>, fis, <span class="keyword">sizeof</span>(<a class="code" href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_t</a>), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;            <span class="keywordflow">if</span> (state == -1)</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            {</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;FIS message timed out&quot;</span>);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            }</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == 0)</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            {</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a>, <span class="stringliteral">&quot;FIS not accepted by receiver&quot;</span>);</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;            }</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;            {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;FIS sent to the receiver&quot;</span>);</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;            }</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        }</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        free(fis); <span class="comment">// free the memory</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <span class="keywordflow">if</span>(generation &gt;= 90 &amp;&amp; updateRam != 0)</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        {</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;            <span class="keywordflow">if</span>(!pData)</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;            <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="comment">             * Do the RAM update                               *</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;<span class="comment">             ***************************************************/</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Receiver info collected, downloading to RAM...&quot;</span>);</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;            <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> ramSuc = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;            <span class="keywordflow">if</span> (isSpiPort)</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;            {</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> spiCfgPayload[] = { 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00 }; <span class="comment">// UBX only, FF sup disabled, CPOL=CPHA=0, Tx ready disabled</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaedb737fb697bae964ab8d4a8aa642425">UBX_CFG_PORT</a>, spiCfgPayload, <span class="keyword">sizeof</span>(spiCfgPayload), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) != 1)</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                {</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;SPI configuration not accepted&quot;</span>);</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                    <span class="keywordflow">if</span> (imageGeneration == 90)</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                    {</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;MPW chip needs to be fused with patch 2 (spiCfg)&quot;</span>);</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                    }</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                }</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            }</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            ramSuc = <a class="code" href="update_8c.html#a831dfbba17f304c547b16b7062684825">updateImageToRam</a>(&amp;rx, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)pData, fileSize);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            <span class="keywordflow">if</span> (ramSuc == <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;            {</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;RAM image update failed&quot;</span>);</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;            }</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;        }</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        {</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;            <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="comment">             * Do the flash update                             *</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="comment">             ***************************************************/</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numberSectors;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;            <span class="keywordflow">if</span>(doChipErase)</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            {</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                <span class="keywordflow">if</span>(generation &gt; 70)</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                {</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                    <span class="comment">// we don&#39;t have to erase any sector afterwards because we do a chip erase</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                    numberSectors = 0;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9">UBX_UPD_CERASE</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) != 1)</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                    {</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Could not send chip erase command. Does the ROM support it?&quot;</span>);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                    }</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                    {</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333aadaa5a3fb3415c5881e70c7f762f8dd7">MSG_LEV2</a>, <span class="stringliteral">&quot;Chip erase started&quot;</span>);</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                        eraseInProgres = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                    }</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                }</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                {</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Chip erase no supported on this platform&quot;</span>);</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                }</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;            }</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;            {</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;                <span class="keywordflow">if</span>(EraseWholeFlash)</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;                {</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                    <span class="comment">// erase all the sectors</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                    numberSectors = <a class="code" href="flash_8c.html#a9ed55186a41b2a1bc2627838698bd56e">GetSectorNrForSize</a>(0, FlashSize, &amp;FlashOrg);</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;                }</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                {</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                    <span class="comment">// erase only the needed sectors</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;                    numberSectors = (EraseOnly) ? 1 : <a class="code" href="flash_8c.html#a9ed55186a41b2a1bc2627838698bd56e">GetSectorNrForSize</a>(0, fileSize, &amp;FlashOrg);</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                }</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;            }</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <a class="code" href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a> numberPackets = (fileSize % <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>) ?</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                fileSize / <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a> + 1 : fileSize / <a class="code" href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a>;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            upd = <a class="code" href="update_core_8c.html#a67c60123bde16f3fdf5a6e04c970bfce">updInit</a>(&amp;rx, numberSectors, numberPackets, &amp;FlashOrg, FlashSize, <a class="code" href="update_8h.html#a6c882f52a25019f41d30e7fb2314697e">DEFAULT_MAX_PACKETS</a>, eraseInProgres);</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            <span class="keywordflow">if</span>(!upd)</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="update_core_8c.html#a4c065d6b9a1ae76e08bde0a84ee898e7">updUpdate</a>(upd, pData, fileSize, FwBase))</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        }</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="comment">         * Invalidate patch for u-blox 7                   *</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        <span class="keywordflow">if</span>(generation == 70 &amp;&amp; hwRomVer == 100)</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        {</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;Invalidating timeout patch&quot;</span>);</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;            <a class="code" href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a> payloadInvPatch[] = { 0x20, 0x20, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;            <span class="keywordflow">if</span>( <a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa2eae0cce6a4993381c6c7c0278bad160">UBX_UPD_DOWNL</a>, (<a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a>*)payloadInvPatch, <span class="keyword">sizeof</span>(payloadInvPatch), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) != 1 )</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;            {</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Failed to invalidate patch&quot;</span>);</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;            }</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        }</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;<span class="comment">         * Write the marker to the flash to indicate       *</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;<span class="comment">         * the FS that the flash was completely erased     *</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="comment">         * Only u-blox8 supports this feature              *</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="comment">         * later platforms address this issue differently  *</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="comment">         * without the need for FW update tool support     *</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        <span class="keywordflow">if</span> (EraseWholeFlash &amp;&amp; generation == 80)</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        {</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;            <span class="comment">// check if the marker has to be written</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> address = 0;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;            <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> marker = 0xffffffff;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;            <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> imageSupportsFeature = <a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;            <span class="keywordflow">if</span> (fisOnly)</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;            {</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                <span class="comment">// we are going to run from ROM -&gt; write the marker to the second sector</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;                address = 0x1000;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;                <span class="comment">// u-blox8 ROM 3.01 supports this feature</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                <span class="keywordflow">if</span> ( hwRomVer == 301 )</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;                {</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;                    imageSupportsFeature = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                    marker = 0xee7b8f34;</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;                }</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;            }</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!EraseOnly)</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;            {</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;                <span class="keywordflow">if</span>(!pData)</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                <span class="comment">// we are going to run from flash -&gt; write the marker to the first sector following the image</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;                address = (((FwBase + fileSize) / 0x1000) + 1) * 0x1000;</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                <span class="keywordflow">if</span>( pData-&gt;<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">v1</a>.<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#a80ea4dffb8b98a9a40ff550214c9f5ce">fsErasedMarker</a> != 0xFFFFFFFF )</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                {</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                    imageSupportsFeature = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                    marker = pData-&gt;<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">v1</a>.<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#a80ea4dffb8b98a9a40ff550214c9f5ce">fsErasedMarker</a>;</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;                }</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;            }</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;            <span class="keywordflow">if</span>( imageSupportsFeature )</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;            {</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                <span class="keywordflow">if</span>(!pData)</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Writing marker for the file system to speed up first initialization&quot;</span>);</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> writeSize = <span class="keyword">sizeof</span>(pData-&gt;<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">v1</a>.<a class="code" href="union_f_w_h_e_a_d_e_r__u.html#a80ea4dffb8b98a9a40ff550214c9f5ce">fsErasedMarker</a>);</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                <span class="keyword">const</span> <a class="code" href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a> length = writeSize + 8;</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> *data = malloc(length);</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                <span class="keywordflow">if</span> (!data)</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                <span class="comment">//copy data to the send buffer</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                memcpy(data + 0, &amp;address,   4);                <span class="comment">// Address</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                memcpy(data + 4, &amp;writeSize, 4);                <span class="comment">// Data size</span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                memcpy(data + 8, &amp;marker,    <span class="keyword">sizeof</span>(marker));   <span class="comment">// Marker</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                <a class="code" href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_t</a> *msg = <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235">UBX_UPD_FLWRI</a>,</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                        data, length, <a class="code" href="update_core_8h.html#a3af75bd8417b347229705d6d522ad5c3">WRITE_TIMEOUT</a>);</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                free(data);</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                <span class="keywordflow">if</span>( msg == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> )</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                {</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Failed to write the marker&quot;</span>);</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;                }</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;                free(msg);</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            }</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        }</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;<span class="comment">         * Restart receiver if image is too large          *</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;<span class="comment">         * (Workaround for ROM bug)                        *</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> isGen70Rom100 = (generation == 70 &amp;&amp; hwRomVer == 100);</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> isGen80Rom22Or201 = (generation == 80 &amp;&amp; (hwRomVer == 22 || hwRomVer == 201));</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        <span class="keywordflow">if</span>( (fileSize &gt; 128 * 4096) &amp;&amp; (isGen70Rom100 || isGen80Rom22Or201))</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        {</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            <span class="comment">//send safeboot command</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;            <span class="keywordflow">if</span> (!isUsbPort)</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;            {</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Commanding Safeboot&quot;</span>);</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa375c3a5e3d34cc92292d9eff56f46bc">UBX_UPD_SAFE</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0))</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Safeboot failed.&quot;</span>);</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                }</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(500); <span class="comment">// wait until receiver is booted up</span></div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            }</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            {</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                <a class="code" href="update_8c.html#a27088cda5405506332f2528585e9f171">doReset</a>(&amp;rx, <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                <a class="code" href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a>(100); <span class="comment">// wait until receiver is booted up</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;            }</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;            <span class="comment">// Reenumerate the port</span></div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#acec694b60e783ae0e1a67028fa58a538">rcvReenumerate</a>(&amp;rx, isUsbPort))</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;            {</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Reenumerate failed&quot;</span>);</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;            }</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;            <span class="comment">// set the safeboot baudrate if not USB port</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;            <span class="keywordflow">if</span> (!isUsbPort)</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;            {</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#ae1ccf51e0ab5720c5cd5df1ae6bb6ae1">rcvSetBaud</a>(&amp;rx, BaudrateSafe))</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                {</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Safeboot Baud rate set failed.&quot;</span>);</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                }</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                <span class="comment">// send the training sequence</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                <span class="keywordflow">if</span> (TrainingSequence)</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;                {</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#ad3955f74acc89430ae3a7fd9511a128c">rcvSendTrainingSequence</a>(&amp;rx))</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                    {</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                        <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Sending training sequence failed&quot;</span>);</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                    }</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                }</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;            }</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;            {</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                <span class="comment">// disable GPS</span></div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Stop GPS operation&quot;</span>);</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> data[4] = { 0, 0, 8, 0 };</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                <span class="comment">// don&#39;t expect ACK</span></div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa0734cdb7e1bdb425d54a87bd1df0c3e">UBX_CFG_RST</a>, data, <span class="keyword">sizeof</span>(data)))</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                {</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Stopping GPS failed&quot;</span>);</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;                }</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                <span class="comment">// Start the loader task</span></div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Starting LDR TSK&quot;</span>);</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> pPayload[1] = { 0x01 };</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;                <span class="comment">// this message is assumed to be OK if ACKed or NAKed</span></div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa375c3a5e3d34cc92292d9eff56f46bc">UBX_UPD_SAFE</a>, pPayload, <span class="keyword">sizeof</span>(pPayload), <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>) == -1)</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;                {</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Starting flash loader failed&quot;</span>);</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;                }</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                {</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;                    <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a>, <span class="stringliteral">&quot;LDR TSK started successfully&quot;</span>);</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;                }</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;            }</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            monVer = DoAutobaud ?</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                <a class="code" href="receiver_8c.html#a8f85ccad88ab9bd614ff292202ba6ae3">rcvDoAutobaud</a>(&amp;rx, TrainingSequence) :</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                <a class="code" href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4f84234a418e7846f3e4805d6b27cbe7">UBX_CLASS_MON</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6433073287acd096f9c8b1f42a6a5a98">UBX_MON_VER</a>, <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a>);</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            <span class="keywordflow">if</span> (monVer == <a class="code" href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;            {</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Version is null&quot;</span>);</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;            }</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;            free(monVer);</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;        }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;<span class="comment">         * Verify that the image was written correctly     *</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        <span class="keywordflow">if</span> (!fisOnly &amp;&amp; !EraseOnly)</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        {</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            <a class="code" href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> verifySuccess;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;Verifying Image on hardware&quot;</span>);</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            verifySuccess = <a class="code" href="update_8c.html#afeba84c358a588c41f84c0513d3d33f0">verifyImage</a>(&amp;rx, pData, fileSize, FwBase, (updateRam != 0), (generation &gt;= 90) ? 2 : 1);</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            <span class="keywordflow">if</span> (!verifySuccess)</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;            {</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>,<span class="stringliteral">&quot;CRC check ERROR&quot;</span>);</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a>, <span class="stringliteral">&quot;Verify failed&quot;</span>);</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;            }</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;            <a class="code" href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a>(<a class="code" href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a>, <span class="stringliteral">&quot;CRC check SUCCESS&quot;</span>);</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        }</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        <span class="comment">/***************************************************</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="comment">         * Reset the receiver                              *</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment">         ***************************************************/</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        <span class="keywordflow">if</span> (DoReset &amp;&amp; updateRam != 0)</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        {</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            {</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                <span class="comment">// we cannot use UPD-RBOOT in this case</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                <span class="comment">// -&gt; use CFG-RST instead</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                <a class="code" href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a> data[4] = { -1, -1, 1, 0 };</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                <a class="code" href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a>(&amp;rx, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a>, <a class="code" href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa0734cdb7e1bdb425d54a87bd1df0c3e">UBX_CFG_RST</a>, data, <span class="keyword">sizeof</span>(data));</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;            }</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        }</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        {</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;            <a class="code" href="update_8c.html#a27088cda5405506332f2528585e9f171">doReset</a>(&amp;rx, DoReset);</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        }</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        <span class="comment">// Everything is fine</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        success = <a class="code" href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    } <span class="keywordflow">while</span> (<a class="code" href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="comment">// Clean up receiver interface if required</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keywordflow">if</span>( rcvConnected )</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        <a class="code" href="receiver_8c.html#a25e57cea9c0964f6be939cfb99fa1904">rcvDisconnect</a>(&amp;rx);</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <span class="comment">//clean up and exit</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    <span class="keywordflow">if</span> (pData)</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    {</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        free(pData);</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    }</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;    <span class="comment">// Free update core structure</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    <span class="keywordflow">if</span>(upd)</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        <a class="code" href="update_core_8c.html#a5b75de599f50c2489681e0ffc8432230">updDeinit</a>(upd);</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <a class="code" href="flash_8c.html#a39f7c222f9ecda58bc208006eae27fc6">clearBlocks</a>(&amp;FlashOrg);</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keywordflow">return</span> success;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;}</div>
<div class="ttc" id="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s_html"><div class="ttname"><a href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html">APP_UBX_UPD_IMG_PAYLOAD_s</a></div><div class="ttdoc">UBX-UPD-IMG message payload. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00086">ubxmsg.h:86</a></div></div>
<div class="ttc" id="update_8c_html_a336fee4cfa26042d208059390bba1aaa"><div class="ttname"><a href="update_8c.html#a336fee4cfa26042d208059390bba1aaa">extractHwGeneration</a></div><div class="ttdeci">static int extractHwGeneration(UBX_HEAD_t *monVer)</div><div class="ttdoc">Extracts the receiver hardware and software generation. </div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00115">update.c:115</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6b0eb8ee54694ef71ac6b453648edf9b">UBX_CLASS_UPD</a></div><div class="ttdoc">Class update. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00107">ubxmsg.h:107</a></div></div>
<div class="ttc" id="platform_8c_html_a3de0e43e9e5e923270a3fa4e6a2649fd"><div class="ttname"><a href="platform_8c.html#a3de0e43e9e5e923270a3fa4e6a2649fd">TIME_GET</a></div><div class="ttdeci">U4 TIME_GET(void)</div><div class="ttdoc">Get Timer. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00129">platform.c:129</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bca438c243b83c8cf9d481f62a8090a5502"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca438c243b83c8cf9d481f62a8090a5502">MERGEFIS_INCORRECT_XML</a></div><div class="ttdoc">Error in the XML structure. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00135">mergefis.h:135</a></div></div>
<div class="ttc" id="flash_8c_html_a5702805837058c6c3f8f51c0300d309e"><div class="ttname"><a href="flash_8c.html#a5702805837058c6c3f8f51c0300d309e">GetFlashOrganisation</a></div><div class="ttdeci">BOOL GetFlashOrganisation(U2 const ManId, U2 const DevId, BLOCK_ARR_pt pBlocks, U4 *const pSize, CH const *const Filename)</div><div class="ttdoc">Parse a file for flash memory architecture descriptions. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00331">flash.c:331</a></div></div>
<div class="ttc" id="receiver_8c_html_a8f85ccad88ab9bd614ff292202ba6ae3"><div class="ttname"><a href="receiver_8c.html#a8f85ccad88ab9bd614ff292202ba6ae3">rcvDoAutobaud</a></div><div class="ttdeci">UBX_HEAD_t * rcvDoAutobaud(RCV_DATA_t *rcv, BOOL sendTraining)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00304">receiver.c:304</a></div></div>
<div class="ttc" id="struct_u_b_x___c_f_g___p_r_t__s_html_a3f165dcf8cbbb07b1370eb46f2126533"><div class="ttname"><a href="struct_u_b_x___c_f_g___p_r_t__s.html#a3f165dcf8cbbb07b1370eb46f2126533">UBX_CFG_PRT_s::outProtoMask</a></div><div class="ttdeci">U2 outProtoMask</div><div class="ttdoc">Active output protocols. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00079">ubxmsg.h:79</a></div></div>
<div class="ttc" id="update_core_8c_html_a4c065d6b9a1ae76e08bde0a84ee898e7"><div class="ttname"><a href="update_core_8c.html#a4c065d6b9a1ae76e08bde0a84ee898e7">updUpdate</a></div><div class="ttdeci">BOOL updUpdate(UPD_CORE_t *upd, FWHEADER_t *data, size_t size, U4 fwBase)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00578">updateCore.c:578</a></div></div>
<div class="ttc" id="platform_8c_html_a893956021e39f080363c13adeea56462"><div class="ttname"><a href="platform_8c.html#a893956021e39f080363c13adeea56462">MESSAGE</a></div><div class="ttdeci">void MESSAGE(MSG_LEVEL level, const CH *format,...)</div><div class="ttdoc">Print status message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l01992">platform.c:1992</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bcaf8236a4c96b348374216a49de3a40a99"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcaf8236a4c96b348374216a49de3a40a99">MERGEFIS_UNKNOWN</a></div><div class="ttdoc">Unknown state. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00139">mergefis.h:139</a></div></div>
<div class="ttc" id="union_f_w_h_e_a_d_e_r__u_html_a61f4ebb2f5b2aee90ded2d80f4268a37"><div class="ttname"><a href="union_f_w_h_e_a_d_e_r__u.html#a61f4ebb2f5b2aee90ded2d80f4268a37">FWHEADER_u::pEnd</a></div><div class="ttdeci">U4 pEnd</div><div class="ttdoc">pEnd of this Firmware </div><div class="ttdef"><b>Definition:</b> <a href="image_8h_source.html#l00047">image.h:47</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bcafd1af2f55418d3261cde3af7084dd3f3"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcafd1af2f55418d3261cde3af7084dd3f3">MERGEFIS_CRC_FAILURE</a></div><div class="ttdoc">Overall CRC failure. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00138">mergefis.h:138</a></div></div>
<div class="ttc" id="update_core_8c_html_a5b75de599f50c2489681e0ffc8432230"><div class="ttname"><a href="update_core_8c.html#a5b75de599f50c2489681e0ffc8432230">updDeinit</a></div><div class="ttdeci">void updDeinit(UPD_CORE_t *upd)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00563">updateCore.c:563</a></div></div>
<div class="ttc" id="update_core_8h_html_a177e4581349927b04d81ac62ed804377"><div class="ttname"><a href="update_core_8h.html#a177e4581349927b04d81ac62ed804377">PACKETSIZE</a></div><div class="ttdeci">#define PACKETSIZE</div><div class="ttdoc">size of a packet to send to the receiver </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00037">updateCore.h:37</a></div></div>
<div class="ttc" id="types_8h_html_a79199901c1122f5e17970b6887de3d6a"><div class="ttname"><a href="types_8h.html#a79199901c1122f5e17970b6887de3d6a">U1</a></div><div class="ttdeci">unsigned __int8 U1</div><div class="ttdoc">8-bit unsigned integer number(unsigned character) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00058">types.h:58</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bca7c0065141b8bd3d5c66108547099bcb4"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca7c0065141b8bd3d5c66108547099bcb4">MERGEFIS_VERSION_ERROR</a></div><div class="ttdoc">Versions do not match. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00134">mergefis.h:134</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa106c9b9bf52d08b3e9e128c637aa8570"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa106c9b9bf52d08b3e9e128c637aa8570">UBX_CLASS_ACK</a></div><div class="ttdoc">Class acknowledge. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00105">ubxmsg.h:105</a></div></div>
<div class="ttc" id="struct_u_b_x___a_c_k___a_c_k__s_html_a59f6080e4395185cab90c54e624695bc"><div class="ttname"><a href="struct_u_b_x___a_c_k___a_c_k__s.html#a59f6080e4395185cab90c54e624695bc">UBX_ACK_ACK_s::msgId</a></div><div class="ttdeci">U1 msgId</div><div class="ttdoc">Message ID to be ACK/NAKed. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00067">ubxmsg.h:67</a></div></div>
<div class="ttc" id="flash_8c_html_a9ed55186a41b2a1bc2627838698bd56e"><div class="ttname"><a href="flash_8c.html#a9ed55186a41b2a1bc2627838698bd56e">GetSectorNrForSize</a></div><div class="ttdeci">I4 GetSectorNrForSize(const U4 Offset, const U4 FwSize, const BLOCK_ARR_pt pFlashdef)</div><div class="ttdoc">Get the number of sectors the firmware fits in. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00169">flash.c:169</a></div></div>
<div class="ttc" id="platform_8c_html_a0b2caeb4b6f130be43e5a2f0267dd453"><div class="ttname"><a href="platform_8c.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a></div><div class="ttdeci">int verbose</div><div class="ttdoc">verbosity </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00111">platform.c:111</a></div></div>
<div class="ttc" id="struct_u_p_d___c_o_r_e__t_html"><div class="ttname"><a href="struct_u_p_d___c_o_r_e__t.html">UPD_CORE_t</a></div><div class="ttdoc">Preserves the state of the upgrade and the organization of the flash. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00063">updateCore.h:63</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa42a3b048fe42539073752e0e4bb9b0c9">UBX_UPD_CERASE</a></div><div class="ttdoc">Chip erase (NDA 15+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00120">ubxmsg.h:120</a></div></div>
<div class="ttc" id="types_8h_html_a05882823395fd219ae0b65679baa29c4"><div class="ttname"><a href="types_8h.html#a05882823395fd219ae0b65679baa29c4">U4</a></div><div class="ttdeci">unsigned __int32 U4</div><div class="ttdoc">32-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00054">types.h:54</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bca4e1c9509cd502b478135636e7aeec106"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca4e1c9509cd502b478135636e7aeec106">MERGEFIS_JEDEC_NOT_SUPPORTED</a></div><div class="ttdoc">JEDEC not supported by this FIS file. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00136">mergefis.h:136</a></div></div>
<div class="ttc" id="struct_b_l_o_c_k___d_e_f__s_html_a6fc5bf08cb60b3a7938847e33aec0953"><div class="ttname"><a href="struct_b_l_o_c_k___d_e_f__s.html#a6fc5bf08cb60b3a7938847e33aec0953">BLOCK_DEF_s::Size</a></div><div class="ttdeci">U4 Size</div><div class="ttdoc">size of sector in kB </div><div class="ttdef"><b>Definition:</b> <a href="flash_8h_source.html#l00044">flash.h:44</a></div></div>
<div class="ttc" id="mergefis_8h_html_a21f89fbfd20d36cef02adcde686f7aad"><div class="ttname"><a href="mergefis_8h.html#a21f89fbfd20d36cef02adcde686f7aad">MAJOR_REV_POSITION</a></div><div class="ttdeci">#define MAJOR_REV_POSITION</div><div class="ttdoc">Position of the Major revison in Version 3 of FIS. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00060">mergefis.h:60</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa1b740791eb61edde554766fcbdd2e235">UBX_UPD_FLWRI</a></div><div class="ttdoc">Flash write (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00125">ubxmsg.h:125</a></div></div>
<div class="ttc" id="struct_u_b_x___c_f_g___p_r_t__s_html"><div class="ttname"><a href="struct_u_b_x___c_f_g___p_r_t__s.html">UBX_CFG_PRT_s</a></div><div class="ttdoc">UBX-CFG-PRT message payload. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00071">ubxmsg.h:71</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaaa0734cdb7e1bdb425d54a87bd1df0c3e"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa0734cdb7e1bdb425d54a87bd1df0c3e">UBX_CFG_RST</a></div><div class="ttdoc">Reset receiver (PUB 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00116">ubxmsg.h:116</a></div></div>
<div class="ttc" id="platform_8h_html"><div class="ttname"><a href="platform_8h.html">platform.h</a></div><div class="ttdoc">Defines and Prototypes for platform specifics. </div></div>
<div class="ttc" id="mergefis_8h_html_ab2be27b3b4a1635812e4753d15ec5f9f"><div class="ttname"><a href="mergefis_8h.html#ab2be27b3b4a1635812e4753d15ec5f9f">MINOR_REV_POSITION</a></div><div class="ttdeci">#define MINOR_REV_POSITION</div><div class="ttdoc">Position of the Minor revison in Version 3 of FIS. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00061">mergefis.h:61</a></div></div>
<div class="ttc" id="struct_u_b_x___a_c_k___a_c_k__s_html_ac3d6af1a3015658509c0dafb8f6ceb7a"><div class="ttname"><a href="struct_u_b_x___a_c_k___a_c_k__s.html#ac3d6af1a3015658509c0dafb8f6ceb7a">UBX_ACK_ACK_s::clsId</a></div><div class="ttdeci">U1 clsId</div><div class="ttdoc">Class ID to be ACK/NAKed. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00066">ubxmsg.h:66</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333af369b3edb73a3b6e9ec208dc312f9bd6">MSG_ERR</a></div><div class="ttdoc">Error message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00218">platform.h:218</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html_a9a428e9f3708855941db98ea8fe9bbc4"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html#a9a428e9f3708855941db98ea8fe9bbc4">UBX_HEAD_s::msgId</a></div><div class="ttdeci">U1 msgId</div><div class="ttdoc">UBX Message Id. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00058">ubxmsg.h:58</a></div></div>
<div class="ttc" id="platform_8c_html_af7851ef9e3a8ddb893d2f1af81c11296"><div class="ttname"><a href="platform_8c.html#af7851ef9e3a8ddb893d2f1af81c11296">TIME_SLEEP</a></div><div class="ttdeci">void TIME_SLEEP(U4 ms)</div><div class="ttdoc">Sleep. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8c_source.html#l00120">platform.c:120</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a26744ba2d7512da500888e67b798e085">MSG_WARN</a></div><div class="ttdoc">Warning message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00219">platform.h:219</a></div></div>
<div class="ttc" id="receiver_8c_html_ae0a9b8dd16e773cc5ef09b6206e74580"><div class="ttname"><a href="receiver_8c.html#ae0a9b8dd16e773cc5ef09b6206e74580">rcvSendMessage</a></div><div class="ttdeci">BOOL rcvSendMessage(RCV_DATA_t *rcv, U1 classId, U1 msgId, CH *payload, U4 payloadSize)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00142">receiver.c:142</a></div></div>
<div class="ttc" id="receiver_8c_html_ae1ccf51e0ab5720c5cd5df1ae6bb6ae1"><div class="ttname"><a href="receiver_8c.html#ae1ccf51e0ab5720c5cd5df1ae6bb6ae1">rcvSetBaud</a></div><div class="ttdeci">BOOL rcvSetBaud(RCV_DATA_t *rcv, int baud)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00344">receiver.c:344</a></div></div>
<div class="ttc" id="update_core_8h_html_ad35c1036b7f001b47306c58a18329400"><div class="ttname"><a href="update_core_8h.html#ad35c1036b7f001b47306c58a18329400">RAM_BASE</a></div><div class="ttdeci">#define RAM_BASE</div><div class="ttdoc">RAM base address. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00045">updateCore.h:45</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad15c1443fc0b119d1d19ce1612a6834a">MSG_LEV1</a></div><div class="ttdoc">Verbosity Level 1 message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00224">platform.h:224</a></div></div>
<div class="ttc" id="update_core_8h_html_a23a9099a5f8fc9c6e253c0eecb2be8db"><div class="ttname"><a href="update_core_8h.html#a23a9099a5f8fc9c6e253c0eecb2be8db">FLASH_BASE</a></div><div class="ttdeci">#define FLASH_BASE</div><div class="ttdoc">Flash base address. </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00044">updateCore.h:44</a></div></div>
<div class="ttc" id="update_8c_html_a831dfbba17f304c547b16b7062684825"><div class="ttname"><a href="update_8c.html#a831dfbba17f304c547b16b7062684825">updateImageToRam</a></div><div class="ttdeci">static BOOL updateImageToRam(RCV_DATA_t *pRx, const CH *pImageStart, U4 ImageSize)</div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00221">update.c:221</a></div></div>
<div class="ttc" id="receiver_8c_html_a02c74cd7d3d7df99a9d5abb45cfb5a58"><div class="ttname"><a href="receiver_8c.html#a02c74cd7d3d7df99a9d5abb45cfb5a58">rcvReceiveMessage</a></div><div class="ttdeci">UBX_HEAD_t * rcvReceiveMessage(RCV_DATA_t *rcv, U4 timeout, I4 classId, I4 msgId)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00232">receiver.c:232</a></div></div>
<div class="ttc" id="types_8h_html_af46a6e340cd583b499789b9bb39f7809"><div class="ttname"><a href="types_8h.html#af46a6e340cd583b499789b9bb39f7809">I4</a></div><div class="ttdeci">signed __int32 I4</div><div class="ttdoc">32-bit signed integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00053">types.h:53</a></div></div>
<div class="ttc" id="types_8h_html_a050c65e107f0c828f856a231f4b4e788"><div class="ttname"><a href="types_8h.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a></div><div class="ttdeci">int BOOL</div><div class="ttdoc">Boolean type. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00073">types.h:73</a></div></div>
<div class="ttc" id="mergefis_8c_html_a5736369b7efb562e0d1726ac6cb46657"><div class="ttname"><a href="mergefis_8c.html#a5736369b7efb562e0d1726ac6cb46657">mergefis_get_sector_count</a></div><div class="ttdeci">unsigned int mergefis_get_sector_count(char const *fis)</div><div class="ttdoc">Return the sector count in the FIS. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8c_source.html#l01160">mergefis.c:1160</a></div></div>
<div class="ttc" id="flash_8c_html_ade5f330c48bccf916d165e62b50c9df8"><div class="ttname"><a href="flash_8c.html#ade5f330c48bccf916d165e62b50c9df8">addBlock</a></div><div class="ttdeci">BOOL addBlock(BLOCK_ARR_pt pBlocks, BLOCK_DEF_pt const pNewBlock)</div><div class="ttdoc">Clear the array of block contents. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00470">flash.c:470</a></div></div>
<div class="ttc" id="receiver_8c_html_abf356466ee61091ed0c1f4dfb70ffa7d"><div class="ttname"><a href="receiver_8c.html#abf356466ee61091ed0c1f4dfb70ffa7d">rcvPollMessage</a></div><div class="ttdeci">UBX_HEAD_t * rcvPollMessage(RCV_DATA_t *rcv, U1 classId, U1 msgId, CH *payload, U4 payloadSize, U4 timeout)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00170">receiver.c:170</a></div></div>
<div class="ttc" id="struct_u_b_x___a_c_k___a_c_k__s_html"><div class="ttname"><a href="struct_u_b_x___a_c_k___a_c_k__s.html">UBX_ACK_ACK_s</a></div><div class="ttdoc">UBX-ACK-ACK and UBX-ACK-NAK messages. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00064">ubxmsg.h:64</a></div></div>
<div class="ttc" id="version_8h_html_a64d7b69eb90245360974277068bd3e4a"><div class="ttname"><a href="version_8h.html#a64d7b69eb90245360974277068bd3e4a">PRODUCTVERSTR</a></div><div class="ttdeci">#define PRODUCTVERSTR</div><div class="ttdoc">Product version string. </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00038">version.h:38</a></div></div>
<div class="ttc" id="types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdoc">Boolean FALSE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00075">types.h:75</a></div></div>
<div class="ttc" id="mergefis_8c_html_a5ed5ea69800bed0f911492a7a79d7708"><div class="ttname"><a href="mergefis_8c.html#a5ed5ea69800bed0f911492a7a79d7708">mergefis_get_sector_size</a></div><div class="ttdeci">unsigned int mergefis_get_sector_size(char const *fis)</div><div class="ttdoc">Return the sector size in the FIS. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8c_source.html#l01176">mergefis.c:1176</a></div></div>
<div class="ttc" id="mergefis_8h_html"><div class="ttname"><a href="mergefis_8h.html">mergefis.h</a></div><div class="ttdoc">Loads and parses a FIS file and merges the file with the binary. </div></div>
<div class="ttc" id="image_8h_html"><div class="ttname"><a href="image_8h.html">image.h</a></div><div class="ttdoc">Definitions concerning the firmware image. </div></div>
<div class="ttc" id="receiver_8c_html_a1873dd0baccb35706c7792cab2b59724"><div class="ttname"><a href="receiver_8c.html#a1873dd0baccb35706c7792cab2b59724">rcvFlushBuffer</a></div><div class="ttdeci">void rcvFlushBuffer(RCV_DATA_t *rcv)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00361">receiver.c:361</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaadfdde5d08d373820119e962ea93211ec"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaadfdde5d08d373820119e962ea93211ec">UBX_ACK_ACK</a></div><div class="ttdoc">Acknowledged (PUB 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00112">ubxmsg.h:112</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bcaa0d352b55efc138b8ca352176afd7a38"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bcaa0d352b55efc138b8ca352176afd7a38">MERGEFIS_CODE_CORRUPTED</a></div><div class="ttdoc">Code corrupted. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00137">mergefis.h:137</a></div></div>
<div class="ttc" id="struct_u_b_x___c_f_g___p_r_t__s_html_a5f0c37ecb075fb6722d34ece6c327645"><div class="ttname"><a href="struct_u_b_x___c_f_g___p_r_t__s.html#a5f0c37ecb075fb6722d34ece6c327645">UBX_CFG_PRT_s::baudrate</a></div><div class="ttdeci">U4 baudrate</div><div class="ttdoc">Baudrate bit/s. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00077">ubxmsg.h:77</a></div></div>
<div class="ttc" id="union_f_w_h_e_a_d_e_r__u_html_a80ea4dffb8b98a9a40ff550214c9f5ce"><div class="ttname"><a href="union_f_w_h_e_a_d_e_r__u.html#a80ea4dffb8b98a9a40ff550214c9f5ce">FWHEADER_u::fsErasedMarker</a></div><div class="ttdeci">U4 fsErasedMarker</div><div class="ttdoc">marker to indicate the FS a completely erased flash (not used anymore) </div><div class="ttdef"><b>Definition:</b> <a href="image_8h_source.html#l00050">image.h:50</a></div></div>
<div class="ttc" id="image_8c_html_a9e7479197d9de9e51a74f08602d762d5"><div class="ttname"><a href="image_8c.html#a9e7479197d9de9e51a74f08602d762d5">ValidateImage</a></div><div class="ttdeci">U4 ValidateImage(FWHEADER_t const *pImage, const size_t fileSize, FWFOOTERINFO_t *pFwFooter)</div><div class="ttdoc">Validate firmware image. </div><div class="ttdef"><b>Definition:</b> <a href="image_8c_source.html#l00051">image.c:51</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bca1c452f34a43f480ec23a6fef45eeee55"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca1c452f34a43f480ec23a6fef45eeee55">MERGEFIS_OK</a></div><div class="ttdoc">All OK. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00132">mergefis.h:132</a></div></div>
<div class="ttc" id="types_8h_html_a3acffbd305ee72dcd4593c0d8af64a4f"><div class="ttname"><a href="types_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a></div><div class="ttdeci">#define MIN(a, b)</div><div class="ttdoc">minimum define </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00101">types.h:101</a></div></div>
<div class="ttc" id="image_8c_html_ab59ad229220ddf25bcbea31620cb59fd"><div class="ttname"><a href="image_8c.html#ab59ad229220ddf25bcbea31620cb59fd">OpenAndBufferFile</a></div><div class="ttdeci">BOOL OpenAndBufferFile(const CH *BinaryFileName, FWHEADER_t **ppFileContent, size_t *pFileSize)</div><div class="ttdoc">Open file and buffer it in RAM. </div><div class="ttdef"><b>Definition:</b> <a href="image_8c_source.html#l00165">image.c:165</a></div></div>
<div class="ttc" id="struct_r_c_v___d_a_t_a__t_html"><div class="ttname"><a href="struct_r_c_v___d_a_t_a__t.html">RCV_DATA_t</a></div><div class="ttdoc">Structure that defines a connection. </div><div class="ttdef"><b>Definition:</b> <a href="receiver_8h_source.html#l00064">receiver.h:64</a></div></div>
<div class="ttc" id="update_8c_html_afeba84c358a588c41f84c0513d3d33f0"><div class="ttname"><a href="update_8c.html#afeba84c358a588c41f84c0513d3d33f0">verifyImage</a></div><div class="ttdeci">static BOOL verifyImage(RCV_DATA_t *pRx, FWHEADER_t const *pData, U4 fileSize, U4 address, BOOL updateRam, U4 version)</div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00164">update.c:164</a></div></div>
<div class="ttc" id="receiver_8c_html_acec694b60e783ae0e1a67028fa58a538"><div class="ttname"><a href="receiver_8c.html#acec694b60e783ae0e1a67028fa58a538">rcvReenumerate</a></div><div class="ttdeci">BOOL rcvReenumerate(RCV_DATA_t *rcv, BOOL isUsbPort)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00284">receiver.c:284</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa563df58385da1413e34adb760d175a1c"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa563df58385da1413e34adb760d175a1c">UBX_UPD_FLDET</a></div><div class="ttdoc">Detect flash (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00124">ubxmsg.h:124</a></div></div>
<div class="ttc" id="flash_8c_html_a39f7c222f9ecda58bc208006eae27fc6"><div class="ttname"><a href="flash_8c.html#a39f7c222f9ecda58bc208006eae27fc6">clearBlocks</a></div><div class="ttdeci">void clearBlocks(BLOCK_ARR_pt pBlocks)</div><div class="ttdoc">Clear the array of block contents. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00460">flash.c:460</a></div></div>
<div class="ttc" id="struct_u_b_x___c_f_g___p_r_t__s_html_ada60d7aab2055028d1a303f2515bf24c"><div class="ttname"><a href="struct_u_b_x___c_f_g___p_r_t__s.html#ada60d7aab2055028d1a303f2515bf24c">UBX_CFG_PRT_s::portId</a></div><div class="ttdeci">U1 portId</div><div class="ttdoc">Port Identifier Number. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00073">ubxmsg.h:73</a></div></div>
<div class="ttc" id="update_core_8c_html_a67c60123bde16f3fdf5a6e04c970bfce"><div class="ttname"><a href="update_core_8c.html#a67c60123bde16f3fdf5a6e04c970bfce">updInit</a></div><div class="ttdeci">UPD_CORE_t * updInit(RCV_DATA_t *rx, I4 numberSectors, I4 numberPackets, BLOCK_ARR_t *flashOrg, U4 flashSize, U4 MaxPendingWritesNum, BOOL eraseInProgres)</div><div class="ttdef"><b>Definition:</b> <a href="update_core_8c_source.html#l00480">updateCore.c:480</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa6433073287acd096f9c8b1f42a6a5a98"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa6433073287acd096f9c8b1f42a6a5a98">UBX_MON_VER</a></div><div class="ttdoc">version information (PUB 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00138">ubxmsg.h:138</a></div></div>
<div class="ttc" id="types_8h_html_a1d40f5629841850bfb5fe78be26d89ad"><div class="ttname"><a href="types_8h.html#a1d40f5629841850bfb5fe78be26d89ad">U</a></div><div class="ttdeci">unsigned int U</div><div class="ttdoc">Unsigned integer number. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00063">types.h:63</a></div></div>
<div class="ttc" id="receiver_8c_html_a25e57cea9c0964f6be939cfb99fa1904"><div class="ttname"><a href="receiver_8c.html#a25e57cea9c0964f6be939cfb99fa1904">rcvDisconnect</a></div><div class="ttdeci">void rcvDisconnect(RCV_DATA_t *rcv)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00118">receiver.c:118</a></div></div>
<div class="ttc" id="struct_u_b_x___c_f_g___p_r_t__s_html_abadd720b5a6f5bc6820db38095e58dc1"><div class="ttname"><a href="struct_u_b_x___c_f_g___p_r_t__s.html#abadd720b5a6f5bc6820db38095e58dc1">UBX_CFG_PRT_s::inProtoMask</a></div><div class="ttdeci">U2 inProtoMask</div><div class="ttdoc">Active input protocols. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00078">ubxmsg.h:78</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333aadaa5a3fb3415c5881e70c7f762f8dd7"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333aadaa5a3fb3415c5881e70c7f762f8dd7">MSG_LEV2</a></div><div class="ttdoc">Verbosity Level 2 message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00225">platform.h:225</a></div></div>
<div class="ttc" id="update_core_8h_html"><div class="ttname"><a href="update_core_8h.html">updateCore.h</a></div><div class="ttdoc">Declaration of function that handle the update on the receiver. </div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa8916c80f7aebca3e4aea158533187d0e"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa8916c80f7aebca3e4aea158533187d0e">UBX_UPD_AUTHREAD</a></div><div class="ttdoc">Read with signature (RD 18+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00119">ubxmsg.h:119</a></div></div>
<div class="ttc" id="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s_html_a148928757bf6fd17dbe66bc2e7e8076b"><div class="ttname"><a href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a148928757bf6fd17dbe66bc2e7e8076b">APP_UBX_UPD_IMG_PAYLOAD_s::chunkData</a></div><div class="ttdeci">U1 chunkData[512]</div><div class="ttdoc">Image data. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00089">ubxmsg.h:89</a></div></div>
<div class="ttc" id="types_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="types_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdoc">Null. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00078">types.h:78</a></div></div>
<div class="ttc" id="checksum_8c_html_ac4a4eabfc8bef0e9ce8d9ada641b67fb"><div class="ttname"><a href="checksum_8c.html#ac4a4eabfc8bef0e9ce8d9ada641b67fb">GetUbxChecksumU4</a></div><div class="ttdeci">void GetUbxChecksumU4(U4 *pChk_a, U4 *pChk_b, const U4 *pData, size_t numBytes)</div><div class="ttdoc">Calculate UBX checksum over pData. </div><div class="ttdef"><b>Definition:</b> <a href="checksum_8c_source.html#l00033">checksum.c:33</a></div></div>
<div class="ttc" id="update_8c_html_a0792eb6101efca31a477332c44b335f3"><div class="ttname"><a href="update_8c.html#a0792eb6101efca31a477332c44b335f3">HW_IMG_MAGIC_DOM</a></div><div class="ttdeci">#define HW_IMG_MAGIC_DOM</div><div class="ttdoc">EXT image magic word for DOM. </div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00059">update.c:59</a></div></div>
<div class="ttc" id="struct_b_l_o_c_k___d_e_f__s_html_a1cd9965ad2a859bc2970376129ad1fa9"><div class="ttname"><a href="struct_b_l_o_c_k___d_e_f__s.html#a1cd9965ad2a859bc2970376129ad1fa9">BLOCK_DEF_s::Count</a></div><div class="ttdeci">U4 Count</div><div class="ttdoc">number of sectors </div><div class="ttdef"><b>Definition:</b> <a href="flash_8h_source.html#l00043">flash.h:43</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaafbce5122210dd6e4f4b2c295d96efcd6"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaafbce5122210dd6e4f4b2c295d96efcd6">UBX_UPD_CRC</a></div><div class="ttdoc">Check CRC (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00121">ubxmsg.h:121</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bca4671f9f3f6c0099fdd88d7eb2e91e00d"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bca4671f9f3f6c0099fdd88d7eb2e91e00d">MERGEFIS_FILE_NOT_FOUND</a></div><div class="ttdoc">Could not find the FIS file. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00133">mergefis.h:133</a></div></div>
<div class="ttc" id="receiver_8c_html_a074f16ec30ce655cbcaa84e5641b4d8c"><div class="ttname"><a href="receiver_8c.html#a074f16ec30ce655cbcaa84e5641b4d8c">rcvConnect</a></div><div class="ttdeci">BOOL rcvConnect(RCV_DATA_t *rcv, const CH *comPort, U4 baudrate)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00095">receiver.c:95</a></div></div>
<div class="ttc" id="update_8c_html_a27088cda5405506332f2528585e9f171"><div class="ttname"><a href="update_8c.html#a27088cda5405506332f2528585e9f171">doReset</a></div><div class="ttdeci">static void doReset(RCV_DATA_t *pRx, BOOL reset)</div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00208">update.c:208</a></div></div>
<div class="ttc" id="version_8h_html"><div class="ttname"><a href="version_8h.html">version.h</a></div><div class="ttdoc">version information </div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaaec4951cfe8176d4f2162af8c8256f6aa"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaec4951cfe8176d4f2162af8c8256f6aa">UBX_UPD_IMG</a></div><div class="ttdoc">Update RAM image (NDA 23) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00133">ubxmsg.h:133</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html">UBX_HEAD_s</a></div><div class="ttdoc">UBX Protocol Header. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00054">ubxmsg.h:54</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaab66352edded823ec830d2cc88a15afbf"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaab66352edded823ec830d2cc88a15afbf">UBX_UPD_UPLOAD</a></div><div class="ttdoc">Memory read (NDA 10-17) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00131">ubxmsg.h:131</a></div></div>
<div class="ttc" id="types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdoc">Boolean TRUE. </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00076">types.h:76</a></div></div>
<div class="ttc" id="union_f_w_h_e_a_d_e_r__u_html"><div class="ttname"><a href="union_f_w_h_e_a_d_e_r__u.html">FWHEADER_u</a></div><div class="ttdoc">Header of firmware image. </div><div class="ttdef"><b>Definition:</b> <a href="image_8h_source.html#l00038">image.h:38</a></div></div>
<div class="ttc" id="update_core_8h_html_a51fb6ccd37b6edb264095f862074a4f3"><div class="ttname"><a href="update_core_8h.html#a51fb6ccd37b6edb264095f862074a4f3">CRC_TIMEOUT</a></div><div class="ttdeci">#define CRC_TIMEOUT</div><div class="ttdoc">timeout for the CRC computation </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00039">updateCore.h:39</a></div></div>
<div class="ttc" id="mergefis_8c_html_a355730c88715f80ba18bd8cce877e1bc"><div class="ttname"><a href="mergefis_8c.html#a355730c88715f80ba18bd8cce877e1bc">mergefis_load</a></div><div class="ttdeci">MERGEFIS_RETVAL_t mergefis_load(char **fis, size_t *fisSize, const char *fisFile, const unsigned int jedec)</div><div class="ttdoc">Get the image of the FIS. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8c_source.html#l01407">mergefis.c:1407</a></div></div>
<div class="ttc" id="struct_b_l_o_c_k___d_e_f__s_html"><div class="ttname"><a href="struct_b_l_o_c_k___d_e_f__s.html">BLOCK_DEF_s</a></div><div class="ttdoc">Flash sector block organization description. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8h_source.html#l00041">flash.h:41</a></div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333ad2103d9025b58432b1f33d48d87d2ec8">MSG_DBG</a></div><div class="ttdoc">Debug message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00226">platform.h:226</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaaedb737fb697bae964ab8d4a8aa642425"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaedb737fb697bae964ab8d4a8aa642425">UBX_CFG_PORT</a></div><div class="ttdoc">Configure port (PUB 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00115">ubxmsg.h:115</a></div></div>
<div class="ttc" id="mergefis_8h_html_af9aba48786e0fc968a01c5aee8f22e61"><div class="ttname"><a href="mergefis_8h.html#af9aba48786e0fc968a01c5aee8f22e61">DRV_SPI_MEM_FIS_t</a></div><div class="ttdeci">struct DRV_SPI_MEM_FIS_s DRV_SPI_MEM_FIS_t</div><div class="ttdoc">FIS header structure. </div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa4f84234a418e7846f3e4805d6b27cbe7"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa4f84234a418e7846f3e4805d6b27cbe7">UBX_CLASS_MON</a></div><div class="ttdoc">Class monitor. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00108">ubxmsg.h:108</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a5a802d4c63ef065926e9508383f43e3d"><div class="ttname"><a href="ubxmsg_8h.html#a5a802d4c63ef065926e9508383f43e3d">UBX_HEAD_SIZE</a></div><div class="ttdeci">#define UBX_HEAD_SIZE</div><div class="ttdoc">UBX Protocol Header Size. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00097">ubxmsg.h:97</a></div></div>
<div class="ttc" id="struct_u_b_x___c_f_g___p_r_t__s_html_a6c903e7ed26f1bb82b677dcea21369bc"><div class="ttname"><a href="struct_u_b_x___c_f_g___p_r_t__s.html#a6c903e7ed26f1bb82b677dcea21369bc">UBX_CFG_PRT_s::mode</a></div><div class="ttdeci">U4 mode</div><div class="ttdoc">UART mode. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00076">ubxmsg.h:76</a></div></div>
<div class="ttc" id="update_8h_html_a6c882f52a25019f41d30e7fb2314697e"><div class="ttname"><a href="update_8h.html#a6c882f52a25019f41d30e7fb2314697e">DEFAULT_MAX_PACKETS</a></div><div class="ttdeci">#define DEFAULT_MAX_PACKETS</div><div class="ttdef"><b>Definition:</b> <a href="update_8h_source.html#l00037">update.h:37</a></div></div>
<div class="ttc" id="struct_d_r_v___s_p_i___m_e_m___f_i_s__s_html"><div class="ttname"><a href="struct_d_r_v___s_p_i___m_e_m___f_i_s__s.html">DRV_SPI_MEM_FIS_s</a></div><div class="ttdoc">FIS header structure. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00114">mergefis.h:114</a></div></div>
<div class="ttc" id="receiver_8h_html_a9301f41bfe2a17a4add6f0dc7f239487"><div class="ttname"><a href="receiver_8h.html#a9301f41bfe2a17a4add6f0dc7f239487">POLL_TIMEOUT</a></div><div class="ttdeci">#define POLL_TIMEOUT</div><div class="ttdoc">timeout for getting a polled message </div><div class="ttdef"><b>Definition:</b> <a href="receiver_8h_source.html#l00044">receiver.h:44</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa24b1b8c79c36b65b44fa1c9c1e5424a2"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa24b1b8c79c36b65b44fa1c9c1e5424a2">UBX_UPD_RBOOT</a></div><div class="ttdoc">Reboot (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00128">ubxmsg.h:128</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa471653a65c14d72ed8778f5a5a9687d2"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa471653a65c14d72ed8778f5a5a9687d2">UBX_UPD_ROM</a></div><div class="ttdoc">Rom CRC (NDA 24+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00135">ubxmsg.h:135</a></div></div>
<div class="ttc" id="update_8c_html_a91fe63423c374194e5090f96e17064a6"><div class="ttname"><a href="update_8c.html#a91fe63423c374194e5090f96e17064a6">UpdateFirmware</a></div><div class="ttdeci">BOOL UpdateFirmware(const char *BinaryFileName, const char *FlashDefFileName, const char *FisFileName, const char *ComPort, const unsigned int Baudrate, const unsigned int BaudrateSafe, const unsigned int BaudrateUpd, BOOL DoSafeBoot, const BOOL DoReset, const BOOL DoAutobaud, const BOOL EraseWholeFlash, const BOOL EraseOnly, const BOOL TrainingSequence, const BOOL doChipErase, BOOL noFisMerging, BOOL updateRam, const BOOL usbAltMode, const int Verbose, const BOOL fisOnly)</div><div class="ttdoc">Perform Firmware update process. </div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00308">update.c:308</a></div></div>
<div class="ttc" id="mergefis_8h_html_a76bb128434d9bcf2485c8f7d10b415bc"><div class="ttname"><a href="mergefis_8h.html#a76bb128434d9bcf2485c8f7d10b415bc">MERGEFIS_RETVAL_t</a></div><div class="ttdeci">MERGEFIS_RETVAL_t</div><div class="ttdoc">Defines the return value of the mergefis_load function. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00131">mergefis.h:131</a></div></div>
<div class="ttc" id="receiver_8c_html_afc7578b97353f27a1562776a50518e0f"><div class="ttname"><a href="receiver_8c.html#afc7578b97353f27a1562776a50518e0f">rcvAckMessage</a></div><div class="ttdeci">int rcvAckMessage(RCV_DATA_t *rcv, U1 classId, U1 msgId, CH *payload, U4 payloadSize, U4 timeout)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00193">receiver.c:193</a></div></div>
<div class="ttc" id="types_8h_html_ac82fb958e48c78b4698b16a3c4bd745f"><div class="ttname"><a href="types_8h.html#ac82fb958e48c78b4698b16a3c4bd745f">U2</a></div><div class="ttdeci">unsigned __int16 U2</div><div class="ttdoc">16-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00056">types.h:56</a></div></div>
<div class="ttc" id="checksum_8h_html"><div class="ttname"><a href="checksum_8h.html">checksum.h</a></div><div class="ttdoc">checksum routines for UBX protocol and firmware image </div></div>
<div class="ttc" id="union_f_w_h_e_a_d_e_r__u_html_a584b27340c18f4c0a012666ccd81ad01"><div class="ttname"><a href="union_f_w_h_e_a_d_e_r__u.html#a584b27340c18f4c0a012666ccd81ad01">FWHEADER_u::pBase</a></div><div class="ttdeci">U4 pBase</div><div class="ttdoc">pBase of this Firmware </div><div class="ttdef"><b>Definition:</b> <a href="image_8h_source.html#l00045">image.h:45</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa70ef325cfc92074a0741a423221d6e49"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa70ef325cfc92074a0741a423221d6e49">UBX_UPD_AUTHWRITE</a></div><div class="ttdoc">Write with signature (NDA 18+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00134">ubxmsg.h:134</a></div></div>
<div class="ttc" id="union_f_w_h_e_a_d_e_r__u_html_aed0a16879262f9becb9bfc8e4dd39f25"><div class="ttname"><a href="union_f_w_h_e_a_d_e_r__u.html#aed0a16879262f9becb9bfc8e4dd39f25">FWHEADER_u::v1</a></div><div class="ttdeci">struct FWHEADER_u::@0 v1</div><div class="ttdoc">version 1 firmware header type </div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa2eae0cce6a4993381c6c7c0278bad160"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa2eae0cce6a4993381c6c7c0278bad160">UBX_UPD_DOWNL</a></div><div class="ttdoc">Memory write (NDA 10-17) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00122">ubxmsg.h:122</a></div></div>
<div class="ttc" id="types_8h_html_a2d18590ee6cb00e8ea0a631cf9696f53"><div class="ttname"><a href="types_8h.html#a2d18590ee6cb00e8ea0a631cf9696f53">CH</a></div><div class="ttdeci">char CH</div><div class="ttdoc">8-bit character, (signed/unsigned, depending on compiler) </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00064">types.h:64</a></div></div>
<div class="ttc" id="mergefis_8c_html_ac4eee236d80de78bb5efab5a1970ba31"><div class="ttname"><a href="mergefis_8c.html#ac4eee236d80de78bb5efab5a1970ba31">mergefis_merge</a></div><div class="ttdeci">MERGEFIS_RETVAL_t mergefis_merge(char *pData, unsigned int ImageSize, char const *fis)</div><div class="ttdoc">Merge the flash image with the corresponding FIS data. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8c_source.html#l01486">mergefis.c:1486</a></div></div>
<div class="ttc" id="struct_f_w_f_o_o_t_e_r_i_n_f_o__u_html"><div class="ttname"><a href="struct_f_w_f_o_o_t_e_r_i_n_f_o__u.html">FWFOOTERINFO_u</a></div><div class="ttdoc">structure holding data extracted from image footer </div><div class="ttdef"><b>Definition:</b> <a href="image_8h_source.html#l00056">image.h:56</a></div></div>
<div class="ttc" id="update_core_8h_html_a3af75bd8417b347229705d6d522ad5c3"><div class="ttname"><a href="update_core_8h.html#a3af75bd8417b347229705d6d522ad5c3">WRITE_TIMEOUT</a></div><div class="ttdeci">#define WRITE_TIMEOUT</div><div class="ttdoc">timeout for writing a block </div><div class="ttdef"><b>Definition:</b> <a href="update_core_8h_source.html#l00042">updateCore.h:42</a></div></div>
<div class="ttc" id="receiver_8h_html_a436daa50a3a663d6109f98c4efd45d58"><div class="ttname"><a href="receiver_8h.html#a436daa50a3a663d6109f98c4efd45d58">RETRY_COUNT</a></div><div class="ttdeci">#define RETRY_COUNT</div><div class="ttdoc">Number of retries for status messages (except for erase/write) </div><div class="ttdef"><b>Definition:</b> <a href="receiver_8h_source.html#l00050">receiver.h:50</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa3d273b4f40703d9523f6b7cd469d1d7c"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa3d273b4f40703d9523f6b7cd469d1d7c">UBX_UPD_IDEN</a></div><div class="ttdoc">Identify (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00126">ubxmsg.h:126</a></div></div>
<div class="ttc" id="update_8c_html_af1d2a705ba4ac692befd90b25f146925"><div class="ttname"><a href="update_8c.html#af1d2a705ba4ac692befd90b25f146925">getNoFisMergingData</a></div><div class="ttdeci">static MERGEFIS_RETVAL_t getNoFisMergingData(char **fis, size_t *fisSize, RCV_DATA_t *rx)</div><div class="ttdef"><b>Definition:</b> <a href="update_8c_source.html#l00060">update.c:60</a></div></div>
<div class="ttc" id="struct_b_l_o_c_k___a_r_r__s_html"><div class="ttname"><a href="struct_b_l_o_c_k___a_r_r__s.html">BLOCK_ARR_s</a></div><div class="ttdoc">Array of block definitions. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8h_source.html#l00049">flash.h:49</a></div></div>
<div class="ttc" id="mergefis_8h_html_aa8023e3cde651c33bf1420b26c3090d5"><div class="ttname"><a href="mergefis_8h.html#aa8023e3cde651c33bf1420b26c3090d5">REVISION_POSITION_VER3</a></div><div class="ttdeci">#define REVISION_POSITION_VER3</div><div class="ttdoc">Position of the Git revision in Version 3 of FIS. </div><div class="ttdef"><b>Definition:</b> <a href="mergefis_8h_source.html#l00062">mergefis.h:62</a></div></div>
<div class="ttc" id="types_8h_html_ac2bbd6d630a06a980d9a92ddb9a49928"><div class="ttname"><a href="types_8h.html#ac2bbd6d630a06a980d9a92ddb9a49928">IN</a></div><div class="ttdeci">#define IN</div><div class="ttdoc">dummy define for input argument </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00108">types.h:108</a></div></div>
<div class="ttc" id="struct_u_b_x___h_e_a_d__s_html_aa89eeea608ab09a8ba70d5b92e641f30"><div class="ttname"><a href="struct_u_b_x___h_e_a_d__s.html#aa89eeea608ab09a8ba70d5b92e641f30">UBX_HEAD_s::size</a></div><div class="ttdeci">U2 size</div><div class="ttdoc">Payload Size. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00059">ubxmsg.h:59</a></div></div>
<div class="ttc" id="flash_8h_html"><div class="ttname"><a href="flash_8h.html">flash.h</a></div><div class="ttdoc">Flash organization stuff. </div></div>
<div class="ttc" id="platform_8h_html_a10cd4539bac4c67d55db0fa42b4a2333a8a58ddd9346f76e629a18f2a2053fd72"><div class="ttname"><a href="platform_8h.html#a10cd4539bac4c67d55db0fa42b4a2333a8a58ddd9346f76e629a18f2a2053fd72">MSG_LEV0</a></div><div class="ttdoc">Verbosity Level 0 message. </div><div class="ttdef"><b>Definition:</b> <a href="platform_8h_source.html#l00223">platform.h:223</a></div></div>
<div class="ttc" id="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s_html_a11c328214d9c7d0640cfe8500144fb08"><div class="ttname"><a href="struct_a_p_p___u_b_x___u_p_d___i_m_g___p_a_y_l_o_a_d__s.html#a11c328214d9c7d0640cfe8500144fb08">APP_UBX_UPD_IMG_PAYLOAD_s::chunkNum</a></div><div class="ttdeci">U2 chunkNum</div><div class="ttdoc">512 byte chunk number </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00088">ubxmsg.h:88</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaaa375c3a5e3d34cc92292d9eff56f46bc"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaa375c3a5e3d34cc92292d9eff56f46bc">UBX_UPD_SAFE</a></div><div class="ttdoc">Execute safeboot (NDA 10+) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00129">ubxmsg.h:129</a></div></div>
<div class="ttc" id="types_8h_html_acef4706edf5cb8820227a47eb22c371b"><div class="ttname"><a href="types_8h.html#acef4706edf5cb8820227a47eb22c371b">U8</a></div><div class="ttdeci">unsigned __int64 U8</div><div class="ttdoc">64-bit unsigned integer number </div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00052">types.h:52</a></div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaaf9e7a29b314222fac7e7646b96acd577"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaaf9e7a29b314222fac7e7646b96acd577">UBX_UPD_FIS</a></div><div class="ttdoc">Update FIS (NDA 23) </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00132">ubxmsg.h:132</a></div></div>
<div class="ttc" id="receiver_8c_html_ad3955f74acc89430ae3a7fd9511a128c"><div class="ttname"><a href="receiver_8c.html#ad3955f74acc89430ae3a7fd9511a128c">rcvSendTrainingSequence</a></div><div class="ttdeci">BOOL rcvSendTrainingSequence(RCV_DATA_t *rcv)</div><div class="ttdef"><b>Definition:</b> <a href="receiver_8c_source.html#l00130">receiver.c:130</a></div></div>
<div class="ttc" id="flash_8c_html_a7bf128ab2f67a130452c054a44662922"><div class="ttname"><a href="flash_8c.html#a7bf128ab2f67a130452c054a44662922">DumpFlashInfo</a></div><div class="ttdeci">void DumpFlashInfo(BLOCK_ARR_t const *const pkFlashOrg, const U4 FlashSize)</div><div class="ttdoc">Dump Flash organization info. </div><div class="ttdef"><b>Definition:</b> <a href="flash_8c_source.html#l00319">flash.c:319</a></div></div>
<div class="ttc" id="update_8h_html"><div class="ttname"><a href="update_8h.html">update.h</a></div><div class="ttdoc">Firmware update process for u-blox 5/6. </div></div>
<div class="ttc" id="ubxmsg_8h_html_a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb"><div class="ttname"><a href="ubxmsg_8h.html#a0129b7951dfb86416b5acb8896643bfaa9cf9c4388e55cd4d9bce04c83dac54bb">UBX_CLASS_CFG</a></div><div class="ttdoc">Class configuration. </div><div class="ttdef"><b>Definition:</b> <a href="ubxmsg_8h_source.html#l00106">ubxmsg.h:106</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="update_8c.html">update.c</a></li>
    <li class="footer">Generated on Sun May 23 2021 19:02:48 for ubxfwupdate by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
